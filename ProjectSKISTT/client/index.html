<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Schedule</title>
  <!-- Material UI Fonts and Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>
<body>
  <div id="root"></div>

  <!-- React, Babel, and Material-UI via CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@mui/material@5/umd/material-ui.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    const {
      colors,
      createTheme,
      ThemeProvider,
      CssBaseline,
      AppBar,
      Toolbar,
      Typography,
      Container,
      Box,
      IconButton,
      Icon,
      Modal,
      Button,
      TextField,
      Select,
      MenuItem,
      InputLabel,
      FormControl,
      Grid,
      FormControlLabel,
      Checkbox,
      CircularProgress,
      Card,
      CardContent,
      Alert,
      Menu
    } = MaterialUI;

    const theme = createTheme({
      palette: {
        primary: {
          main: '#1976d2',
        },
        secondary: {
          main: '#dc004e',
        },
      },
    });

    const API_URL = '/api';

    // ===================================================================================
    // LOGIN COMPONENT
    // ===================================================================================
    function Login({ error }) {
      const handleLogin = async () => {
        try {
          const response = await fetch(`${API_URL}/auth/google/url`);
          const data = await response.json();
          if (data.url) {
            window.location.href = data.url;
          }
        } catch (err) {
          console.error("Failed to get Google auth URL", err);
        }
      };

      return (
        <ThemeProvider theme={theme}>
          <Container component="main" maxWidth="xs" sx={{ display: 'flex', alignItems: 'center', height: '100vh' }}>
            <Card sx={{ p: 2, width: '100%' }}>
              <CardContent>
                <Box sx={{ textAlign: 'center', mb: 2 }}>
                  <img src="v3-2.png" alt="Logo" style={{ height: '50px' }} />
                  <Typography component="h1" variant="h5" sx={{ mt: 1 }}>
                    SKIS Schedule Login
                  </Typography>
                </Box>
                {error && <Alert severity="error" sx={{ mb: 2 }}>{decodeURIComponent(error)}</Alert>}
                <Button
                  fullWidth
                  variant="contained"
                  onClick={handleLogin}
                  sx={{ mt: 2, mb: 2, display: 'flex', alignItems: 'center' }}
                >
                  <Icon sx={{ mr: 1 }}>login</Icon> 
                  Sign In with Google
                </Button>
              </CardContent>
            </Card>
          </Container>
        </ThemeProvider>
      );
    }

    // ===================================================================================
    // MAIN APP COMPONENT
    // ===================================================================================
    function App({ user, onLogout }) {
      // STATE
      const [currentDay, setCurrentDay] = React.useState(() => {
        const savedDateString = localStorage.getItem('lastViewedDate');
        if (savedDateString) {
          const savedDate = new Date(savedDateString);
          if (!isNaN(savedDate.getTime())) {
            return savedDate; // It's a valid date
          }
        }
        return new Date(); // Fallback to today
      });
      const [initialDay, setInitialDay] = React.useState(new Date());
      const [data, setData] = React.useState({ schedules: [], teachers: [], subjects: [], rooms: [], grades: [7, 8, 9, 10, 11, 12] });
      const [isModalOpen, setModalOpen] = React.useState(false);
      const [editingEvent, setEditingEvent] = React.useState(null);
      const [newEvent, setNewEvent] = React.useState({
        grade: '', timeSlotId: '', subjectId: '', teacherId: '', roomId: '',
        color: '#ffffff', customSubject: '', customTeacher: '', customRoom: ''
      });
      const [isExportModalOpen, setExportModalOpen] = React.useState(false);
      const [exportWeek, setExportWeek] = React.useState('');
      const [exportDays, setExportDays] = React.useState({ Monday: false, Tuesday: false, Wednesday: false, Thursday: false, Friday: false });
      const [isExporting, setIsExporting] = React.useState(false);
      const [startWeek, setStartWeek] = React.useState('');
      const [endWeek, setEndWeek] = React.useState('');
            const [isPickingDate, setIsPickingDate] = React.useState(false);
            const [isLoadingData, setIsLoadingData] = React.useState(true);
                  const [isCopyModalOpen, setIsCopyModalOpen] = React.useState(false);
                  const [copyTargetDate, setCopyTargetDate] = React.useState(null);
                                    const [isCopyWeekModalOpen, setIsCopyWeekModalOpen] = React.useState(false);
                                    const [copyWeekTargetDate, setCopyWeekTargetDate] = React.useState(null);
                                                      const [isSubjectModalOpen, setIsSubjectModalOpen] = React.useState(false);
                                                      const [editingSubjects, setEditingSubjects] = React.useState([]);
                                                      const [newSubjectName, setNewSubjectName] = React.useState('');
                                                      const [newSubjectColor, setNewSubjectColor] = React.useState('#1976d2'); // Default color
                                                      const [isUsageModalOpen, setIsUsageModalOpen] = React.useState(false);
                                                      const [usageData, setUsageData] = React.useState({ subjectName: '', dates: [] });
                                                      
                                                      const [isTeacherModalOpen, setIsTeacherModalOpen] = React.useState(false);
                                                      const [editingTeachers, setEditingTeachers] = React.useState([]);
                                                      const [newTeacherName, setNewTeacherName] = React.useState('');
                                                      const [newTeacherEmail, setNewTeacherEmail] = React.useState('');
                                                      const [isTeacherUsageModalOpen, setIsTeacherUsageModalOpen] = React.useState(false);
                                                      const [teacherUsageData, setTeacherUsageData] = React.useState({ teacherName: '', dates: [] });

                                                      const [isRoomModalOpen, setIsRoomModalOpen] = React.useState(false);
                                                      const [editingRooms, setEditingRooms] = React.useState([]);
                                                      const [newRoomName, setNewRoomName] = React.useState('');
                                                      const [isRoomUsageModalOpen, setIsRoomUsageModalOpen] = React.useState(false);
                                                      const [roomUsageData, setRoomUsageData] = React.useState({ roomName: '', dates: [] });
                                                      const [exportSelection, setExportSelection] = React.useState('general');

                                                      const [isLessonCounterModalOpen, setIsLessonCounterModalOpen] = React.useState(false);
                                                      const [counterStartDate, setCounterStartDate] = React.useState('');
                                                      const [counterEndDate, setCounterEndDate] = React.useState('');
                                                      const [counterSelectedTeacher, setCounterSelectedTeacher] = React.useState('');
                                                      const [counterSelectedSubject, setCounterSelectedSubject] = React.useState('');
                                                      const [lessonCount, setLessonCount] = React.useState(0);

                                                      const [isSendMailModalOpen, setIsSendMailModalOpen] = React.useState(false);
                                                      const [emailBody, setEmailBody] = React.useState('');
                                                      const [emailRecipients, setEmailRecipients] = React.useState({});

                                                      const [selectedTeacher, setSelectedTeacher] = React.useState('');
                                                      const [selectedGrade, setSelectedGrade] = React.useState('');
                                                      const [anchorEl, setAnchorEl] = React.useState(null);
                                                      const isMenuOpen = Boolean(anchorEl);

                                                      const handleMenuOpen = (event) => {
                                                        setAnchorEl(event.currentTarget);
                                                      };

                                                      const handleMenuClose = () => {
                                                        setAnchorEl(null);
                                                      };

                                                      const handleOpenSendMailModal = () => {
                                                        fetch(`${API_URL}/email_text`)
                                                          .then(res => res.json())
                                                          .then(data => setEmailBody(data.text || ''))
                                                          .catch(err => console.error("Failed to fetch email text", err));
                                                        
                                                        const initialRecipients = teachers.reduce((acc, teacher) => {
teacher._id
                                                          return acc;
                                                        }, { ALL_TEACHERS: false });

                                                        grades.forEach(grade => {
                                                          initialRecipients[`grade-${grade}`] = false;
                                                        });

                                                        setEmailRecipients(initialRecipients);

                                                        setIsSendMailModalOpen(true);
                                                        handleMenuClose();
                                                      };

                                                      const dateInputRef = React.useRef(null);
                                                      const draggedItem = React.useRef(null);
                                                      const isEditor = user.role === 'editor';
                                                
                                                      // Calculate week boundaries for viewer role
                                                      const today = new Date();
                                                      const dayOfWeek = today.getDay();
                                                      const monday = new Date(today);
                                                      monday.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
                                                      monday.setHours(0, 0, 0, 0);
                                                
                                                      const friday = new Date(monday);
                                                      friday.setDate(monday.getDate() + 4);
                                                      friday.setHours(23, 59, 59, 999);
                                                
                                                      // DATA FETCHING
                                                      const fetchData = () => {
                                                        setIsLoadingData(true);
                                                        fetch(`${API_URL}/data`)
                                                          .then(res => res.json())
                                                          .then(d => {
                                                            // Sort subjects, teachers, and rooms by order to ensure consistent ordering
                                                            d.subjects.sort((a, b) => a.order - b.order);
                                                            d.teachers.sort((a, b) => a.order - b.order);
                                                            d.rooms.sort((a, b) => a.order - b.order);
                                                            setData(d);
                                                            setIsLoadingData(false);
                                                          })
                                                          .catch(err => {
                                                            console.error("Failed to fetch data", err);
                                                            setIsLoadingData(false);
                                                          });
                                                      };
                                                      React.useEffect(fetchData, []);
                                                
                                                      // EFFECTS
                                                      React.useEffect(() => {
                                                        if (isPickingDate) { dateInputRef.current?.focus(); }
                                                      }, [isPickingDate]);
                                                
                                                      React.useEffect(() => {
                                                        if (currentDay && !isNaN(currentDay)) { localStorage.setItem('lastViewedDate', currentDay.toISOString()); }
                                                      }, [currentDay]);
                                                      
                                                      React.useEffect(() => {
                                                        if (!isEditor) {
                                                          const realToday = new Date();
                                                          // If current day is outside the current real week, reset to today
                                                          if (currentDay < monday || currentDay > friday) {
                                                             setCurrentDay(realToday);
                                                          }
                                                        }
                                                      }, [isEditor]); // Run only when role changes

                                                      React.useEffect(() => {
                                                        if (!counterStartDate || !counterEndDate || !counterSelectedTeacher) {
                                                          setLessonCount(0);
                                                          return;
                                                        }

                                                        const start = new Date(counterStartDate);
                                                        const end = new Date(counterEndDate);

                                                        const filteredSchedules = schedules.filter(event => {
                                                          const eventDate = new Date(event.day);
                                                          const isDateInRange = eventDate >= start && eventDate <= end;
                                                          const isTeacherMatch = event.teacherId === counterSelectedTeacher;
                                                          const isSubjectMatch = !counterSelectedSubject || event.subjectId === counterSelectedSubject;
                                                          
                                                          return isDateInRange && isTeacherMatch && isSubjectMatch;
                                                        });

                                                        const uniqueLessons = new Set();
                                                        filteredSchedules.forEach(event => {
                                                          if (event.timeSlotId) { // Only count events with a valid time slot
                                                            const lessonKey = `${event.day}-${event.timeSlotId}`;
                                                            uniqueLessons.add(lessonKey);
                                                          }
                                                        });

                                                        setLessonCount(uniqueLessons.size);

                                                      }, [counterStartDate, counterEndDate, counterSelectedTeacher, counterSelectedSubject, schedules]);
                                                
                                                      // DATA CONSTANTS
                                                      const { schedules, teachers, subjects, rooms, grades } = data;
                                                      const timeSlots = [
                                                        { id: 1, time: '8:00 - 8:50' }, { id: 2, time: '9:00 - 9:50' }, { id: 3, time: '10:00 - 10:50' },
                                                        { id: 'snack', time: 'Snack' }, { id: 4, time: '11:00 - 11:50' }, { id: 5, time: '12:00 - 12:50' },
                                                        { id: 'lunch', time: '13:00 - 13:50' }, { id: 6, time: '14:00 - 14:50' }, { id: 7, time: '15:00 - 15:50' },
                                                        { id: 8, time: '16:00-16:50' }, { id: 9, time: '17:00-17:50' }, { id: 10, time: '17:50-19:00' },
                                                      ];
                                                      const darkGrayCellStyle = { border: '2px solid #000000', padding: '8px', textAlign: 'left', verticalAlign: 'top', backgroundColor: '#e0e0e0' };
                                                
                                                      // HELPER FUNCTIONS
                                                      const getWeekNumber = (d) => {
                                                        const schoolYearStartDate = new Date('2025-08-25T00:00:00Z');
                                                        let currentDayUTC = new Date(d.toISOString().split('T')[0] + 'T00:00:00Z');
                                                        if (currentDayUTC < schoolYearStartDate) return 1;
                                                        const holidays = [
                                                            { start: new Date('2025-10-18T00:00:00Z'), end: new Date('2025-11-02T23:59:59Z') }, { start: new Date('2025-12-20T00:00:00Z'), end: new Date('2026-01-07T23:59:59Z') },
                                                            { start: new Date('2026-01-31T00:00:00Z'), end: new Date('2026-02-08T23:59:59Z') }, { start: new Date('2026-03-28T00:00:00Z'), end: new Date('2026-04-12T23:59:59Z') },
                                                            { start: new Date('2026-06-20T00:00:00Z'), end: new Date('2026-08-23T23:59:59Z') },
                                                        ];
                                                        for (const period of holidays) { if (currentDayUTC >= period.start && currentDayUTC <= period.end) { return 'Holidays'; } }
                                                        let schoolDaysCount = 0;
                                                        let iterDate = new Date(schoolYearStartDate);
                                                        while(iterDate <= currentDayUTC) {
                                                            const dayOfWeek = iterDate.getUTCDay();
                                                            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                                                            let isHoliday = false;
                                                            if (!isWeekend) { for (const period of holidays) { if (iterDate >= period.start && iterDate <= period.end) { isHoliday = true; break; } } }
                                                            if (!isWeekend && !isHoliday) { schoolDaysCount++; }
                                                            iterDate.setUTCDate(iterDate.getUTCDate() + 1);
                                                        }
                                                        if (schoolDaysCount <= 0) return 1;
                                                        return Math.ceil(schoolDaysCount / 5);
                                                      };
                                                      const formatDate = (date) => {
                                                        const day = String(date.getDate()).padStart(2, '0');
                                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                                        const year = date.getFullYear();
                                                        return `${day}.${month}.${year}`;
                                                      };
                                                      const getEventsForCell = (grade, timeSlotId) => {
                                                          const dayString = currentDay.toISOString().split('T')[0];
                                                          let events = schedules.filter(event => event.day === dayString && event.grade === grade && event.timeSlotId === timeSlotId);
                                                          if (selectedTeacher) {
                                                            events = events.filter(event => event.teacherId === selectedTeacher);
                                                          }
                                                          if (selectedGrade) {
                                                            events = events.filter(event => event.grade === selectedGrade);
                                                          }
                                                          return events;
                                                      };
                                                      const dayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'long' });
                                                
                                                      // DRAG & DROP HANDLERS
                                                      const handleDragStart = (e, index) => {
                                                          draggedItem.current = index;
                                                          e.dataTransfer.effectAllowed = 'move';
                                                      };

                                                      const handleDragOver = (e) => {
                                                          e.preventDefault();
                                                      };

                                                      const handleDrop = (e, index, listType) => {
                                                          e.preventDefault();
                                                          const draggedIndex = draggedItem.current;
                                                          if (draggedIndex === null || draggedIndex === index) {
                                                              return;
                                                          }

                                                          let items;
                                                          let setItems;

                                                          if (listType === 'subjects') {
                                                              items = [...editingSubjects];
                                                              setItems = setEditingSubjects;
                                                          } else if (listType === 'teachers') {
                                                              items = [...editingTeachers];
                                                              setItems = setEditingTeachers;
                                                          } else if (listType === 'rooms') {
                                                              items = [...editingRooms];
                                                              setItems = setEditingRooms;
                                                          } else {
                                                              return; // Unknown list type
                                                          }

                                                          const [reorderedItem] = items.splice(draggedIndex, 1);
                                                          items.splice(index, 0, reorderedItem);
                                                          setItems(items);
                                                          draggedItem.current = null;
                                                      };
                                          
                                                      // MODAL & EVENT HANDLERS
                                                      const handleOpenModal = (event = null) => {
                                                        if (!isEditor) return;
                                                        if (event) { setEditingEvent(event); setNewEvent(event); } 
                                                        else { setEditingEvent(null); setNewEvent({ grade: '', timeSlotId: '', subjectId: '', teacherId: '', roomId: '', color: '#ffffff', customSubject: '', customTeacher: '', customRoom: '' }); }
                                                        setModalOpen(true);
                                                      };

                                                      const handleCloseModal = () => { setEditingEvent(null); setModalOpen(false); };

                                                      const handleFormChange = (e) => { 
                                                        const { name, value } = e.target; 
                                                        const updatedEvent = { ...newEvent, [name]: value }; 
                                                        if (name === 'subjectId') { 
                                                          const selectedSubject = subjects.find(s => s.id === value); 
                                                          if (selectedSubject) { updatedEvent.color = selectedSubject.color; } 
                                                        } 
                                                        setNewEvent(updatedEvent); 
                                                      };

                                                      const handleSubmit = () => { if (editingEvent) { handleUpdate(); } else { handleCreate(); } };

                                                      const handleCreate = () => {
                                                        const payload = { ...newEvent, day: currentDay.toISOString().split('T')[0] };
                                                        const conflictingEvent = schedules.find(event => event.day === payload.day && event.timeSlotId === payload.timeSlotId && event.roomId === payload.roomId);
                                                        if (conflictingEvent) {
                                                            const existingSubjectName = conflictingEvent.customSubject || subjects.find(s => s.id === conflictingEvent.subjectId)?.name;
                                                            const newSubjectName = payload.customSubject || subjects.find(s => s.id === payload.subjectId)?.name;
                                                
                                                            if (existingSubjectName !== newSubjectName) {
                                                                alert('This room is already booked for this time slot with a different subject.');
                                                                return;
                                                            }
                                                        }

                                                        // Teacher conflict validation
                                                        if (payload.teacherId) {
                                                            const teacherConflictEvent = schedules.find(event => 
                                                                event.day === payload.day && 
                                                                event.timeSlotId === payload.timeSlotId && 
                                                                event.teacherId === payload.teacherId
                                                            );
                                                            if (teacherConflictEvent) {
                                                                const existingSubjectName = teacherConflictEvent.customSubject || subjects.find(s => s.id === teacherConflictEvent.subjectId)?.name;
                                                                const newSubjectName = payload.customSubject || subjects.find(s => s.id === payload.subjectId)?.name;
                                                                if (existingSubjectName !== newSubjectName) {
                                                                    alert('This teacher is already assigned to a different subject at this time.');
                                                                    return;
                                                                }
                                                            }
                                                        }
                                                        if (payload.customSubject) { payload.subjectId = null; }
                                                        if (payload.customTeacher) { payload.teacherId = null; }
                                                        if (payload.customRoom) { payload.roomId = null; }
                                                        if (payload.color === '#ffffff' && payload.subjectId) { const selectedSubject = subjects.find(s => s.id === payload.subjectId); if (selectedSubject) { payload.color = selectedSubject.color; } }
                                                        fetch(`${API_URL}/events`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                                                        .then(res => res.json()).then(() => { fetchData(); handleCloseModal(); }).catch(err => console.error("Failed to save event", err));
                                                      };

                                                      const handleUpdate = () => {
                                                        const payload = { ...newEvent };
                                                        const conflictingEvent = schedules.find(event => event.day === payload.day && event.timeSlotId === payload.timeSlotId && event.roomId === payload.roomId && event.id !== editingEvent.id);
                                                        if (conflictingEvent) {
                                                            const existingSubjectName = conflictingEvent.customSubject || subjects.find(s => s.id === conflictingEvent.subjectId)?.name;
                                                            const newSubjectName = payload.customSubject || subjects.find(s => s.id === payload.subjectId)?.name;
                                                
                                                            if (existingSubjectName !== newSubjectName) {
                                                                alert('This room is already booked for this time slot with a different subject.');
                                                                return;
                                                            }
                                                        }

                                                        // Teacher conflict validation
                                                        if (payload.teacherId) {
                                                            const teacherConflictEvent = schedules.find(event => 
                                                                event.day === payload.day && 
                                                                event.timeSlotId === payload.timeSlotId && 
                                                                event.teacherId === payload.teacherId &&
                                                                event.id !== editingEvent.id
                                                            );
                                                            if (teacherConflictEvent) {
                                                                const existingSubjectName = teacherConflictEvent.customSubject || subjects.find(s => s.id === teacherConflictEvent.subjectId)?.name;
                                                                const newSubjectName = payload.customSubject || subjects.find(s => s.id === payload.subjectId)?.name;
                                                                if (existingSubjectName !== newSubjectName) {
                                                                    alert('This teacher is already assigned to a different subject at this time.');
                                                                    return;
                                                                }
                                                            }
                                                        }
                                                        
                                                        if (payload.customSubject) { payload.subjectId = null; }
                                                        if (payload.customTeacher) { payload.teacherId = null; }
                                                        if (payload.customRoom) { payload.roomId = null; }
                                                        fetch(`${API_URL}/events/${editingEvent._id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                                                        .then(res => res.json()).then(() => { fetchData(); handleCloseModal(); }).catch(err => console.error("Failed to update event", err));
                                                      };

                                                      const handleDelete = () => {
                                                        if (editingEvent) {
                                                          fetch(`${API_URL}/events/${editingEvent._id}`, { method: 'DELETE' })
                                                          .then(() => { fetchData(); handleCloseModal(); }).catch(err => console.error("Failed to delete event", err));
                                                        }
                                                      };

                                                      const handlePrevDay = () => { const newDay = new Date(currentDay); newDay.setDate(newDay.getDate() - 1); setCurrentDay(newDay); };
                                                      const handleNextDay = () => { const newDay = new Date(currentDay); newDay.setDate(newDay.getDate() + 1); setCurrentDay(newDay); };
                                                      const handlePrevWeek = () => { const newDay = new Date(currentDay); newDay.setDate(newDay.getDate() - 7); setCurrentDay(newDay); };
                                                      const handleNextWeek = () => { const newDay = new Date(currentDay); newDay.setDate(newDay.getDate() + 7); setCurrentDay(newDay); };
                                                      const getAllWeeks = () => { return Array.from({ length: 40 }, (_, i) => i + 1); };
                                                      const handleWeekChange = (e) => { const weekNumber = e.target.value; const schoolYearStartDate = new Date('2025-08-25T00:00:00Z'); const newDate = new Date(schoolYearStartDate.setDate(schoolYearStartDate.getDate() + (weekNumber - 1) * 7)); setCurrentDay(newDate); setInitialDay(newDate); };
                                                      
                                                      // EXPORT HANDLERS
                                                      const handleOpenExportModal = () => { 
                                                        const currentWeek = getWeekNumber(currentDay); 
                                                        setExportWeek(currentWeek === 'Holidays' ? 1 : currentWeek); 
                                                        setExportSelection(selectedTeacher || 'general');
                                                        setExportModalOpen(true); 
                                                      };
                                                      const handleCloseExportModal = () => { setExportModalOpen(false); setExportWeek(''); setExportDays({ Monday: false, Tuesday: false, Wednesday: false, Thursday: false, Friday: false }); };
                                                      const handleExportWeekChange = (e) => { setExportWeek(e.target.value); };
                                                      const handleExportDayChange = (e) => { setExportDays({ ...exportDays, [e.target.name]: e.target.checked }); };
                                                      const handleToggleAllExportDays = () => {
                                                        const areAllSelected = Object.values(exportDays).every(day => day === true);
                                                        if (areAllSelected) {
                                                          setExportDays({ Monday: false, Tuesday: false, Wednesday: false, Thursday: false, Friday: false });
                                                        } else {
                                                          setExportDays({ Monday: true, Tuesday: true, Wednesday: true, Thursday: true, Friday: true });
                                                        }
                                                      };
                                                      const handleExport = async () => {
                                                        const { jsPDF } = window.jspdf;
                                                        const pdf = new jsPDF('landscape', 'pt', 'a4');
                                                        
                                                        setIsExporting(true);

                                                        if (selectedTeacher) {
                                                            const tableNode = document.querySelector('#teacher-schedule-table');
                                                            const style = document.createElement('style');
                                                            style.innerHTML = `.export-style th, .export-style td { border: 1px solid #000 !important; }`;
                                                            document.head.appendChild(style);
                                                            tableNode.classList.add('export-style');

                                                            const teacherName = teachers.find(t => t.id === selectedTeacher)?.name.replace(/\s/g, '_') || 'teacher';
                                                            const fileName = `schedule-T_${teacherName}-W_${getWeekNumber(currentDay)}.pdf`;
                                                            
                                                            const canvas = await html2canvas(tableNode);
                                                            const imgData = canvas.toDataURL('image/png');
                                                            const pdfWidth = pdf.internal.pageSize.getWidth();
                                                            const canvasWidth = canvas.width;
                                                            const canvasHeight = canvas.height;
                                                            const ratio = canvasWidth / canvasHeight;
                                                            const imgWidth = pdfWidth - 80;
                                                            const imgHeight = imgWidth / ratio;

                                                            const dateText = `Schedule for ${teachers.find(t => t.id === selectedTeacher)?.name} - Week ${getWeekNumber(currentDay)}`;
                                                            pdf.setFontSize(12);
                                                            pdf.text(dateText, 40, 30);
                                                            pdf.addImage(imgData, 'PNG', 40, 40, imgWidth, imgHeight);
                                                            pdf.save(fileName);

                                                            tableNode.classList.remove('export-style');
                                                            document.head.removeChild(style);
                                                        } else if (selectedGrade) {
                                                            const tableNode = document.querySelector('#grade-schedule-table');
                                                            const style = document.createElement('style');
                                                            style.innerHTML = `.export-style th, .export-style td { border: 1px solid #000 !important; }`;
                                                            document.head.appendChild(style);
                                                            tableNode.classList.add('export-style');

                                                            const fileName = `schedule-G_${selectedGrade}-W_${getWeekNumber(currentDay)}.pdf`;
                                                            
                                                            const canvas = await html2canvas(tableNode);
                                                            const imgData = canvas.toDataURL('image/png');
                                                            const pdfWidth = pdf.internal.pageSize.getWidth();
                                                            const canvasWidth = canvas.width;
                                                            const canvasHeight = canvas.height;
                                                            const ratio = canvasWidth / canvasHeight;
                                                            const imgWidth = pdfWidth - 80;
                                                            const imgHeight = imgWidth / ratio;

                                                            const dateText = `Schedule for Grade ${selectedGrade} - Week ${getWeekNumber(currentDay)}`;
                                                            pdf.setFontSize(12);
                                                            pdf.text(dateText, 40, 30);
                                                            pdf.addImage(imgData, 'PNG', 40, 40, imgWidth, imgHeight);
                                                            pdf.save(fileName);

                                                            tableNode.classList.remove('export-style');
                                                            document.head.removeChild(style);
                                                        } else {
                                                            const tableNode = document.querySelector('#schedule-table');
                                                            const style = document.createElement('style');
                                                            style.innerHTML = `.export-style th, .export-style td { border: 1px solid #000 !important; }`;
                                                            document.head.appendChild(style);
                                                            tableNode.classList.add('export-style');
                                                    
                                                            let pageCount = 0;
                                                    
                                                            if (startWeek && endWeek) { // Range export logic
                                                                const parsedStartWeek = parseInt(startWeek);
                                                                const parsedEndWeek = parseInt(endWeek);
                                                    
                                                                if (isNaN(parsedStartWeek) || isNaN(parsedEndWeek) || parsedStartWeek <= 0 || parsedEndWeek <= 0 || parsedStartWeek > parsedEndWeek) {
                                                                    alert('Please enter a valid week range (e.g., 1 to 20).');
                                                                    setIsExporting(false);
                                                                    tableNode.classList.remove('export-style');
                                                                    document.head.removeChild(style);
                                                                    return;
                                                                }
                                                    
                                                                const schoolYearStartDate = new Date('2025-08-25T00:00:00Z');
                                                                const schoolYearEndDate = new Date('2026-06-20T00:00:00Z');
                                                                let currentDateIter = new Date(schoolYearStartDate);
                                                    
                                                                while (currentDateIter <= schoolYearEndDate) {
                                                                    const weekOfCurrentDate = getWeekNumber(currentDateIter);
                                                                    if (weekOfCurrentDate >= parsedStartWeek && weekOfCurrentDate <= parsedEndWeek) {
                                                                        const dayOfWeek = currentDateIter.getDay();
                                                                        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Is a weekday
                                                                            setCurrentDay(new Date(currentDateIter));
                                                                            await new Promise(resolve => setTimeout(resolve, 1500));
                                                    
                                                                            const canvas = await html2canvas(tableNode);
                                                                            const imgData = canvas.toDataURL('image/png');
                                                                            const pdfWidth = pdf.internal.pageSize.getWidth();
                                                                            const canvasWidth = canvas.width;
                                                                            const canvasHeight = canvas.height;
                                                                            const ratio = canvasWidth / canvasHeight;
                                                                            const imgWidth = pdfWidth - 80;
                                                                            const imgHeight = imgWidth / ratio;
                                                    
                                                                            if (pageCount > 0) { pdf.addPage(); }
                                                                            pageCount++;
                                                                            
                                                                            const dateText = `${dayFormatter.format(currentDateIter)} - ${formatDate(currentDateIter)}`;
                                                                            pdf.setFontSize(12);
                                                                            pdf.text(dateText, 40, 30);
                                                                            pdf.addImage(imgData, 'PNG', 40, 40, imgWidth, imgHeight);
                                                                        }
                                                                    }
                                                                    currentDateIter.setDate(currentDateIter.getDate() + 1);
                                                                }
                                                                pdf.save(`schedule-weeks-${parsedStartWeek}-${parsedEndWeek}.pdf`);
                                                    
                                                            } else { // 'days' mode (existing logic)
                                                                const selectedDays = Object.entries(exportDays).filter(([, isSelected]) => isSelected).map(([day]) => day);
                                                                if (selectedDays.length === 0) {
                                                                    alert('Please select at least one day to export.');
                                                                    setIsExporting(false);
                                                                    tableNode.classList.remove('export-style');
                                                                    document.head.removeChild(style);
                                                                    return;
                                                                }
                                                                
                                                                const sourceDay = new Date(currentDay);
                                                                const sourceDayOfWeek = sourceDay.getDay();
                                                                const mondayOfExportWeek = new Date(sourceDay);
                                                                mondayOfExportWeek.setDate(sourceDay.getDate() - sourceDayOfWeek + (sourceDayOfWeek === 0 ? -6 : 1));
                                                    
                                                                for (let i = 0; i < selectedDays.length; i++) {
                                                                    const dayName = selectedDays[i];
                                                                    const dayIndex = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].indexOf(dayName);
                                                                    const targetDay = new Date(mondayOfExportWeek);
                                                                    targetDay.setDate(mondayOfExportWeek.getDate() + dayIndex);
                                                    
                                                                    setCurrentDay(targetDay);
                                                                    await new Promise(resolve => setTimeout(resolve, 1500));
                                                    
                                                                    const canvas = await html2canvas(tableNode);
                                                                    const imgData = canvas.toDataURL('image/png');
                                                                    const pdfWidth = pdf.internal.pageSize.getWidth();
                                                                    const canvasWidth = canvas.width;
                                                                    const canvasHeight = canvas.height;
                                                                    const ratio = canvasWidth / canvasHeight;
                                                                    const imgWidth = pdfWidth - 80;
                                                                    const imgHeight = imgWidth / ratio;
                                                    
                                                                    if (i > 0) { pdf.addPage(); }
                                                                    const dateText = `${dayFormatter.format(targetDay)} - ${formatDate(targetDay)}`;
                                                                    pdf.setFontSize(12);
                                                                    pdf.text(dateText, 40, 30);
                                                                    pdf.addImage(imgData, 'PNG', 40, 40, imgWidth, imgHeight);
                                                                }
                                                                pdf.save(`schedule-week-${getWeekNumber(currentDay)}.pdf`);
                                                            }
                                                            tableNode.classList.remove('export-style');
                                                            document.head.removeChild(style);
                                                        }
                                                
                                                        setIsExporting(false);
                                                        handleCloseExportModal();
                                                        setCurrentDay(initialDay);
                                                      };

                                                      // COPY/PASTE HANDLERS
                                                      const handleOpenCopyModal = () => { if (isEditor) setIsCopyModalOpen(true); };
                                                      const handleCloseCopyModal = () => { setIsCopyModalOpen(false); setCopyTargetDate(null); };
                                                      const handlePasteDay = async () => {
                                                        if (!copyTargetDate) { alert('Please select a target date.'); return; }
                                                        const sourceDayString = currentDay.toISOString().split('T')[0]; 
                                                        const targetDayString = copyTargetDate.toISOString().split('T')[0];
                                                        const eventsToCopy = schedules.filter(event => event.day === sourceDayString);
                                                        
                                                        if (eventsToCopy.length === 0) { 
                                                          alert('There is nothing to copy from the selected day.'); 
                                                          handleCloseCopyModal(); 
                                                          return; 
                                                        }

                                                        try {
                                                          // First, delete all events on the target day
                                                          const deleteResponse = await fetch(`${API_URL}/schedules/by-day`, {
                                                            method: 'DELETE',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ day: targetDayString })
                                                          });

                                                          if (!deleteResponse.ok) {
                                                            const errorData = await deleteResponse.json();
                                                            throw new Error(errorData.message || 'Failed to clear target day.');
                                                          }

                                                          // Then, create the new events
                                                          const newEvents = eventsToCopy.map(({ _id, ...event }) => ({ ...event, day: targetDayString }));
                                                          const createResponse = await fetch(`${API_URL}/events/batch`, { 
                                                            method: 'POST', 
                                                            headers: { 'Content-Type': 'application/json' }, 
                                                            body: JSON.stringify(newEvents) 
                                                          });

                                                          if (!createResponse.ok) { 
                                                            throw new Error('Failed to paste schedule.'); 
                                                          }

                                                          await createResponse.json(); 
                                                          fetchData(); 
                                                          alert(`Successfully replaced schedule on ${formatDate(copyTargetDate)} with schedule from ${formatDate(currentDay)}.`);
                                                          handleCloseCopyModal(); 
                                                          setCurrentDay(copyTargetDate);
                                                        } catch (err) { 
                                                          console.error("Failed to paste schedule", err); 
                                                          alert(`An error occurred while pasting the schedule: ${err.message}`); 
                                                        }
                                                      };
                                                      const handleOpenCopyWeekModal = () => { if (isEditor) setIsCopyWeekModalOpen(true); };
                                                      const handleCloseCopyWeekModal = () => { setIsCopyWeekModalOpen(false); setCopyWeekTargetDate(null); };
                                                      const handlePasteWeek = async () => {
                                                                          if (!copyWeekTargetDate) {
                                                                              alert('Please select a target date.');
                                                                              return;
                                                                          }
                                                                  
                                                                          const sourceDay = new Date(currentDay);
                                                                          const sourceDayOfWeek = sourceDay.getDay();
                                                                          const mondayOfSourceWeek = new Date(sourceDay);
                                                                          mondayOfSourceWeek.setDate(sourceDay.getDate() - sourceDayOfWeek + (sourceDayOfWeek === 0 ? -6 : 1));
                                                                  
                                                                          const targetDayOfWeek = copyWeekTargetDate.getDay();
                                                                          const mondayOfTargetWeek = new Date(copyWeekTargetDate);
                                                                          mondayOfTargetWeek.setDate(copyWeekTargetDate.getDate() - targetDayOfWeek + (targetDayOfWeek === 0 ? -6 : 1));
                                                                  
                                                                          let eventsToCreate = [];
                                                                          for (let i = 0; i < 5; i++) { // Loop from Monday to Friday
                                                                              const sourceDate = new Date(mondayOfSourceWeek);
                                                                              sourceDate.setDate(mondayOfSourceWeek.getDate() + i);
                                                                              const sourceDateString = sourceDate.toISOString().split('T')[0];
                                                                  
                                                                              const eventsForSourceDay = schedules.filter(event => event.day === sourceDateString);
                                                                              
                                                                              if (eventsForSourceDay.length > 0) {
                                                                                  const targetDate = new Date(mondayOfTargetWeek);
                                                                                  targetDate.setDate(mondayOfTargetWeek.getDate() + i);
                                                                                  const targetDateString = targetDate.toISOString().split('T')[0];
                                                                                  const newEventsForTargetDay = eventsForSourceDay.map(({ _id, ...event }) => ({
                                                                                      ...event,
                                                                                      day: targetDateString
                                                                                  }));
                                                                                  eventsToCreate = [...eventsToCreate, ...newEventsForTargetDay];
                                                                              }
                                                                          }
                                                                  
                                                                          if (eventsToCreate.length === 0) {
                                                                              alert('There is nothing to copy from the selected week.');
                                                                              handleCloseCopyWeekModal();
                                                                              return;
                                                                          }
                                                                  
                                                                          try {
                                                                              // First, delete all events for the entire target week
                                                                              const deletePromises = [];
                                                                              for (let i = 0; i < 5; i++) {
                                                                                  const targetDate = new Date(mondayOfTargetWeek);
                                                                                  targetDate.setDate(mondayOfTargetWeek.getDate() + i);
                                                                                  const targetDateString = targetDate.toISOString().split('T')[0];
                                                                                  deletePromises.push(
                                                                                      fetch(`${API_URL}/schedules/by-day`, {
                                                                                          method: 'DELETE',
                                                                                          headers: { 'Content-Type': 'application/json' },
                                                                                          body: JSON.stringify({ day: targetDateString })
                                                                                      })
                                                                                  );
                                                                              }
                                                                              
                                                                              const deleteResponses = await Promise.all(deletePromises);
                                                                              for (const res of deleteResponses) {
                                                                                  if (!res.ok) {
                                                                                      const errorData = await res.json();
                                                                                      throw new Error(errorData.message || 'Failed to clear target week.');
                                                                                  }
                                                                              }

                                                                              // Then, create the new events
                                                                              const createResponse = await fetch(`${API_URL}/events/batch`, {
                                                                                  method: 'POST',
                                                                                  headers: { 'Content-Type': 'application/json' },
                                                                                  body: JSON.stringify(eventsToCreate)
                                                                              });
                                                                              if (!createResponse.ok) { throw new Error('Failed to paste week schedule.'); }
                                                                              
                                                                              await createResponse.json();
                                                                              fetchData();
                                                                              alert(`Successfully replaced schedule in the week of ${formatDate(mondayOfTargetWeek)} with schedule from the week of ${formatDate(mondayOfSourceWeek)}.`);
                                                                              handleCloseCopyWeekModal();
                                                                              setCurrentDay(mondayOfTargetWeek);
                                                                          } catch (err) {
                                                                              console.error("Failed to paste week schedule", err);
                                                                              alert(`An error occurred while pasting the week schedule: ${err.message}`);
                                                                          }
                                                                        };

                                                      // SUBJECT HANDLERS
                                                      const handleOpenUsageModal = (subjectId) => {
                                                        const subject = subjects.find(s => s.id === subjectId);
                                                        if (!subject) return;
                                                    
                                                        const usageDates = schedules
                                                          .filter(s => s.subjectId === subjectId)
                                                          .map(s => s.day)
                                                          .filter((day, index, self) => self.indexOf(day) === index) // Unique days
                                                          .sort((a, b) => new Date(a) - new Date(b))
                                                          .map(dayString => {
                                                            const date = new Date(dayString + 'T12:00:00'); // Use T12 to avoid timezone issues
                                                            return {
                                                              raw: dayString,
                                                              formatted: formatDate(date)
                                                            };
                                                          });
                                                    
                                                        setUsageData({ subjectName: subject.name, dates: usageDates });
                                                        setIsUsageModalOpen(true);
                                                      };

                                                      const handleCloseUsageModal = () => {
                                                        setIsUsageModalOpen(false);
                                                        setUsageData({ subjectName: '', dates: [] });
                                                      };

                                                      const handleDeleteUsagesForDay = async (subjectId, day) => {
                                                        if (!subjectId || !day) return;
                                                        
                                                        try {
                                                          const response = await fetch(`${API_URL}/schedules/by-subject-and-day`, {
                                                            method: 'DELETE',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ subjectId, day })
                                                          });
                                                    
                                                          if (!response.ok) {
                                                            const errorData = await response.json();
                                                            throw new Error(errorData.message || 'Failed to delete schedule entries.');
                                                          }
                                                    
                                                          // Refresh data to reflect the deletion
                                                          fetchData(); 
                                                    
                                                          // After deletion, re-evaluate the usage for the modal
                                                          handleOpenUsageModal(subjectId);
                                                          
                                                          // Also refresh the editing subjects list in case a subject becomes deletable
                                                          const updatedEditingSubjects = JSON.parse(JSON.stringify(subjects.map(s => ({...s, isUsed: schedules.some(sc => sc.subjectId === s.id && !(sc.subjectId === subjectId && sc.day === day))}))) );
                                                          setEditingSubjects(updatedEditingSubjects);


                                                        } catch (error) {
                                                          console.error("Error deleting usages for day:", error);
                                                          alert(`An error occurred: ${error.message}`);
                                                        }
                                                      };

                                                      const handleOpenSubjectModal = () => {
                                                        setEditingSubjects(JSON.parse(JSON.stringify(subjects))); // Deep copy
                                                        setIsSubjectModalOpen(true);
                                                      };
                                                      const handleCloseSubjectModal = () => {
                                                        setIsSubjectModalOpen(false);
                                                        setEditingSubjects([]);
                                                        setNewSubjectName('');
                                                        setNewSubjectColor('#1976d2');
                                                      };
                                                      const handleSaveSubjects = async () => {
                                                        const originalSubjects = subjects;
                                                        const changes = [];

                                                        // Identify deletions
                                                        const editingIds = new Set(editingSubjects.map(s => s.id));
                                                        originalSubjects.forEach(original => {
                                                          if (original.id && !editingIds.has(original.id)) {
                                                            changes.push(fetch(`${API_URL}/subjects/${original.id}`, {
                                                              method: 'DELETE'
                                                            }));
                                                          }
                                                        });
                                                    
                                                        // Identify new and updated subjects
                                                        editingSubjects.forEach((subject, index) => {
                                                          if (!subject._id) {
                                                            // New subject
                                                            changes.push(fetch(`${API_URL}/subjects`, {
                                                              method: 'POST',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ name: subject.name, color: subject.color, order: index })
                                                            }));
                                                          } else {
                                                            // Existing subject, check for changes
                                                            const original = originalSubjects.find(s => s.id === subject._id);
                                                            if (original && (original.name !== subject.name || original.color !== subject.color || original.order !== index)) {
                                                              changes.push(fetch(`${API_URL}/subjects/${subject._id}`, {
                                                                method: 'PUT',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ name: subject.name, color: subject.color, order: index })
                                                              }));
                                                            }
                                                          }
                                                        });
                                                        if (changes.length === 0) {
                                                          alert('No changes were made.');
                                                          handleCloseSubjectModal();
                                                          return;
                                                        }
                                                    
                                                        try {
                                                          const responses = await Promise.all(changes);
                                                          for (const res of responses) {
                                                            if (!res.ok) {
                                                              const errorText = await res.text();
                                                              throw new Error(`Server responded with: ${errorText || res.status}`);
                                                            }
                                                          }
                                                          fetchData(); // Refresh data in main app
                                                          handleCloseSubjectModal();
                                                          alert('Subjects saved successfully!');
                                                        } catch (error) {
                                                          console.error("Failed to save subjects:", error);
                                                          alert(`An error occurred while saving subjects: ${error.message}`);
                                                        }
                                                      };

                                                      // TEACHER HANDLERS
                                                      const handleOpenTeacherModal = () => {
                                                        setEditingTeachers(JSON.parse(JSON.stringify(teachers))); // Deep copy
                                                        setIsTeacherModalOpen(true);
                                                      };

                                                      const handleCloseTeacherModal = () => {
                                                        setIsTeacherModalOpen(false);
                                                        setEditingTeachers([]);
                                                        setNewTeacherName('');
                                                      };

                                                      const handleSaveTeachers = async () => {
                                                        const originalTeachers = teachers;
                                                        const changes = [];

                                                        const editingIds = new Set(editingTeachers.map(t => t.id));
                                                        originalTeachers.forEach(original => {
                                                          if (original.id && !editingIds.has(original.id)) {
                                                            changes.push(fetch(`${API_URL}/teachers/${original.id}`, { method: 'DELETE' }));
                                                          }
                                                        });

                                                        editingTeachers.forEach((teacher, index) => {
                                                          if (!teacher._id) { // New teacher
                                                            changes.push(fetch(`${API_URL}/teachers`, {
                                                              method: 'POST',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ name: teacher.name, order: index, email: teacher.email })
                                                            }));
                                                          } else { // Existing teacher
                                                            const original = originalTeachers.find(t => t._id === teacher._id);
                                                            if (original && (original.name !== teacher.name || original.order !== index || original.email !== teacher.email)) {
                                                              changes.push(fetch(`${API_URL}/teachers/${teacher._id}`, {
                                                                method: 'PUT',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ name: teacher.name, order: index, email: teacher.email })
                                                              }));
                                                            }
                                                          }
                                                        });

                                                        if (changes.length === 0) {
                                                          alert('No changes were made.');
                                                          handleCloseTeacherModal();
                                                          return;
                                                        }

                                                        try {
                                                          const responses = await Promise.all(changes);
                                                          for (const res of responses) {
                                                            if (!res.ok) {
                                                              const errorText = await res.text();
                                                              throw new Error(`Server responded with: ${errorText || res.status}`);
                                                            }
                                                          }
                                                          fetchData();
                                                          handleCloseTeacherModal();
                                                          alert('Teachers saved successfully!');
                                                        } catch (error) {
                                                          console.error("Failed to save teachers:", error);
                                                          alert(`An error occurred while saving teachers: ${error.message}`);
                                                        }
                                                      };

                                                      const handleOpenTeacherUsageModal = (teacherId) => {
                                                        const teacher = teachers.find(t => t._id === teacherId);
                                                        if (!teacher) return;

                                                        const usageDates = schedules
                                                          .filter(s => s.teacherId === teacherId)
                                                          .map(s => s.day)
                                                          .filter((day, index, self) => self.indexOf(day) === index)
                                                          .sort((a, b) => new Date(a) - new Date(b))
                                                          .map(dayString => ({
                                                            raw: dayString,
                                                            formatted: formatDate(new Date(dayString + 'T12:00:00'))
                                                          }));
                                                        
                                                        setTeacherUsageData({ teacherName: teacher.name, dates: usageDates });
                                                        setIsTeacherUsageModalOpen(true);
                                                      };

                                                      const handleCloseTeacherUsageModal = () => {
                                                        setIsTeacherUsageModalOpen(false);
                                                        setTeacherUsageData({ teacherName: '', dates: [] });
                                                      };

                                                      const handleDeleteTeacherUsagesForDay = async (teacherId, day) => {
                                                        if (!teacherId || !day) return;
                                                        try {
                                                          const response = await fetch(`${API_URL}/schedules/by-teacher-and-day`, {
                                                            method: 'DELETE',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ teacherId, day })
                                                          });
                                                          if (!response.ok) throw new Error(await response.text());
                                                          fetchData();
                                                          handleOpenTeacherUsageModal(teacherId);
                                                        } catch (error) {
                                                          console.error("Error deleting teacher usages for day:", error);
                                                          alert(`An error occurred: ${error.message}`);
                                                        }
                                                      };

                                                      // ROOM HANDLERS
                                                      const handleOpenRoomModal = () => {
                                                        setEditingRooms(JSON.parse(JSON.stringify(rooms)));
                                                        setIsRoomModalOpen(true);
                                                      };

                                                      const handleCloseRoomModal = () => {
                                                        setIsRoomModalOpen(false);
                                                        setEditingRooms([]);
                                                        setNewRoomName('');
                                                      };

                                                      const handleSaveRooms = async () => {
                                                        const originalRooms = rooms;
                                                        const changes = [];

                                                        const editingIds = new Set(editingRooms.map(r => r.id));
                                                        originalRooms.forEach(original => {
                                                          if (original.id && !editingIds.has(original.id)) {
                                                            changes.push(fetch(`${API_URL}/rooms/${original.id}`, { method: 'DELETE' }));
                                                          }
                                                        });

                                                        editingRooms.forEach((room, index) => {
                                                          if (!room._id) { // New room
                                                            changes.push(fetch(`${API_URL}/rooms`, {
                                                              method: 'POST',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ name: room.name, order: index })
                                                            }));
                                                          } else { // Existing room
                                                            const original = originalRooms.find(r => r.id === room._id);
                                                            if (original && (original.name !== room.name || original.order !== index)) {
                                                              changes.push(fetch(`${API_URL}/rooms/${room._id}`, {
                                                                method: 'PUT',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ name: room.name, order: index })
                                                              }));
                                                            }
                                                          }
                                                        });

                                                        if (changes.length === 0) {
                                                          alert('No changes were made.');
                                                          handleCloseRoomModal();
                                                          return;
                                                        }

                                                        try {
                                                          const responses = await Promise.all(changes);
                                                          for (const res of responses) {
                                                            if (!res.ok) {
                                                              const errorText = await res.text();
                                                              throw new Error(`Server responded with: ${errorText || res.status}`);
                                                            }
                                                          }
                                                          fetchData();
                                                          handleCloseRoomModal();
                                                          alert('Rooms saved successfully!');
                                                        } catch (error) {
                                                          console.error("Failed to save rooms:", error);
                                                          alert(`An error occurred while saving rooms: ${error.message}`);
                                                        }
                                                      };

                                                      const handleOpenRoomUsageModal = (roomId) => {
                                                        const room = rooms.find(r => r.id === roomId);
                                                        if (!room) return;

                                                        const usageDates = schedules
                                                          .filter(s => s.roomId === roomId)
                                                          .map(s => s.day)
                                                          .filter((day, index, self) => self.indexOf(day) === index)
                                                          .sort((a, b) => new Date(a) - new Date(b))
                                                          .map(dayString => ({
                                                            raw: dayString,
                                                            formatted: formatDate(new Date(dayString + 'T12:00:00'))
                                                          }));
                                                        
                                                        setRoomUsageData({ roomName: room.name, dates: usageDates });
                                                        setIsRoomUsageModalOpen(true);
                                                      };

                                                      const handleCloseRoomUsageModal = () => {
                                                        setIsRoomUsageModalOpen(false);
                                                        setRoomUsageData({ roomName: '', dates: [] });
                                                      };

                                                      const handleDeleteRoomUsagesForDay = async (roomId, day) => {
                                                        if (!roomId || !day) return;
                                                        try {
                                                          const response = await fetch(`${API_URL}/schedules/by-room-and-day`, {
                                                            method: 'DELETE',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ roomId, day })
                                                          });
                                                          if (!response.ok) throw new Error(await response.text());
                                                          fetchData();
                                                          handleOpenRoomUsageModal(roomId);
                                                        } catch (error) {
                                                          console.error("Error deleting room usages for day:", error);
                                                          alert(`An error occurred: ${error.message}`);
                                                        }
                                                      };

                                                      // RENDER

      // ===================================================================================
      // TEACHER SCHEDULE VIEW COMPONENT
      // ===================================================================================
      const TeacherScheduleView = ({ teacher, schedules, subjects, timeSlots, currentDay, grades, handleOpenModal, isEditor }) => {
        if (!teacher || !currentDay || isNaN(currentDay.getTime())) {
          return null; // or a loading spinner
        }

        const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        
        // Get Monday of the current week
        const monday = new Date(currentDay);
        while (monday.getDay() !== 1) {
          monday.setDate(monday.getDate() - 1);
        }
        monday.setHours(0, 0, 0, 0);

        const weekDateStrings = weekDays.map((_, index) => {
          const day = new Date(monday);
          day.setDate(monday.getDate() + index);
          
          const year = day.getFullYear();
          const month = String(day.getMonth() + 1).padStart(2, '0');
          const date = String(day.getDate()).padStart(2, '0');
          
          return `${year}-${month}-${date}`;
        });

        const teacherSchedules = schedules.filter(event => 
          event.teacherId === teacher._id && weekDateStrings.includes(event.day)
        );

        return (
          <Box id="teacher-schedule-table">
            <table style={{ borderCollapse: 'collapse', width: '100%', tableLayout: 'fixed', minWidth: '1800px' }}>
              <thead>
                <tr>
                  <th style={{...darkGrayCellStyle, width: '120px'}}>Time</th>
                  {weekDays.map((day, index) => (
                    <th key={day} style={{...darkGrayCellStyle, textAlign: 'center'}}>
                      {day}<br/>{formatDate(new Date(weekDateStrings[index] + 'T12:00:00'))}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {timeSlots.map(timeSlot => {
                  const isSpecialRow = ['snack', 'lunch', 10].includes(timeSlot.id);
                  const rowStyle = { backgroundColor: isSpecialRow ? '#e0e0e0' : 'inherit' };
                  return (
                    <tr key={timeSlot.id}>
                      <td style={{...darkGrayCellStyle, ...rowStyle}}>{timeSlot.time}</td>
                      {weekDateStrings.map(dayString => {
                        const events = teacherSchedules.filter(e => e.day === dayString && e.timeSlotId === timeSlot.id);
                        
                        let cellContent = null;
                        if (events.length > 0) {
                          cellContent = (
                            <Box sx={{ display: 'flex', gap: '4px', width: '100%', height: '100%' }}>
                              {events.map(event => {
                                const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s.id === event.subjectId);
                                const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r.id === event.roomId);
                                const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                return (
                                  <Box key={event._id} sx={{ flex: 1, backgroundColor: eventColor, color: 'white', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', cursor: isEditor ? 'pointer' : 'default', whiteSpace: 'normal', wordBreak: 'break-word' }} onClick={() => handleOpenModal(event)}>
                                    <Typography variant="body1"><b>{subject ? `${subject.name} (Grade ${event.grade})` : `Event (Grade ${event.grade})`}</b></Typography>
                                    <Typography variant="body2">{room ? room.name : 'N/A'}</Typography>
                                  </Box>
                                );
                              })}
                            </Box>
                          );
                        } else {
                          if (timeSlot.id === 'snack') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Snack</Typography>; }
                          else if (timeSlot.id === 'lunch') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Lunchbreak</Typography>; }
                          else if (timeSlot.id === 10) { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Homework Time</Typography>; }
                        }

                        return (
                          <td key={`${dayString}-${timeSlot.id}`} style={{...darkGrayCellStyle, ...rowStyle}}>
                            {cellContent}
                          </td>
                        );
                      })}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </Box>
        );
      };

      // ===================================================================================
      // GRADE SCHEDULE VIEW COMPONENT
      // ===================================================================================
      const GradeScheduleView = ({ grade, schedules, subjects, teachers, rooms, timeSlots, currentDay, handleOpenModal, isEditor }) => {
        if (!grade || !currentDay || isNaN(currentDay.getTime())) {
          return null; // or a loading spinner
        }

        const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        
        // Get Monday of the current week
        const monday = new Date(currentDay);
        while (monday.getDay() !== 1) {
          monday.setDate(monday.getDate() - 1);
        }
        monday.setHours(0, 0, 0, 0);

        const weekDateStrings = weekDays.map((_, index) => {
          const day = new Date(monday);
          day.setDate(monday.getDate() + index);
          
          const year = day.getFullYear();
          const month = String(day.getMonth() + 1).padStart(2, '0');
          const date = String(day.getDate()).padStart(2, '0');
          
          return `${year}-${month}-${date}`;
        });

        const gradeSchedules = schedules.filter(event => 
          event.grade === grade && weekDateStrings.includes(event.day)
        );

        return (
          <Box id="grade-schedule-table">
            <table style={{ borderCollapse: 'collapse', width: '100%', tableLayout: 'fixed', minWidth: '1800px' }}>
              <thead>
                <tr>
                  <th style={{...darkGrayCellStyle, width: '120px'}}>Time</th>
                  {weekDays.map((day, index) => (
                    <th key={day} style={{...darkGrayCellStyle, textAlign: 'center'}}>
                      {day}<br/>{formatDate(new Date(weekDateStrings[index] + 'T12:00:00'))}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {timeSlots.map(timeSlot => {
                  const isSpecialRow = ['snack', 'lunch', 10].includes(timeSlot.id);
                  const rowStyle = { backgroundColor: isSpecialRow ? '#e0e0e0' : 'inherit' };
                  return (
                    <tr key={timeSlot.id}>
                      <td style={{...darkGrayCellStyle, ...rowStyle}}>{timeSlot.time}</td>
                      {weekDateStrings.map(dayString => {
                        const events = gradeSchedules.filter(e => e.day === dayString && e.timeSlotId === timeSlot.id);
                        
                        let cellContent = null;
                        if (events.length > 0) {
                          cellContent = (
                            <Box sx={{ display: 'flex', gap: '4px', width: '100%', height: '100%' }}>
                              {events.map(event => {
                                const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s.id === event.subjectId);
                                const teacher = event.customTeacher ? { name: event.customTeacher } : teachers.find(t => t.id === event.teacherId);
                                const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r.id === event.roomId);
                                const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                return (
                                  <Box key={event._id} sx={{ flex: 1, backgroundColor: eventColor, color: 'white', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', cursor: isEditor ? 'pointer' : 'default', whiteSpace: 'normal', wordBreak: 'break-word' }} onClick={() => handleOpenModal(event)}>
                                    <Typography variant="body1"><b>{subject ? `${subject.name} (${teacher ? teacher.name : 'N/A'})` : `Event (${teacher ? teacher.name : 'N/A'})`}</b></Typography>
                                    <Typography variant="body2">{room ? room.name : 'N/A'}</Typography>
                                  </Box>
                                );
                              })}
                            </Box>
                          );
                        } else {
                          if (timeSlot.id === 'snack') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Snack</Typography>; }
                          else if (timeSlot.id === 'lunch') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Lunchbreak</Typography>; }
                          else if (timeSlot.id === 10) { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Homework Time</Typography>; }
                        }

                        return (
                          <td key={`${dayString}-${timeSlot.id}`} style={{...darkGrayCellStyle, ...rowStyle}}>
                            {cellContent}
                          </td>
                        );
                      })}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </Box>
        );
      };


      return (
        <ThemeProvider theme={theme}>
          <CssBaseline />
           <AppBar position="static" sx={{ backgroundColor: '#EF333F' }}>
            <Toolbar>
              <Box component="div" sx={{ flexGrow: 1 }}>
                <img src="v3-2.png" alt="Schloss Krumbach Timetable" style={{ height: '40px', verticalAlign: 'middle', border: '2px solid white', borderRadius: '4px' }} />
              </Box>

              {isEditor && (
                <>
                  <Button
                    id="menu-button"
                    aria-controls={isMenuOpen ? 'basic-menu' : undefined}
                    aria-haspopup="true"
                    aria-expanded={isMenuOpen ? 'true' : undefined}
                    onClick={handleMenuOpen}
                    variant="contained"
                    color="primary"
                    sx={{ mr: 1 }}
                  >
                    MENU
                  </Button>
                  <Menu
                    id="basic-menu"
                    anchorEl={anchorEl}
                    open={isMenuOpen}
                    onClose={handleMenuClose}
                    MenuListProps={{
                      'aria-labelledby': 'menu-button',
                    }}
                  >
                    <MenuItem onClick={() => { handleOpenCopyModal(); handleMenuClose(); }}>Copy Day</MenuItem>
                    <MenuItem onClick={() => { handleOpenCopyWeekModal(); handleMenuClose(); }}>Copy Week</MenuItem>
                    <MenuItem onClick={() => { handleOpenSubjectModal(); handleMenuClose(); }}>Edit Subjects</MenuItem>
                    <MenuItem onClick={() => { handleOpenTeacherModal(); handleMenuClose(); }}>Edit Teachers</MenuItem>
                    <MenuItem onClick={() => { handleOpenRoomModal(); handleMenuClose(); }}>Edit Rooms</MenuItem>
                    <MenuItem onClick={() => { setIsLessonCounterModalOpen(true); handleMenuClose(); }}>Lesson Counter</MenuItem>
                    <MenuItem onClick={() => { handleOpenExportModal(); handleMenuClose(); }}>Export to PDF</MenuItem>
                  </Menu>
                  <Button variant="contained" color="primary" sx={{ mr: 2 }} onClick={handleOpenSendMailModal}>Send Mail</Button>
                  <Button variant="contained" color="primary" sx={{ mr: 2 }} onClick={() => handleOpenModal()} disabled={isLoadingData}>Add Event</Button>
                </>
              )}

              <Button variant="outlined" color="inherit" onClick={onLogout}>Logout</Button>
            </Toolbar>
          </AppBar>
          <Container style={{ marginTop: '2rem', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
            {isEditor ? (
              <>
                {/* Full controls for editor */}
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', mb: 2 }}>
                    <FormControl sx={{ minWidth: 120 }}>
                      <InputLabel id="week-select-label" sx={{ fontSize: '1.2rem' }}>Week</InputLabel>
                      <Select labelId="week-select-label" value={getWeekNumber(currentDay)} label="Week" onChange={handleWeekChange} sx={{ fontWeight: 'bold' }}>
                        {getAllWeeks().map(week => (<MenuItem key={week} value={week} sx={{ textAlign: 'center' }}>{week}</MenuItem>))}
                      </Select>
                    </FormControl>
                    <FormControl sx={{ minWidth: 150, ml: 2, backgroundColor: 'white', borderRadius: '4px' }}>
                      <InputLabel id="teacher-filter-label">Filter by Teacher</InputLabel>
                      <Select
                        labelId="teacher-filter-label"
                        id="teacher-filter"
                        value={selectedTeacher}
                        label="Filter by Teacher"
                        onChange={(e) => {
                          setSelectedTeacher(e.target.value);
                          setSelectedGrade(''); // Reset grade filter
                        }}
                      >
                        <MenuItem value="">
                          <em>All Teachers</em>
                        </MenuItem>
                        {teachers.map(teacher => (
                          teacher && <MenuItem key={teacher._id} value={teacher._id}>{teacher.name}</MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                    <FormControl sx={{ minWidth: 150, ml: 2, backgroundColor: 'white', borderRadius: '4px' }}>
                      <InputLabel id="grade-filter-label">Filter by Grade</InputLabel>
                      <Select
                        labelId="grade-filter-label"
                        id="grade-filter"
                        value={selectedGrade}
                        label="Filter by Grade"
                        onChange={(e) => {
                          setSelectedGrade(e.target.value);
                          setSelectedTeacher(''); // Reset teacher filter
                        }}
                      >
                        <MenuItem value="">
                          <em>All Grades</em>
                        </MenuItem>
                        {grades.map(grade => (
                          <MenuItem key={grade} value={grade}>{`Grade ${grade}`}</MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                </Box>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', mb: 2 }}>
                    <IconButton onClick={handlePrevDay}><Icon>arrow_back_ios</Icon></IconButton>
                    {isPickingDate ? (
                        <input type="date" ref={dateInputRef} style={{ fontSize: '1.5rem', border: '1px solid #ccc', borderRadius: '4px' }}
                          value={currentDay.toISOString().split('T')[0]}
                          onChange={(e) => {
                            if (e.target.value) { const selectedDate = new Date(e.target.value + 'T12:00:00'); setCurrentDay(selectedDate); setInitialDay(selectedDate); }
                            setIsPickingDate(false);
                          }}
                          onBlur={() => setIsPickingDate(false)}
                        />
                    ) : (
                        <Typography variant="h5" onClick={() => setIsPickingDate(true)} sx={{ cursor: 'pointer', p: 1, '&:hover': { textDecoration: 'underline' } }}>
                          {selectedTeacher || selectedGrade ? `Week of ${formatDate(currentDay)}` : `${dayFormatter.format(currentDay)} - ${formatDate(currentDay)}`}
                        </Typography>
                    )}
                    <IconButton onClick={handleNextDay}><Icon>arrow_forward_ios</Icon></IconButton>
                </Box>
              </>
            ) : (
              <>
                {/* Limited controls for viewer */}
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', mb: 2 }}>
                    <IconButton onClick={handlePrevDay} disabled={currentDay <= monday}><Icon>arrow_back_ios</Icon></IconButton>
                    <Typography variant="h5" sx={{ p: 1 }}>
                      {`${dayFormatter.format(currentDay)} - ${formatDate(currentDay)}`}
                    </Typography>
                    <IconButton onClick={handleNextDay} disabled={currentDay >= friday}><Icon>arrow_forward_ios</Icon></IconButton>
                </Box>
              </>
            )}
            {selectedTeacher ? (
              <TeacherScheduleView 
                teacher={teachers.find(t => t && t._id === selectedTeacher)}
                schedules={schedules}
                subjects={subjects}
                timeSlots={timeSlots}
                currentDay={currentDay}
                grades={grades}
                handleOpenModal={handleOpenModal}
                isEditor={isEditor}
              />
            ) : selectedGrade ? (
              <GradeScheduleView
                grade={selectedGrade}
                schedules={schedules}
                subjects={subjects}
                teachers={teachers}
                rooms={rooms}
                timeSlots={timeSlots}
                currentDay={currentDay}
                handleOpenModal={handleOpenModal}
                isEditor={isEditor}
              />
            ) : (
              <Box id="schedule-table">
                <table style={{ borderCollapse: 'collapse', width: '100%', tableLayout: 'fixed', minWidth: '1800px' }}>
                  <thead>
                    <tr>
                      <th style={{...darkGrayCellStyle, width: '120px', whiteSpace: 'nowrap'}}>Time</th>
                      {grades.map(grade => <th key={grade} style={{...darkGrayCellStyle, textAlign: 'center', width: '280px'}}>{`Grade ${grade}`}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {timeSlots.map(timeSlot => {
                      const isSpecialRow = ['snack', 'lunch', 10].includes(timeSlot.id);
                      const rowStyle = { backgroundColor: isSpecialRow ? '#e0e0e0' : 'inherit' };
                      return (
                          <tr key={timeSlot.id}>
                          <td style={{...darkGrayCellStyle, ...rowStyle, width: '120px', whiteSpace: 'nowrap'}}>{timeSlot.time}</td>
                          {grades.map(grade => {
                              const events = getEventsForCell(grade, timeSlot.id);
                              let cellContent;

                              if (events.length > 1) {
                                  // If multiple events, wrap them in a flexbox container
                                  cellContent = (
                                      <Box sx={{ display: 'flex', gap: '4px', width: '100%', height: '100%' }}>
                                          {events.map(event => {
                                              const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s.id === event.subjectId);
                                              const teacher = event.customTeacher ? { name: event.customTeacher } : teachers.find(t => t.id === event.teacherId);
                                              const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r.id === event.roomId);
                                              const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                              return (
                                                  <Box key={event._id} sx={{ flex: 1, backgroundColor: eventColor, color: 'white', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', cursor: isEditor ? 'pointer' : 'default', whiteSpace: 'normal', wordBreak: 'break-word' }} onClick={() => handleOpenModal(event)}>
                                                      <Typography variant="body1"><b>{subject ? subject.name : 'Event'}</b></Typography>
                                                      <Typography variant="body2">{teacher ? teacher.name : 'N/A'} / {room ? room.name : 'N/A'}</Typography>
                                                  </Box>
                                              );
                                          })}
                                      </Box>
                                  );
                              } else if (events.length === 1) {
                                  // Original logic for a single event
                                  const event = events[0];
                                  const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s.id === event.subjectId);
                                  const teacher = event.customTeacher ? { name: event.customTeacher } : teachers.find(t => t.id === event.teacherId);
                                  const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r.id === event.roomId);
                                  const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                  cellContent = (
                                      <Box key={event._id} sx={{ backgroundColor: eventColor, color: 'white', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', cursor: isEditor ? 'pointer' : 'default', whiteSpace: 'normal', wordBreak: 'break-word' }} onClick={() => handleOpenModal(event)}>
                                          <Typography variant="body1"><b>{subject ? subject.name : 'Event'}</b></Typography>
                                          <Typography variant="body2">{teacher ? teacher.name : 'N/A'} / {room ? room.name : 'N/A'}</Typography>
                                      </Box>
                                  );
                              } else {
                                  // Original logic for empty/special cells
                                  if (timeSlot.id === 'snack') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Snack</Typography>; }
                                  else if (timeSlot.id === 'lunch') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Lunchbreak</Typography>; }
                                  else if (timeSlot.id === 10) { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Homework Time</Typography>; }
                              }

                              // The TD is now always standard
                              return (<td key={`${grade}-${timeSlot.id}`} style={{...darkGrayCellStyle, ...rowStyle}}>{cellContent}</td>);
                          })}
                          </tr>
                      )
                    })}
                  </tbody>
                </table>
              </Box>
            )}
            {isEditor && <>
              <Modal open={isModalOpen} onClose={handleCloseModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 600, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>{editingEvent ? 'Edit Schedule Event' : 'Add New Schedule Event'}</Typography>
                    <Grid container spacing={2}>
                        <Grid item xs={6}><FormControl fullWidth><InputLabel>Grade</InputLabel><Select name="grade" value={newEvent.grade} label="Grade" onChange={handleFormChange}>{grades.map(g => <MenuItem key={g} value={g}>{g}</MenuItem>)}</Select></FormControl></Grid>
                        <Grid item xs={6}><FormControl fullWidth><InputLabel>Time Slot</InputLabel><Select name="timeSlotId" value={newEvent.timeSlotId} label="Time Slot" onChange={handleFormChange}>{timeSlots.filter(t=>typeof t.id === 'number').map(t => <MenuItem key={t.id} value={t.id}>{t.time}</MenuItem>)}</Select></FormControl></Grid>
                        <Grid item xs={12}><FormControl fullWidth><InputLabel>Subject</InputLabel><Select name="subjectId" value={newEvent.subjectId} label="Subject" onChange={handleFormChange}>{subjects.map(s => <MenuItem key={s.id} value={s.id}>{s.name}</MenuItem>)}</Select></FormControl></Grid>
                        <Grid item xs={12}><TextField label="Or Custom Event Name" name="customSubject" value={newEvent.customSubject} onChange={handleFormChange} fullWidth variant="outlined"/></Grid>
                        <Grid item xs={6}><FormControl fullWidth><InputLabel>Teacher</InputLabel><Select name="teacherId" value={newEvent.teacherId} label="Teacher" onChange={handleFormChange}>{teachers.map(t => <MenuItem key={t.id} value={t.id}>{t.name}</MenuItem>)}</Select></FormControl></Grid>
                        <Grid item xs={6}><TextField label="Or Custom Teacher" name="customTeacher" value={newEvent.customTeacher} onChange={handleFormChange} fullWidth variant="outlined"/></Grid>
                        <Grid item xs={6}><FormControl fullWidth><InputLabel>Room</InputLabel><Select name="roomId" value={newEvent.roomId} label="Room" onChange={handleFormChange}>{rooms.map(r => <MenuItem key={r.id} value={r.id}>{r.name}</MenuItem>)}</Select></FormControl></Grid>
                        <Grid item xs={6}><TextField label="Or Custom Room" name="customRoom" value={newEvent.customRoom} onChange={handleFormChange} fullWidth variant="outlined"/></Grid>
                        <Grid item xs={12}><TextField label="Custom Color" type="color" name="color" value={newEvent.color} onChange={handleFormChange} fullWidth/></Grid>
                    </Grid>
                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'space-between'}}>
                      {editingEvent && <Button variant="contained" color="error" onClick={handleDelete}>Delete</Button>}
                      <Box>
                        <Button onClick={handleCloseModal} sx={{mr: 1}}>Cancel</Button>
                        <Button variant="contained" onClick={handleSubmit}>{editingEvent ? 'Update' : 'Save'}</Button>
                      </Box>
                    </Box>
                </Box>
              </Modal>
              <Modal open={isExportModalOpen} onClose={handleCloseExportModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Export Schedule to PDF</Typography>
                    <FormControl fullWidth sx={{mb: 2}}>
                        <InputLabel>Export Type</InputLabel>
                        <Select
                            value={exportSelection}
                            label="Export Type"
                            onChange={(e) => {
                                const value = e.target.value;
                                setExportSelection(value);
                                if (value.startsWith('grade-')) {
                                    setSelectedGrade(parseInt(value.split('-')[1]));
                                    setSelectedTeacher('');
                                } else {
                                    setSelectedTeacher(value === 'general' ? '' : value);
                                    setSelectedGrade('');
                                }
                            }}
                        >
                            <MenuItem value="general">General Schedule</MenuItem>
                            {teachers.map(teacher => (
                                <MenuItem key={teacher._id} value={teacher._id}>{teacher.name}</MenuItem>
                            ))}
                            {grades.map(grade => (
                                <MenuItem key={`grade-${grade}`} value={`grade-${grade}`}>{`Grade ${grade}`}</MenuItem>
                            ))}
                        </Select>
                    </FormControl>
                    {isExporting ? (
                        <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', flexDirection: 'column' }}>
                            <CircularProgress />
                            <Typography sx={{mt: 2}}>Exporting... Please wait.</Typography>
                        </Box>
                    ) : (
                        <>
                            <FormControl fullWidth sx={{mb: 2}}>
                                <InputLabel>Week</InputLabel>
                                <Select
                                    value={exportWeek}
                                    label="Week"
                                    onChange={handleExportWeekChange}
                                    disabled
                                >
                                    {getAllWeeks().map(week => (
                                        <MenuItem key={week} value={week}>{week}</MenuItem>
                                    ))}
                                </Select>
                            </FormControl>
                            <Typography variant="body2" sx={{mb: 1, color: exportSelection !== 'general' ? 'text.disabled' : 'text.primary'}}>Optional: To export a range, enter start and end weeks.</Typography>
                            <Box sx={{ display: 'flex', gap: 2, mb: 2 }}>
                                <TextField
                                    label="Start Week"
                                    type="number"
                                    value={startWeek}
                                    onChange={(e) => setStartWeek(e.target.value)}
                                    fullWidth
                                    InputLabelProps={{ shrink: true }}
                                    disabled={exportSelection !== 'general'}
                                />
                                <TextField
                                    label="End Week"
                                    type="number"
                                    value={endWeek}
                                    onChange={(e) => setEndWeek(e.target.value)}
                                    fullWidth
                                    InputLabelProps={{ shrink: true }}
                                    disabled={exportSelection !== 'general'}
                                />
                            </Box>
                            <FormControl component="fieldset" variant="standard" sx={{mb: 2, width: '100%'}} disabled={exportSelection !== 'general'}>
                                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <Typography component="legend" sx={{color: exportSelection !== 'general' ? 'text.disabled' : 'text.primary'}}>Select Days to Export:</Typography>
                                    <Button 
                                        size="small" 
                                        onClick={handleToggleAllExportDays}
                                        disabled={exportSelection !== 'general'}
                                    >
                                        All
                                    </Button>
                                </Box>
                                <Box sx={{ display: 'flex', flexDirection: 'row', justifyContent: 'space-around', mt: 1 }}>
                                    {Object.keys(exportDays).map((day) => (
                                        <FormControlLabel
                                            key={day}
                                            control={
                                                <Checkbox checked={exportDays[day]} onChange={handleExportDayChange} name={day} />
                                            }
                                            label={day.substring(0, 3)}
                                        />
                                    ))}
                                </Box>
                            </FormControl>
                            <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                <Button onClick={handleCloseExportModal} sx={{mr: 1}}>Cancel</Button>
                                <Button variant="contained" onClick={handleExport}>Export</Button>
                            </Box>
                        </>
                    )}
                </Box>
              </Modal>
              <Modal open={isCopyModalOpen} onClose={handleCloseCopyModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Copy Schedule</Typography>
                    <Typography sx={{mb: 2}}>Copying schedule from: <b>{formatDate(currentDay)}</b></Typography>
                    <TextField
                        label="Paste to date"
                        type="date"
                        fullWidth
                        InputLabelProps={{ shrink: true }}
                        onChange={(e) => {
                            if (e.target.value) {
                                setCopyTargetDate(new Date(e.target.value + 'T12:00:00'));
                            } else {
                                setCopyTargetDate(null);
                            }
                        }}
                    />
                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                        <Button onClick={handleCloseCopyModal} sx={{mr: 1}}>Cancel</Button>
                        <Button variant="contained" onClick={handlePasteDay} disabled={!copyTargetDate}>Paste</Button>
                    </Box>
                </Box>
              </Modal>
              <Modal open={isCopyWeekModalOpen} onClose={handleCloseCopyWeekModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Copy Week's Schedule</Typography>
                    <Typography sx={{mb: 2}}>Copying schedule from week of: <b>{formatDate(currentDay)}</b></Typography>
                    <TextField
                        label="Paste to any date in target week"
                        type="date"
                        fullWidth
                        InputLabelProps={{ shrink: true }}
                        onChange={(e) => {
                            if (e.target.value) {
                                setCopyWeekTargetDate(new Date(e.target.value + 'T12:00:00'));
                            } else {
                                setCopyWeekTargetDate(null);
                            }
                        }}
                    />
                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                        <Button onClick={handleCloseCopyWeekModal} sx={{mr: 1}}>Cancel</Button>
                        <Button variant="contained" onClick={handlePasteWeek} disabled={!copyWeekTargetDate}>Paste</Button>
                    </Box>
                </Box>
              </Modal>
                                          <Modal open={isSubjectModalOpen} onClose={handleCloseSubjectModal}>
                                            <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 600, maxHeight: '80vh', overflowY: 'auto', bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                <Typography variant="h6" component="h2" sx={{mb: 2}}>Edit Subjects</Typography>
                                                <Box sx={{ mb: 3 }}>
                                                    {editingSubjects.map((subject, index) => (
                                                        <Box 
                                                            key={subject._id || `new-${index}`} 
                                                            sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 2, cursor: 'move', p: 1, border: '1px dashed grey' }}
                                                            draggable={true}
                                                            onDragStart={(e) => handleDragStart(e, index)}
                                                            onDragOver={handleDragOver}
                                                            onDrop={(e) => handleDrop(e, index, 'subjects')}
                                                        >
                                                            <Icon>drag_indicator</Icon>
                                                            <TextField
                                                                label="Subject Name"
                                                                value={subject.name}
                                                                onChange={(e) => {
                                                                    const updatedSubjects = [...editingSubjects];
                                                                    updatedSubjects[index].name = e.target.value;
                                                                    setEditingSubjects(updatedSubjects);
                                                                }}
                                                                fullWidth
                                                                variant="outlined"
                                                            />
                                                            <input
                                                                type="color"
                                                                value={subject.color}
                                                                onChange={(e) => {
                                                                    const updatedSubjects = [...editingSubjects];
                                                                    updatedSubjects[index].color = e.target.value;
                                                                    setEditingSubjects(updatedSubjects);
                                                                }}
                                                                style={{ width: '50px', height: '50px', border: 'none', padding: 0, cursor: 'pointer' }}
                                                            />
                                                            <IconButton 
                                                                onClick={() => {
                                                                    const updatedSubjects = [...editingSubjects];
                                                                    updatedSubjects.splice(index, 1);
                                                                    setEditingSubjects(updatedSubjects);
                                                                }}
                                                                disabled={schedules.some(s => s.subjectId === subject._id)}
                                                                title={schedules.some(s => s.subjectId === subject._id) ? "Cannot delete: Subject is in use" : "Delete Subject"}
                                                            >
                                                                <Icon>delete</Icon>
                                                            </IconButton>
                                                            {schedules.some(s => s.subjectId === subject._id) && (
                                                                <IconButton onClick={() => handleOpenUsageModal(subject._id)} title="Find Usages">
                                                                    <Icon>search</Icon>
                                                                </IconButton>
                                                            )}
                                                        </Box>
                                                    ))}
                                                </Box>
                                                <Typography variant="h6" component="h2" sx={{mb: 2}}>Add New Subject</Typography>
                                                <Box sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 2 }}>
                                                    <TextField
                                                        label="New Subject Name"
                                                        value={newSubjectName}
                                                        onChange={(e) => setNewSubjectName(e.target.value)}
                                                        fullWidth
                                                        variant="outlined"
                                                    />
                                                    <input
                                                        type="color"
                                                        value={newSubjectColor}
                                                        onChange={(e) => setNewSubjectColor(e.target.value)}
                                                        style={{ width: '50px', height: '50px', border: 'none', padding: 0, cursor: 'pointer' }}
                                                    />
                                                    <Button
                                                        variant="contained"
                                                        onClick={() => {
                                                            if (newSubjectName.trim()) {
                                                                setEditingSubjects([...editingSubjects, { name: newSubjectName.trim(), color: newSubjectColor }]);
                                                                setNewSubjectName('');
                                                                setNewSubjectColor('#1976d2');
                                                            }
                                                        }}
                                                    >
                                                        Add
                                                    </Button>
                                                </Box>
                                                <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end', gap: 1}}>
                                                    <Button onClick={handleCloseSubjectModal}>Cancel</Button>
                                                    <Button variant="contained" onClick={handleSaveSubjects}>Save All Changes</Button>
                                                </Box>
                                            </Box>
                                          </Modal>

              <Modal open={isUsageModalOpen} onClose={handleCloseUsageModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>
                        Usage of "{usageData.subjectName}"
                    </Typography>
                    <Typography variant="body1" sx={{mb: 2}}>
                        This subject is used on the following dates. Click delete to remove all entries for a specific day.
                    </Typography>
                    <Box sx={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid #ccc', p: 1, mb: 2 }}>
                        {usageData.dates.length > 0 ? (
                            usageData.dates.map((dateInfo, index) => (
                                <Box key={index} sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', p: 0.5 }}>
                                    <Typography>{dateInfo.formatted}</Typography>
                                    <IconButton 
                                        size="small" 
                                        onClick={() => handleDeleteUsagesForDay(subjects.find(s => s.name === usageData.subjectName)?.id, dateInfo.raw)}
                                        title={`Delete all '${usageData.subjectName}' entries for ${dateInfo.formatted}`}
                                    >
                                        <Icon>delete_outline</Icon>
                                    </IconButton>
                                </Box>
                            ))
                        ) : (
                            <Typography>No usages found. You can now delete this subject.</Typography>
                        )}
                    </Box>
                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                        <Button onClick={handleCloseUsageModal}>Close</Button>
                                                                    </Box>
                                                                </Box>
                                                              </Modal>
                    
                                                              <Modal open={isTeacherModalOpen} onClose={handleCloseTeacherModal}>
                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 600, maxHeight: '80vh', overflowY: 'auto', bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Edit Teachers</Typography>
                                                                    <Box sx={{ mb: 3 }}>
                                                                        {editingTeachers.map((teacher, index) => (
                                                                            <Box 
                                                                                key={teacher._id || `new-${index}`} 
                                                                                sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 2, cursor: 'move', p: 1, border: '1px dashed grey' }}
                                                                                                                                            draggable={true}
                                                                                                                                            onDragStart={(e) => handleDragStart(e, index)}
                                                                                                                                            onDragOver={handleDragOver}
                                                                                                                                            onDrop={(e) => handleDrop(e, index, 'teachers')}
                                                                                                                                        >                                                                                <Icon>drag_indicator</Icon>
                                                                                <TextField
                                                                                    label="Teacher Name"
                                                                                    value={teacher.name}
                                                                                    onChange={(e) => {
                                                                                        const updatedTeachers = [...editingTeachers];
                                                                                        updatedTeachers[index].name = e.target.value;
                                                                                        setEditingTeachers(updatedTeachers);
                                                                                    }}
                                                                                    fullWidth
                                                                                    variant="outlined"
                                                                                />
                                                                                <TextField
                                                                                    label="Email"
                                                                                    value={teacher.email || ''}
                                                                                    onChange={(e) => {
                                                                                        const updatedTeachers = [...editingTeachers];
                                                                                        updatedTeachers[index].email = e.target.value;
                                                                                        setEditingTeachers(updatedTeachers);
                                                                                    }}
                                                                                    fullWidth
                                                                                    variant="outlined"
                                                                                    sx={{ mt: 1 }}
                                                                                />
                                                                                <IconButton 
                                                                                    onClick={() => {
                                                                                        const updatedTeachers = [...editingTeachers];
                                                                                        updatedTeachers.splice(index, 1);
                                                                                        setEditingTeachers(updatedTeachers);
                                                                                    }}
                                                                                    disabled={schedules.some(s => s.teacherId === teacher._id)}
                                                                                    title={schedules.some(s => s.teacherId === teacher._id) ? "Cannot delete: Teacher is in use" : "Delete Teacher"}
                                                                                >
                                                                                    <Icon>delete</Icon>
                                                                                </IconButton>
                                                                                {schedules.some(s => s.teacherId === teacher._id) && (
                                                                                    <IconButton onClick={() => handleOpenTeacherUsageModal(teacher._id)} title="Find Usages">
                                                                                        <Icon>search</Icon>
                                                                                    </IconButton>
                                                                                )}
                                                                            </Box>
                                                                        ))}
                                                                    </Box>
                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Add New Teacher</Typography>
                                                                    <Box sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 2 }}>
                                                                        <TextField
                                                                            label="New Teacher Name"
                                                                            value={newTeacherName}
                                                                            onChange={(e) => setNewTeacherName(e.target.value)}
                                                                            fullWidth
                                                                            variant="outlined"
                                                                        />
                                                                        <TextField
                                                                            label="New Teacher Email"
                                                                            value={newTeacherEmail}
                                                                            onChange={(e) => setNewTeacherEmail(e.target.value)}
                                                                            fullWidth
                                                                            variant="outlined"
                                                                        />
                                                                        <Button
                                                                            variant="contained"
                                                                            onClick={() => {
                                                                                if (newTeacherName.trim()) {
                                                                                    setEditingTeachers([...editingTeachers, { name: newTeacherName.trim(), email: newTeacherEmail.trim() }]);
                                                                                    setNewTeacherName('');
                                                                                    setNewTeacherEmail('');
                                                                                }
                                                                            }}
                                                                        >
                                                                            Add
                                                                        </Button>
                                                                    </Box>
                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end', gap: 1}}>
                                                                        <Button onClick={handleCloseTeacherModal}>Cancel</Button>
                                                                        <Button variant="contained" onClick={handleSaveTeachers}>Save All Changes</Button>
                                                                    </Box>
                                                                </Box>
                                                              </Modal>
                    
                                                              <Modal open={isTeacherUsageModalOpen} onClose={handleCloseTeacherUsageModal}>
                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>
                                                                        Usage of "{teacherUsageData.teacherName}"
                                                                    </Typography>
                                                                    <Typography variant="body1" sx={{mb: 2}}>
                                                                        This teacher is used on the following dates. Click delete to remove all entries for a specific day.
                                                                    </Typography>
                                                                    <Box sx={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid #ccc', p: 1, mb: 2 }}>
                                                                        {teacherUsageData.dates.length > 0 ? (
                                                                            teacherUsageData.dates.map((dateInfo, index) => (
                                                                                <Box key={index} sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', p: 0.5 }}>
                                                                                    <Typography>{dateInfo.formatted}</Typography>
                                                                                    <IconButton 
                                                                                        size="small" 
                                                                                        onClick={() => handleDeleteTeacherUsagesForDay(teachers.find(t => t.name === teacherUsageData.teacherName)?._id, dateInfo.raw)}
                                                                                        title={`Delete all '${teacherUsageData.teacherName}' entries for ${dateInfo.formatted}`}
                                                                                    >
                                                                                        <Icon>delete_outline</Icon>
                                                                                    </IconButton>
                                                                                </Box>
                                                                            ))
                                                                        ) : (
                                                                            <Typography>No usages found. You can now delete this teacher.</Typography>
                                                                        )}
                                                                    </Box>
                                                                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                        <Button onClick={handleCloseTeacherUsageModal}>Close</Button>
                                                                                                                    </Box>
                                                                                                                </Box>
                                                                                                              </Modal>
                                                                    
                                                                                                              <Modal open={isRoomModalOpen} onClose={handleCloseRoomModal}>
                                                                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 600, maxHeight: '80vh', overflowY: 'auto', bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Edit Rooms</Typography>
                                                                                                                    <Box sx={{ mb: 3 }}>
                                                                                                                        {editingRooms.map((room, index) => (
                                                                                                                            <Box 
                                                                                                                                key={room._id || `new-${index}`} 
                                                                                                                                sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 2, cursor: 'move', p: 1, border: '1px dashed grey' }}
                                                                                                                                draggable={true}
                                                                                                                                onDragStart={(e) => handleDragStart(e, index)}
                                                                                                                                onDragOver={handleDragOver}
                                                                                                                                onDrop={(e) => handleDrop(e, index, 'rooms')}
                                                                                                                            >
                                                                                                                                <Icon>drag_indicator</Icon>
                                                                                                                                <TextField
                                                                                                                                    label="Room Name"
                                                                                                                                    value={room.name}
                                                                                                                                    onChange={(e) => {
                                                                                                                                        const updatedRooms = [...editingRooms];
                                                                                                                                        updatedRooms[index].name = e.target.value;
                                                                                                                                        setEditingRooms(updatedRooms);
                                                                                                                                    }}
                                                                                                                                    fullWidth
                                                                                                                                    variant="outlined"
                                                                                                                                />
                                                                                                                                <IconButton 
                                                                                                                                    onClick={() => {
                                                                                                                                        const updatedRooms = [...editingRooms];
                                                                                                                                        updatedRooms.splice(index, 1);
                                                                                                                                        setEditingRooms(updatedRooms);
                                                                                                                                    }}
                                                                                                                                    disabled={schedules.some(s => s.roomId === room._id)}
                                                                                                                                    title={schedules.some(s => s.roomId === room._id) ? "Cannot delete: Room is in use" : "Delete Room"}
                                                                                                                                >
                                                                                                                                    <Icon>delete</Icon>
                                                                                                                                </IconButton>
                                                                                                                                {schedules.some(s => s.roomId === room._id) && (
                                                                                                                                    <IconButton onClick={() => handleOpenRoomUsageModal(room._id)} title="Find Usages">
                                                                                                                                        <Icon>search</Icon>
                                                                                                                                    </IconButton>
                                                                                                                                )}
                                                                                                                            </Box>
                                                                                                                        ))}
                                                                                                                    </Box>
                                                                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Add New Room</Typography>
                                                                                                                    <Box sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 2 }}>
                                                                                                                        <TextField
                                                                                                                            label="New Room Name"
                                                                                                                            value={newRoomName}
                                                                                                                            onChange={(e) => setNewRoomName(e.target.value)}
                                                                                                                            fullWidth
                                                                                                                            variant="outlined"
                                                                                                                        />
                                                                                                                        <Button
                                                                                                                            variant="contained"
                                                                                                                            onClick={() => {
                                                                                                                                if (newRoomName.trim()) {
                                                                                                                                    setEditingRooms([...editingRooms, { name: newRoomName.trim() }]);
                                                                                                                                    setNewRoomName('');
                                                                                                                                }
                                                                                                                            }}
                                                                                                                        >
                                                                                                                            Add
                                                                                                                        </Button>
                                                                                                                    </Box>
                                                                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end', gap: 1}}>
                                                                                                                        <Button onClick={handleCloseRoomModal}>Cancel</Button>
                                                                                                                        <Button variant="contained" onClick={handleSaveRooms}>Save All Changes</Button>
                                                                                                                    </Box>
                                                                                                                </Box>
                                                                                                              </Modal>
                                                                    
                                                                                                              <Modal open={isRoomUsageModalOpen} onClose={handleCloseRoomUsageModal}>
                                                                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>
                                                                                                                        Usage of "{roomUsageData.roomName}"
                                                                                                                    </Typography>
                                                                                                                    <Typography variant="body1" sx={{mb: 2}}>
                                                                                                                        This room is used on the following dates. Click delete to remove all entries for a specific day.
                                                                                                                    </Typography>
                                                                                                                    <Box sx={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid #ccc', p: 1, mb: 2 }}>
                                                                                                                        {roomUsageData.dates.length > 0 ? (
                                                                                                                            roomUsageData.dates.map((dateInfo, index) => (
                                                                                                                                <Box key={index} sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', p: 0.5 }}>
                                                                                                                                    <Typography>{dateInfo.formatted}</Typography>
                                                                                                                                    <IconButton 
                                                                                                                                        size="small" 
                                                                                                                                        onClick={() => handleDeleteRoomUsagesForDay(rooms.find(r => r.name === roomUsageData.roomName)?.id, dateInfo.raw)}
                                                                                                                                        title={`Delete all '${roomUsageData.roomName}' entries for ${dateInfo.formatted}`}
                                                                                                                                    >
                                                                                                                                        <Icon>delete_outline</Icon>
                                                                                                                                    </IconButton>
                                                                                                                                </Box>
                                                                                                                            ))
                                                                                                                        ) : (
                                                                                                                            <Typography>No usages found. You can now delete this room.</Typography>
                                                                                                                        )}
                                                                                                                    </Box>
                                                                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                        <Button onClick={handleCloseRoomUsageModal}>Close</Button>
                                                                                                                    </Box>
                                                                                                                </Box>
                                                                                                              </Modal>

                                                                                                              <Modal open={isLessonCounterModalOpen} onClose={() => setIsLessonCounterModalOpen(false)}>
                                                                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 600, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                                                                  <Typography variant="h6" component="h2" sx={{mb: 2}}>Lesson Counter</Typography>
                                                                                                                  <Grid container spacing={2} alignItems="center">
                                                                                                                    <Grid item xs={6}>
                                                                                                                      <TextField
                                                                                                                        label="Start Date"
                                                                                                                        type="date"
                                                                                                                        fullWidth
                                                                                                                        InputLabelProps={{ shrink: true }}
                                                                                                                        value={counterStartDate}
                                                                                                                        onChange={(e) => setCounterStartDate(e.target.value)}
                                                                                                                      />
                                                                                                                    </Grid>
                                                                                                                    <Grid item xs={6}>
                                                                                                                      <TextField
                                                                                                                        label="End Date"
                                                                                                                        type="date"
                                                                                                                        fullWidth
                                                                                                                        InputLabelProps={{ shrink: true }}
                                                                                                                        value={counterEndDate}
                                                                                                                        onChange={(e) => setCounterEndDate(e.target.value)}
                                                                                                                      />
                                                                                                                    </Grid>
                                                                                                                    <Grid item xs={8}>
                                                                                                                      <FormControl fullWidth>
                                                                                                                        <InputLabel>Teacher</InputLabel>
                                                                                                                        <Select value={counterSelectedTeacher} label="Teacher" onChange={(e) => setCounterSelectedTeacher(e.target.value)}>
                                                                                                                          {teachers.map(t => <MenuItem key={t._id} value={t._id}>{t.name}</MenuItem>)}
                                                                                                                        </Select>
                                                                                                                      </FormControl>
                                                                                                                    </Grid>
                                                                                                                    <Grid item xs={4}>
                                                                                                                      <Typography variant="h6" component="p">
                                                                                                                        Total Hours: {lessonCount}
                                                                                                                      </Typography>
                                                                                                                    </Grid>
                                                                                                                    <Grid item xs={8}>
                                                                                                                      <FormControl fullWidth>
                                                                                                                        <InputLabel>Subject (Optional)</InputLabel>
                                                                                                                        <Select value={counterSelectedSubject} label="Subject (Optional)" onChange={(e) => setCounterSelectedSubject(e.target.value)}>
                                                                                                                          <MenuItem value=""><em>All Subjects</em></MenuItem>
                                                                                                                          {subjects.map(s => <MenuItem key={s.id} value={s.id}>{s.name}</MenuItem>)}
                                                                                                                        </Select>
                                                                                                                      </FormControl>
                                                                                                                    </Grid>
                                                                                                                  </Grid>
                                                                                                                  <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                    <Button onClick={() => setIsLessonCounterModalOpen(false)}>Close</Button>
                                                                                                                  </Box>
                                                                                                                </Box>
                                                                                                              </Modal>
                                                                                                              <SendMailModal 
                                                                                                                open={isSendMailModalOpen}
                                                                                                                onClose={() => setIsSendMailModalOpen(false)}
                                                                                                                teachers={teachers}
                                                                                                                grades={grades}
                                                                                                                emailBody={emailBody}
                                                                                                                setEmailBody={setEmailBody}
                                                                                                                recipients={emailRecipients}
                                                                                                                setRecipients={setEmailRecipients}
                                                                                                                currentDay={currentDay}
                                                                                                                getWeekNumber={getWeekNumber}
                                                                                                                selectedTeacher={selectedTeacher}
                                                                                                                setSelectedTeacher={setSelectedTeacher}
                                                                                                                selectedGrade={selectedGrade}
                                                                                                                setSelectedGrade={setSelectedGrade}
                                                                                                                formatDate={formatDate}
                                                                                                                setCurrentDay={setCurrentDay}
                                                                                                                dayFormatter={dayFormatter}
                                                                                                              />
                                                                                </>}
                                                                              </Container>
                                                                            </ThemeProvider>      );
    }

    // ===================================================================================
    // SEND MAIL MODAL COMPONENT
    // ===================================================================================
    function SendMailModal({ open, onClose, teachers, grades, emailBody, setEmailBody, recipients, setRecipients, currentDay, getWeekNumber, selectedTeacher, setSelectedTeacher, selectedGrade, setSelectedGrade, formatDate, setCurrentDay, dayFormatter }) {
      const [isSending, setIsSending] = React.useState(false);

      const handleRecipientChange = (event) => {
        const { name, checked } = event.target;
        setRecipients(prev => ({ ...prev, [name]: checked }));
      };

      const handleSend = async () => {
        setIsSending(true);
        const originalSelectedTeacher = selectedTeacher;
        const originalDay = new Date(currentDay); // Save the original day

        try {
          // 1. Save the email body text
          await fetch(`${API_URL}/email_text/1`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: emailBody })
          });
        } catch (error) {
          console.error("Failed to save email text:", error);
          // Non-fatal
        }

        // 2. Separate recipients
        const allTeachersRecipient = recipients['ALL_TEACHERS'] ? { email: 'teachers@krumbach.school', type: 'all' } : null;
        const individualRecipients = Object.keys(recipients)
          .filter(id => id !== 'ALL_TEACHERS' && !id.startsWith('grade-') && recipients[id])
          .map(id => teachers.find(t => t._id === id))
          .filter(t => t && t.email)
          .map(t => ({ email: t.email, teacherId: t._id, name: t.name, type: 'individual' }));
        
        const gradeRecipients = Object.keys(recipients)
          .filter(id => id.startsWith('grade-') && recipients[id])
          .map(id => {
            const grade = parseInt(id.split('-')[1]);
            return { email: `g${grade}@krumbach.school`, grade: grade, type: 'grade' };
          });

        if (!allTeachersRecipient && individualRecipients.length === 0 && gradeRecipients.length === 0) {
          alert('Please select at least one recipient.');
          setIsSending(false);
          return;
        }
        
        const { jsPDF } = window.jspdf;

        // 3. Process "All Teachers" (General Schedule)
        if (allTeachersRecipient) {
            try {
                // Ensure general view is active
                if (selectedTeacher !== '') {
                    setSelectedTeacher('');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const pdf = new jsPDF('landscape', 'pt', 'a4');
                const tableNode = document.querySelector('#schedule-table');
                const style = document.createElement('style');
                style.innerHTML = `.export-style th, .export-style td { border: 1px solid #000 !important; }`;
                document.head.appendChild(style);
                tableNode.classList.add('export-style');

                const sourceDay = new Date(currentDay);
                const sourceDayOfWeek = sourceDay.getDay();
                const mondayOfCurrentWeek = new Date(sourceDay);
                mondayOfCurrentWeek.setDate(sourceDay.getDate() - sourceDayOfWeek + (sourceDayOfWeek === 0 ? -6 : 1));

                for (let i = 0; i < 5; i++) { // Loop Monday to Friday
                    const targetDay = new Date(mondayOfCurrentWeek);
                    targetDay.setDate(mondayOfCurrentWeek.getDate() + i);
                    
                    setCurrentDay(targetDay);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for re-render

                const canvas = await html2canvas(document.querySelector('#schedule-table'), { scale: 1.5 });
                    const imgData = canvas.toDataURL('image/jpeg', 0.8);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const imgWidth = pdfWidth - 80;
                    const ratio = canvas.width / canvas.height;
                    const imgHeight = imgWidth / ratio;

                    if (i > 0) {
                        pdf.addPage();
                    }
                    
                    const dateText = `${dayFormatter.format(targetDay)} - ${formatDate(targetDay)}`;
                    pdf.setFontSize(12);
                    pdf.text(dateText, 40, 30);
                    pdf.addImage(imgData, 'JPEG', 40, 40, imgWidth, imgHeight);
                }

                tableNode.classList.remove('export-style');
                document.head.removeChild(style);

                const fridayOfCurrentWeek = new Date(mondayOfCurrentWeek);
                fridayOfCurrentWeek.setDate(mondayOfCurrentWeek.getDate() + 4);

                const weekNumber = getWeekNumber(currentDay);
                const weekRange = `${formatDate(mondayOfCurrentWeek)} to ${formatDate(fridayOfCurrentWeek)}`;
                const subject = `Schedule upcoming Week ${weekNumber} (${weekRange})`;
                const fileName = `SKIS_Schedule_Week_${weekNumber}.pdf`;
                const pdfDataUri = pdf.output('datauristring');

                const payload = { emailBody, recipient: allTeachersRecipient, subject, fileName, pdfDataUri };

                const response = await fetch(`${API_URL}/send-schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || result.message || `Failed to send email to ${allTeachersRecipient.email}.`);
                }

            } catch (error) {
                console.error('Error sending general schedule:', error);
                alert(`Error sending general schedule: ${error.message}`);
            }
        }

        // 4. Process Individual Teachers
        for (const recipient of individualRecipients) {
            try {
                // Switch to this teacher's view
                setSelectedTeacher(recipient.teacherId);
                await new Promise(resolve => setTimeout(resolve, 500));

                const pdf = new jsPDF('landscape', 'pt', 'a4');
                const tableSelector = '#teacher-schedule-table';
                const tableNode = document.querySelector(tableSelector);
                if (!tableNode) throw new Error(`Could not find table: ${tableSelector}`);

                const style = document.createElement('style');
                style.innerHTML = `.export-style th, .export-style td { border: 1px solid #000 !important; }`;
                document.head.appendChild(style);
                tableNode.classList.add('export-style');

                const canvas = await html2canvas(document.querySelector('#teacher-schedule-table'), { scale: 1.5 });
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                
                tableNode.classList.remove('export-style');
                document.head.removeChild(style);

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgWidth = pdfWidth - 80;
                const ratio = canvas.width / canvas.height;
                const imgHeight = imgWidth / ratio;

                const weekNumber = getWeekNumber(currentDay);
                const monday = new Date(currentDay);
                monday.setDate(currentDay.getDate() - (currentDay.getDay() === 0 ? 6 : currentDay.getDay() - 1));
                const friday = new Date(monday);
                friday.setDate(monday.getDate() + 4);
                const weekRange = `${formatDate(monday)} to ${formatDate(friday)}`;

                const subject = `Schedule upcoming Week ${weekNumber} (${weekRange})`;
                const fileName = `SKIS_${recipient.name.replace(/\s/g, '_')}_Schedule_Week_${weekNumber}.pdf`;
                const title = `Personal Schedule for ${recipient.name} - Week ${weekNumber}`;

                pdf.setFontSize(12);
                pdf.text(title, 40, 30);
                pdf.addImage(imgData, 'JPEG', 40, 40, imgWidth, imgHeight);
                
                const pdfDataUri = pdf.output('datauristring');
                const payload = { emailBody, recipient, subject, fileName, pdfDataUri };

                const response = await fetch(`${API_URL}/send-schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || result.message || `Failed to send email to ${recipient.email}.`);
                }
            } catch (error) {
                console.error(`Error sending schedule to ${recipient.name}:`, error);
                alert(`Error sending schedule to ${recipient.name}: ${error.message}`);
            }
        }

        // 5. Process Grade Recipients
        for (const recipient of gradeRecipients) {
            try {
                // Switch to this grade's view
                setSelectedGrade(recipient.grade);
                setSelectedTeacher('');
                await new Promise(resolve => setTimeout(resolve, 500));

                const pdf = new jsPDF('landscape', 'pt', 'a4');
                const tableSelector = '#grade-schedule-table';
                const tableNode = document.querySelector(tableSelector);
                if (!tableNode) throw new Error(`Could not find table: ${tableSelector}`);

                const style = document.createElement('style');
                style.innerHTML = `.export-style th, .export-style td { border: 1px solid #000 !important; }`;
                document.head.appendChild(style);
                tableNode.classList.add('export-style');

                const canvas = await html2canvas(document.querySelector('#grade-schedule-table'), { scale: 1.5 });
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                
                tableNode.classList.remove('export-style');
                document.head.removeChild(style);

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgWidth = pdfWidth - 80;
                const ratio = canvas.width / canvas.height;
                const imgHeight = imgWidth / ratio;

                const weekNumber = getWeekNumber(currentDay);
                const monday = new Date(currentDay);
                monday.setDate(currentDay.getDate() - (currentDay.getDay() === 0 ? 6 : currentDay.getDay() - 1));
                const friday = new Date(monday);
                friday.setDate(monday.getDate() + 4);
                const weekRange = `${formatDate(monday)} to ${formatDate(friday)}`;

                const subject = `Schedule upcoming Week ${weekNumber} (${weekRange})`;
                const fileName = `SKIS_Grade_${recipient.grade}_Schedule_Week_${weekNumber}.pdf`;
                const title = `Schedule for Grade ${recipient.grade} - Week ${weekNumber}`;

                pdf.setFontSize(12);
                pdf.text(title, 40, 30);
                pdf.addImage(imgData, 'JPEG', 40, 40, imgWidth, imgHeight);
                
                const pdfDataUri = pdf.output('datauristring');
                const payload = { emailBody, recipient, subject, fileName, pdfDataUri };

                const response = await fetch(`${API_URL}/send-schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || result.message || `Failed to send email to ${recipient.email}.`);
                }
            } catch (error) {
                console.error(`Error sending schedule to Grade ${recipient.grade}:`, error);
                alert(`Error sending schedule to Grade ${recipient.grade}: ${error.message}`);
            }
        }

        // 6. Cleanup
        alert('All selected emails have been processed.');
        setIsSending(false);
        setSelectedTeacher(originalSelectedTeacher); // Restore original view
        setSelectedGrade(''); // Clear selected grade
        setCurrentDay(originalDay); // Restore original day
        onClose();
      };

      return (
        <Modal open={open} onClose={onClose}>
          <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 800, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
            <Typography variant="h6" component="h2" sx={{mb: 2}}>Send Schedule via Email</Typography>
            {isSending ? (
              <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', flexDirection: 'column', height: '300px' }}>
                <CircularProgress />
                <Typography sx={{mt: 2}}>Sending emails... Please wait.</Typography>
              </Box>
            ) : (
              <>
                <TextField
                  label="Email Body"
                  multiline
                  rows={4}
                  fullWidth
                  value={emailBody}
                  onChange={(e) => setEmailBody(e.target.value)}
                  sx={{mb: 2}}
                />
                <Typography variant="subtitle1" sx={{mb: 1}}>Select Recipients</Typography>
                <Box sx={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid #ccc', p: 1, mb: 2 }}>
                  <FormControlLabel
                    control={<Checkbox checked={recipients['ALL_TEACHERS'] || false} onChange={handleRecipientChange} name="ALL_TEACHERS" />}
                    label="ALL TEACHERS (General Schedule)"
                  />
                  <hr/>
                  {teachers.filter(t => t.email).map(teacher => (
                    <FormControlLabel
                      key={teacher._id}
                      control={<Checkbox checked={recipients[teacher._id] || false} onChange={handleRecipientChange} name={teacher._id} />}
                      label={`${teacher.name} (${teacher.email})`}
                    />
                  ))}
                  <hr/>
                  {grades.map(grade => (
                    <FormControlLabel
                      key={`grade-${grade}`}
                      control={<Checkbox checked={recipients[`grade-${grade}`] || false} onChange={handleRecipientChange} name={`grade-${grade}`} />}
                      label={`Grade ${grade} (g${grade}@krumbach.school)`}
                    />
                  ))}
                </Box>
                <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                  <Button onClick={onClose} sx={{mr: 1}}>Cancel</Button>
                  <Button variant="contained" onClick={handleSend}>Send</Button>
                </Box>
              </>
            )}
          </Box>
        </Modal>
      );
    }                
                
                    // ===================================================================================
                    // AUTH WRAPPER COMPONENT
                    // ===================================================================================
                    function AuthWrapper() {
                      const [user, setUser] = React.useState(null);
                      const [isLoading, setIsLoading] = React.useState(true);
                
                      React.useEffect(() => {
                        // Check for user object from Google redirect
                        const params = new URLSearchParams(window.location.search);
                        const userParam = params.get('user');
                        const errorParam = params.get('error');
                
                        if (userParam) {
                          const loggedInUser = JSON.parse(decodeURIComponent(userParam));
                          localStorage.setItem('currentUser', JSON.stringify(loggedInUser));
                          setUser(loggedInUser);
                          // Clean URL after processing
                          window.history.replaceState({}, document.title, "/");
                        } else if (errorParam) {
                          // Let the Login component handle the error display
                          console.error("Login Error:", errorParam);
                        } else {
                          // Check for existing session in localStorage
                          const storedUser = localStorage.getItem('currentUser');
                          if (storedUser) {
                            setUser(JSON.parse(storedUser));
                          }
                        }
                        setIsLoading(false);
                      }, []);
                
                      const handleLogin = (loggedInUser) => {
                        localStorage.setItem('currentUser', JSON.stringify(loggedInUser));
                        setUser(loggedInUser);
                      };
                
                      const handleLogout = () => {
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('lastViewedDate');
                        setUser(null);
                      };
                
                      if (isLoading) {
                        return <ThemeProvider theme={theme}><Box sx={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}><CircularProgress /></Box></ThemeProvider>;
                      }
                
                      const params = new URLSearchParams(window.location.search);
                      const errorParam = params.get('error');
                
                      return (
                        user
                          ? <App user={user} onLogout={handleLogout} />
                          : <Login error={errorParam} />
                      );
                    }
                
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(<AuthWrapper />);
                
  </script>
</body>
</html>
