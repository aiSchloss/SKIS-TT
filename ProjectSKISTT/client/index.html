<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Schedule</title>
  <!-- Material UI Fonts and Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>
<body>
  <div id="root"></div>
  <div id="pdf-container" style={{ position: 'absolute', left: '-9999px', top: '-9999px' }}></div>

  <!-- React, Babel, and Material-UI via CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@mui/material@5/umd/material-ui.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    const {
      colors,
      createTheme,
      ThemeProvider,
      CssBaseline,
      AppBar,
      Toolbar,
      Typography,
      Container,
      Box,
      IconButton,
      Icon,
      Modal,
      Button,
      TextField,
      Select,
      MenuItem,
      InputLabel,
      FormControl,
      Grid,
      FormControlLabel,
      Checkbox,
      CircularProgress,
      Card,
      CardContent,
      Alert,
      Menu,
      useMediaQuery,
      Dialog,
      DialogTitle,
      DialogContent,
      DialogContentText,
      DialogActions,
      Backdrop,
      Tabs,
      Tab
    } = MaterialUI;

    const theme = createTheme({
      palette: {
        primary: {
          main: '#1976d2',
        },
        secondary: {
          main: '#dc004e',
        },
      },
    });

    const API_URL = '/api';

    // ===================================================================================
    // LOGIN COMPONENT
    // ===================================================================================
    function Login({ error }) {
      const handleLogin = async () => {
        try {
          const response = await fetch(`${API_URL}/auth/google/url`);
          const data = await response.json();
          if (data.url) {
            window.location.href = data.url;
          }
        } catch (err) {
          console.error("Failed to get Google auth URL", err);
        }
      };

      return (
        <ThemeProvider theme={theme}>
          <Container component="main" maxWidth="xs" sx={{ display: 'flex', alignItems: 'center', height: '100vh' }}>
            <Card sx={{ p: 2, width: '100%' }}>
              <CardContent>
                <Box sx={{ textAlign: 'center', mb: 2 }}>
                  <img src="v3-2.png" alt="Logo" style={{ height: '50px' }} />
                  <Typography component="h1" variant="h5" sx={{ mt: 1 }}>
                    SKIS Schedule Login
                  </Typography>
                </Box>
                {error && <Alert severity="error" sx={{ mb: 2 }}>{decodeURIComponent(error)}</Alert>}
                <Button
                  fullWidth
                  variant="contained"
                  onClick={handleLogin}
                  sx={{ mt: 2, mb: 2, display: 'flex', alignItems: 'center' }}
                >
                  <Icon sx={{ mr: 1 }}>login</Icon> 
                  Sign In with Google
                </Button>
              </CardContent>
            </Card>
          </Container>
        </ThemeProvider>
      );
    }

    // ===================================================================================
    // MAIN APP COMPONENT
    // ===================================================================================
    function App({ user, onLogout }) {
      // STATE
      const [currentDay, setCurrentDay] = React.useState(() => {
        const savedDateString = localStorage.getItem('lastViewedDate');
        if (savedDateString) {
          const savedDate = new Date(savedDateString);
          if (!isNaN(savedDate.getTime())) {
            return savedDate; // It's a valid date
          }
        }
        return new Date(); // Fallback to today
      });
      const [initialDay, setInitialDay] = React.useState(new Date());
      const [data, setData] = React.useState({ schedules: [], teachers: [], subjects: [], rooms: [], grades: [7, 8, 9, 10, 11, 12] });
      const [isModalOpen, setModalOpen] = React.useState(false);
      const [editingEvent, setEditingEvent] = React.useState(null);
      const [newEvent, setNewEvent] = React.useState({
        grade: '', grades: [], timeSlotId: '', timeSlotIds: [], subjectId: '', teacherId: '', roomId: '',
        color: '#ffffff', customSubject: '', customTeacher: '', customRoom: ''
      });
      const [formErrors, setFormErrors] = React.useState({});
      const [submitError, setSubmitError] = React.useState('');
      const [isConfirmOpen, setIsConfirmOpen] = React.useState(false);
      const [confirmMessage, setConfirmMessage] = React.useState('');
      const [pendingAction, setPendingAction] = React.useState(null);
      const [isSaving, setIsSaving] = React.useState(false);
      const [selectedEventIds, setSelectedEventIds] = React.useState([]);
      const [clipboardEvents, setClipboardEvents] = React.useState([]);
      const [cellMenuAnchor, setCellMenuAnchor] = React.useState(null);
      const [activeCellContext, setActiveCellContext] = React.useState(null);

      // ... existing code ...

      const handleCopyEvents = () => {
          const eventsToCopy = schedules.filter(e => selectedEventIds.includes(e._id));
          setClipboardEvents(eventsToCopy);
          setSelectedEventIds([]); // Clear selection after copying
      };

      const handleCopySingle = (e, event) => {
          e.stopPropagation();
          if (selectedEventIds.length > 0) {
              // If there is a selection, copy ALL selected events instead of just this one
              // This makes the small icon act as "Copy Selection" if selection exists
              const eventsToCopy = schedules.filter(evt => selectedEventIds.includes(evt._id));
              // Ensure the clicked event is included if it wasn't selected (optional, but good UX)
              if (!selectedEventIds.includes(event._id)) {
                  eventsToCopy.push(event);
              }
              setClipboardEvents(eventsToCopy);
          } else {
              setClipboardEvents([event]);
          }
          setSelectedEventIds([]); // Clear any multi-selection
      };

      const handleCellClick = (e, grade, timeSlotId) => {
          if (!isEditor) return;
          // Always open context menu
          setCellMenuAnchor(e.currentTarget);
          setActiveCellContext({ grade, timeSlotId });
      };

      const handlePasteFromMenu = () => {
          setCellMenuAnchor(null);
          if (activeCellContext) {
              handlePasteToCell(activeCellContext.grade, activeCellContext.timeSlotId);
          }
      };

      const handlePasteToCell = async (targetGrade, targetTimeSlotId, isForce = false) => {
          if (clipboardEvents.length === 0) return;
          console.log(`Pasting ${clipboardEvents.length} events to G${targetGrade}-T${targetTimeSlotId}, Force: ${isForce}`);

          const year = currentDay.getFullYear();
          const month = String(currentDay.getMonth() + 1).padStart(2, '0');
          const date = String(currentDay.getDate()).padStart(2, '0');
          const dayString = `${year}-${month}-${date}`;

          setIsSaving(true);
          try {
              const eventsToCreate = clipboardEvents.map(evt => {
                  const { _id, ...rest } = evt;
                  return {
                      ...rest,
                      day: dayString,
                      grade: targetGrade,
                      timeSlotId: targetTimeSlotId,
                      force: isForce // Pass force flag to backend
                  };
              });

              // Client-side conflict check (optional but good for UX before sending batch)
              if (!isForce) {
                  for (const evt of eventsToCreate) {
                      if (evt.roomId) {
                          const conflict = schedules.find(s => s.day === evt.day && s.timeSlotId === evt.timeSlotId && s.roomId === evt.roomId);
                          if (conflict) {
                              const msg = `Conflict: Room ${rooms.find(r=>r._id===evt.roomId)?.name} is booked.`;
                              setConfirmMessage(msg);
                              setPendingAction(() => () => handlePasteToCell(targetGrade, targetTimeSlotId, true));
                              setIsConfirmOpen(true);
                              return; 
                          }
                      }
                      if (evt.teacherId) {
                          const conflict = schedules.find(s => s.day === evt.day && s.timeSlotId === evt.timeSlotId && s.teacherId === evt.teacherId);
                          if (conflict) {
                              const msg = `Conflict: Teacher ${teachers.find(t=>t._id===evt.teacherId)?.name} is busy.`;
                              setConfirmMessage(msg);
                              setPendingAction(() => () => handlePasteToCell(targetGrade, targetTimeSlotId, true));
                              setIsConfirmOpen(true);
                              return;
                          }
                      }
                  }
              }

              const response = await fetch(`${API_URL}/events/batch`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(eventsToCreate)
              });

              if (!response.ok) {
                  const errData = await response.json();
                  throw new Error(errData.message || 'Failed to paste events');
              }
              
              fetchData();
              setClipboardEvents([]); 
          } catch (err) {
              console.error("Paste error", err);
              // Handle server-side conflict errors if batch fails (though we send force=true)
              const msg = err.message;
              if ((msg.toLowerCase().includes("room") || msg.toLowerCase().includes("teacher")) && !isForce) {
                   setConfirmMessage(msg);
                   setPendingAction(() => () => handlePasteToCell(targetGrade, targetTimeSlotId, true));
                   setIsConfirmOpen(true);
              } else {
                   alert("Error pasting events: " + err.message);
              }
          } finally {
              if (!isConfirmOpen) setIsSaving(false); // Only stop saving if not showing dialog
          }
      };
      const [isExportModalOpen, setExportModalOpen] = React.useState(false);
      const [exportWeek, setExportWeek] = React.useState('');
      const [exportDays, setExportDays] = React.useState({ Monday: false, Tuesday: false, Wednesday: false, Thursday: false, Friday: false });
      const [isExporting, setIsExporting] = React.useState(false);
      const [startWeek, setStartWeek] = React.useState('');
      const [endWeek, setEndWeek] = React.useState('');
            const [isPickingDate, setIsPickingDate] = React.useState(false);
            const [isLoadingData, setIsLoadingData] = React.useState(true);
                  const [isCopyModalOpen, setIsCopyModalOpen] = React.useState(false);
                  const [copyTargetDate, setCopyTargetDate] = React.useState(null);
                                    const [isCopyWeekModalOpen, setIsCopyWeekModalOpen] = React.useState(false);
                                    const [copyWeekTargetDate, setCopyWeekTargetDate] = React.useState(null);
                                                      const [isSubjectModalOpen, setIsSubjectModalOpen] = React.useState(false);
                                                      const [editingSubjects, setEditingSubjects] = React.useState([]);
                                                      const [newSubjectName, setNewSubjectName] = React.useState('');
                                                      const [newSubjectColor, setNewSubjectColor] = React.useState('#1976d2'); // Default color
                                                      const [newSubjectTeacher, setNewSubjectTeacher] = React.useState('');
                                                      const [isUsageModalOpen, setIsUsageModalOpen] = React.useState(false);
                                                      const [usageData, setUsageData] = React.useState({ subjectName: '', dates: [] });
                                                      
                                                      const [isTeacherModalOpen, setIsTeacherModalOpen] = React.useState(false);
                                                      const [editingTeachers, setEditingTeachers] = React.useState([]);
                                                      const [newTeacherName, setNewTeacherName] = React.useState('');
                                                      const [newTeacherEmail, setNewTeacherEmail] = React.useState('');
                                                      const [newTeacherRoom, setNewTeacherRoom] = React.useState('');
                                                      const [isTeacherUsageModalOpen, setIsTeacherUsageModalOpen] = React.useState(false);
                                                      const [teacherUsageData, setTeacherUsageData] = React.useState({ teacherName: '', dates: [] });

                                                      const [isRoomModalOpen, setIsRoomModalOpen] = React.useState(false);
                                                      const [editingRooms, setEditingRooms] = React.useState([]);
                                                      const [newRoomName, setNewRoomName] = React.useState('');
                                                      const [isRoomUsageModalOpen, setIsRoomUsageModalOpen] = React.useState(false);
                                                      const [roomUsageData, setRoomUsageData] = React.useState({ roomName: '', dates: [] });
                                                      const [exportSelection, setExportSelection] = React.useState('general');

                                                      const [isLessonCounterModalOpen, setIsLessonCounterModalOpen] = React.useState(false);
                                                      const [counterStartDate, setCounterStartDate] = React.useState('');
                                                      const [counterEndDate, setCounterEndDate] = React.useState('');
                                                      const [counterSelectedTeacher, setCounterSelectedTeacher] = React.useState('');
                                                      const [counterSelectedSubject, setCounterSelectedSubject] = React.useState('');
                                                      const [lessonCount, setLessonCount] = React.useState(0);

                                                      const [isSendMailModalOpen, setIsSendMailModalOpen] = React.useState(false);
                                                      const [mailTab, setMailTab] = React.useState(0);
                                                      const [emailBody, setEmailBody] = React.useState('');
                                                      const [emailRecipients, setEmailRecipients] = React.useState([]);
                                                      const [selectedRecipients, setSelectedRecipients] = React.useState({});
                                                      const [sendingMail, setSendingMail] = React.useState(false);

                                                      const [selectedTeacher, setSelectedTeacher] = React.useState('');
                                                      const [selectedGrade, setSelectedGrade] = React.useState('');
                                                            const [anchorEl, setAnchorEl] = React.useState(null);
                                                            const isMenuOpen = Boolean(anchorEl);
                                                            const isMobile = useMediaQuery(theme.breakpoints.down('md'));
                                                      
                                                            const handleMenuOpen = (event) => {                                                        setAnchorEl(event.currentTarget);
                                                      };

                                                      const handleMenuClose = () => {
                                                        setAnchorEl(null);
                                                      };

                                                      const handleOpenSendMailModal = () => {
                                                        fetch(`${API_URL}/email_text`)
                                                          .then(res => res.json())
                                                          .then(data => setEmailBody(data.text || ''))
                                                          .catch(err => console.error("Failed to fetch email text", err));
                                                        
                                                        const generalGroup = [{ id: 'all-teachers', name: 'All Teachers', email: allTeachersEmail, type: 'general' }];
                                                        
                                                        const teachersGroup = teachers
                                                            .filter(t => t.email && t.email.trim() !== '')
                                                            .map(t => ({ ...t, id: t._id, type: 'teacher' }));

                                                        const studentsGroup = grades.map(g => ({
                                                            id: `grade-${g}`,
                                                            name: `Grade ${g}`,
                                                            email: `g${g}@krumbach.school`,
                                                            type: 'student',
                                                            gradeNumber: g
                                                        }));

                                                        setEmailRecipients([...generalGroup, ...teachersGroup, ...studentsGroup]);
                                                        setSelectedRecipients({});
                                                        setMailTab(0);
                                                        setIsSendMailModalOpen(true);
                                                        handleMenuClose();
                                                      };
                                                      
                                                      const handleCloseMailModal = () => {
                                                        setIsSendMailModalOpen(false);
                                                        setSelectedRecipients({});
                                                        // emailBody is intentionally not cleared
                                                      };

                                                      const handleConfirmClose = () => {
                                                          setIsConfirmOpen(false);
                                                          setConfirmMessage('');
                                                          setPendingAction(null);
                                                      };

                                                      const handleConfirmAction = () => {
                                                          if (pendingAction) {
                                                              pendingAction();
                                                          }
                                                          handleConfirmClose();
                                                      };

                                                      const dateInputRef = React.useRef(null);
                                                      const draggedItem = React.useRef(null);
                                                      
                                                      // ROLE LOGIC
                                                      const isAdmin = user.role === 'admin';
                                                      const isEditor = ['admin', 'editor'].includes(user.role);
                                                      const isCounter = ['admin', 'editor', 'counter'].includes(user.role); // Can view all & count
                                                      
                                                      // Roles Modal State
                                                      const [isRolesModalOpen, setIsRolesModalOpen] = React.useState(false);
                                                      const [usersList, setUsersList] = React.useState([]);
                                                      const [newUserEmail, setNewUserEmail] = React.useState('');
                                                      const [newUserName, setNewUserName] = React.useState('');
                                                      const [newUserRole, setNewUserRole] = React.useState('viewer');
                                                      
                                                      // Settings Modal State
                                                      const [isSettingsModalOpen, setIsSettingsModalOpen] = React.useState(false);
                                                      const [allTeachersEmail, setAllTeachersEmail] = React.useState('teachers@krumbach.school'); // Default

                                                      const handleOpenRolesModal = () => {
                                                          fetch(`${API_URL}/users`)
                                                              .then(res => res.json())
                                                              .then(setUsersList)
                                                              .catch(err => console.error(err));
                                                          setIsRolesModalOpen(true);
                                                      };

                                                      const handleAddUser = () => {
                                                          if (!newUserEmail) return alert('Email is required');
                                                          fetch(`${API_URL}/users`, {
                                                              method: 'POST',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ email: newUserEmail, name: newUserName, role: newUserRole })
                                                          })
                                                          .then(async res => {
                                                              if (res.ok) {
                                                                  const newUser = await res.json();
                                                                  setUsersList([...usersList, newUser]);
                                                                  setNewUserEmail('');
                                                                  setNewUserName('');
                                                                  setNewUserRole('viewer');
                                                              } else {
                                                                  const err = await res.json();
                                                                  alert(err.message || 'Failed to add user');
                                                              }
                                                          });
                                                      };

                                                      const handleDeleteUser = (userId) => {
                                                          if (!confirm('Are you sure you want to delete this user?')) return;
                                                          fetch(`${API_URL}/users/${userId}`, { method: 'DELETE' })
                                                          .then(res => {
                                                              if (res.ok) {
                                                                  setUsersList(usersList.filter(u => u._id !== userId));
                                                              } else {
                                                                  alert('Failed to delete user');
                                                              }
                                                          });
                                                      };

                                                      const handleUpdateRole = (userId, newRole) => {
                                                          fetch(`${API_URL}/users/${userId}/role`, {
                                                              method: 'PUT',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ role: newRole })
                                                          })
                                                          .then(res => {
                                                              if (res.ok) {
                                                                  setUsersList(prev => prev.map(u => u._id === userId ? { ...u, role: newRole } : u));
                                                              } else {
                                                                  alert('Failed to update role');
                                                              }
                                                          });
                                                      };
                                                
                                                      // Calculate week boundaries for viewer role
                                                      const today = new Date();
                                                      const dayOfWeek = today.getDay();
                                                      const monday = new Date(today);
                                                      monday.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
                                                      monday.setHours(0, 0, 0, 0);
                                                
                                                      const friday = new Date(monday);
                                                      friday.setDate(monday.getDate() + 4);
                                                      friday.setHours(23, 59, 59, 999);
                                                
                                                      // DATA FETCHING
                                                      const fetchData = () => {
                                                        setIsLoadingData(true);
                                                        // Fetch config
                                                        fetch(`${API_URL}/config`)
                                                            .then(res => res.json())
                                                            .then(cfg => {
                                                                if (cfg.allTeachersEmail) setAllTeachersEmail(cfg.allTeachersEmail);
                                                            })
                                                            .catch(err => console.error("Failed to fetch config", err));

                                                        fetch(`${API_URL}/data`)
                                                          .then(res => res.json())
                                                          .then(d => {
                                                            // Sort subjects, teachers, and rooms by order to ensure consistent ordering
                                                            d.subjects.sort((a, b) => a.order - b.order);
                                                            d.teachers.sort((a, b) => a.order - b.order);
                                                            d.rooms.sort((a, b) => a.order - b.order);
                                                            setData(d);
                                                            setIsLoadingData(false);
                                                          })
                                                          .catch(err => {
                                                            console.error("Failed to fetch data", err);
                                                            setIsLoadingData(false);
                                                          });
                                                      };
                                                      React.useEffect(fetchData, []);
                                                
                                                      // EFFECTS
                                                      React.useEffect(() => {
                                                        if (isPickingDate) { dateInputRef.current?.focus(); }
                                                      }, [isPickingDate]);
                                                
                                                      React.useEffect(() => {
                                                        if (currentDay && !isNaN(currentDay)) { localStorage.setItem('lastViewedDate', currentDay.toISOString()); }
                                                      }, [currentDay]);
                                                      
                                                      React.useEffect(() => {
                                                        // Restrict view if not at least a "Counter" (Viewer only sees current week)
                                                        if (!isCounter) {
                                                          const realToday = new Date();
                                                          // If current day is outside the current real week, reset to today
                                                          if (currentDay < monday || currentDay > friday) {
                                                             setCurrentDay(realToday);
                                                          }
                                                        }
                                                      }, [isCounter]); // Run only when role changes

                                                      React.useEffect(() => {
                                                        if (!counterStartDate || !counterEndDate || !counterSelectedTeacher) {
                                                          setLessonCount(0);
                                                          return;
                                                        }

                                                        const start = new Date(counterStartDate);
                                                        const end = new Date(counterEndDate);

                                                        const filteredSchedules = schedules.filter(event => {
                                                          const eventDate = new Date(event.day);
                                                          const isDateInRange = eventDate >= start && eventDate <= end;
                                                          const isTeacherMatch = event.teacherId === counterSelectedTeacher;
                                                          const isSubjectMatch = !counterSelectedSubject || event.subjectId === counterSelectedSubject;
                                                          
                                                          return isDateInRange && isTeacherMatch && isSubjectMatch;
                                                        });

                                                        const uniqueLessons = new Set();
                                                        filteredSchedules.forEach(event => {
                                                          if (event.timeSlotId) { // Only count events with a valid time slot
                                                            const lessonKey = `${event.day}-${event.timeSlotId}`;
                                                            uniqueLessons.add(lessonKey);
                                                          }
                                                        });

                                                        setLessonCount(uniqueLessons.size);

                                                      }, [counterStartDate, counterEndDate, counterSelectedTeacher, counterSelectedSubject, schedules]);
                                                
                                                      // DATA CONSTANTS
                                                      const { schedules, teachers, subjects, rooms, grades } = data;
                                                      const timeSlots = [
                                                        { id: 1, time: '8:00 - 8:50' }, { id: 2, time: '9:00 - 9:50' }, { id: 3, time: '10:00 - 10:50' },
                                                        { id: 'snack', time: 'Snack' }, { id: 4, time: '11:00 - 11:50' }, { id: 5, time: '12:00 - 12:50' },
                                                        { id: 'lunch', time: '13:00 - 13:50' }, { id: 6, time: '14:00 - 14:50' }, { id: 7, time: '15:00 - 15:50' },
                                                        { id: 8, time: '16:00-16:50' }, { id: 9, time: '17:00-17:50' }, { id: 10, time: '17:50-19:00' },
                                                      ];
                                                      const darkGrayCellStyle = { border: '2px solid #000000', padding: '8px', textAlign: 'left', verticalAlign: 'top', backgroundColor: '#e0e0e0', height: '50px' };
                                                
                                                      // HELPER FUNCTIONS
                                                      const getWeekNumber = (d) => {
                                                        const schoolYearStartDate = new Date('2025-08-25T00:00:00Z');
                                                        let currentDayUTC = new Date(d.toISOString().split('T')[0] + 'T00:00:00Z');
                                                        if (currentDayUTC < schoolYearStartDate) return 1;
                                                        const holidays = [
                                                            { start: new Date('2025-10-18T00:00:00Z'), end: new Date('2025-11-02T23:59:59Z') }, { start: new Date('2025-12-20T00:00:00Z'), end: new Date('2026-01-07T23:59:59Z') },
                                                            { start: new Date('2026-01-31T00:00:00Z'), end: new Date('2026-02-08T23:59:59Z') }, { start: new Date('2026-03-28T00:00:00Z'), end: new Date('2026-04-12T23:59:59Z') },
                                                            { start: new Date('2026-06-20T00:00:00Z'), end: new Date('2026-08-23T23:59:59Z') },
                                                        ];
                                                        for (const period of holidays) { if (currentDayUTC >= period.start && currentDayUTC <= period.end) { return 'Holidays'; } }
                                                        let schoolDaysCount = 0;
                                                        let iterDate = new Date(schoolYearStartDate);
                                                        while(iterDate <= currentDayUTC) {
                                                            const dayOfWeek = iterDate.getUTCDay();
                                                            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                                                            let isHoliday = false;
                                                            if (!isWeekend) { for (const period of holidays) { if (iterDate >= period.start && iterDate <= period.end) { isHoliday = true; break; } } }
                                                            if (!isWeekend && !isHoliday) { schoolDaysCount++; }
                                                            iterDate.setUTCDate(iterDate.getUTCDate() + 1);
                                                        }
                                                        if (schoolDaysCount <= 0) return 1;
                                                        return Math.ceil(schoolDaysCount / 5);
                                                      };
                                                      const formatDate = (date) => {
                                                        const day = String(date.getDate()).padStart(2, '0');
                                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                                        const year = date.getFullYear();
                                                        return `${day}.${month}.${year}`;
                                                      };
                                                      const getEventsForCell = (grade, timeSlotId) => {
                                                          const year = currentDay.getFullYear();
                                                          const month = String(currentDay.getMonth() + 1).padStart(2, '0');
                                                          const date = String(currentDay.getDate()).padStart(2, '0');
                                                          const dayString = `${year}-${month}-${date}`;
                                                          let events = schedules.filter(event => event.day === dayString && event.grade === grade && event.timeSlotId === timeSlotId);
                                                          if (selectedTeacher) {
                                                            events = events.filter(event => event.teacherId === selectedTeacher);
                                                          }
                                                          if (selectedGrade) {
                                                            events = events.filter(event => event.grade === selectedGrade);
                                                          }
                                                          return events;
                                                      };
                                                      const dayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'long' });
                                                
                                                      // DRAG & DROP HANDLERS
                                                      const handleDragStart = (e, index) => {
                                                          draggedItem.current = index;
                                                          e.dataTransfer.effectAllowed = 'move';
                                                      };

                                                      const handleDragOver = (e) => {
                                                          e.preventDefault();
                                                      };

                                                      const handleDrop = (e, index, listType) => {
                                                          e.preventDefault();
                                                          const draggedIndex = draggedItem.current;
                                                          if (draggedIndex === null || draggedIndex === index) {
                                                              return;
                                                          }

                                                          let items;
                                                          let setItems;

                                                          if (listType === 'subjects') {
                                                              items = [...editingSubjects];
                                                              setItems = setEditingSubjects;
                                                          } else if (listType === 'teachers') {
                                                              items = [...editingTeachers];
                                                              setItems = setEditingTeachers;
                                                          } else if (listType === 'rooms') {
                                                              items = [...editingRooms];
                                                              setItems = setEditingRooms;
                                                          } else {
                                                              return; // Unknown list type
                                                          }

                                                          const [reorderedItem] = items.splice(draggedIndex, 1);
                                                          items.splice(index, 0, reorderedItem);
                                                          setItems(items);
                                                          draggedItem.current = null;
                                                      };
                                          
                                                      // MODAL & EVENT HANDLERS
                                                      const handleOpenModal = (event = null, cellContext = null) => {
                                                        if (!isEditor) return;
                                                        setFormErrors({});
                                                        setSubmitError('');
                                                        if (event) { 
                                                            setEditingEvent(event); 
                                                            setNewEvent({ ...event, grades: [event.grade], timeSlotIds: [event.timeSlotId] }); 
                                                        } 
                                                        else { 
                                                            setEditingEvent(null); 
                                                            // Initialize with cell context if provided
                                                            const initialGrade = cellContext?.grade || '';
                                                            const initialTimeSlotId = cellContext?.timeSlotId || '';
                                                            // If cellContext has day (string), use it? Currently we use currentDay from state.
                                                            // But let's stick to currentDay unless cellContext overrides it (which it might for future features)
                                                            
                                                            setNewEvent({ 
                                                                grade: initialGrade, 
                                                                grades: initialGrade ? [initialGrade] : [], 
                                                                timeSlotId: initialTimeSlotId, 
                                                                timeSlotIds: initialTimeSlotId ? [initialTimeSlotId] : [], 
                                                                subjectId: '', teacherId: '', roomId: '', 
                                                                color: '#ffffff', customSubject: '', customTeacher: '', customRoom: '' 
                                                            }); 
                                                        }
                                                        setModalOpen(true);
                                                      };

                                                      const handleCloseModal = () => { setEditingEvent(null); setModalOpen(false); };

                                                      const handleFormChange = (e) => { 
                                                        const { name, value } = e.target; 
                                                        const updatedEvent = { ...newEvent, [name]: value }; 
                                                        
                                                        if (name === 'subjectId') { 
                                                          const selectedSubject = subjects.find(s => s._id === value); 
                                                          if (selectedSubject) { 
                                                              updatedEvent.color = selectedSubject.color; 
                                                              
                                                              // Subject -> Teacher logic
                                                              if (selectedSubject.defaultTeacherId) {
                                                                  updatedEvent.teacherId = selectedSubject.defaultTeacherId;
                                                                  
                                                                  // Teacher -> Room chain
                                                                  const selectedTeacher = teachers.find(t => t._id === selectedSubject.defaultTeacherId);
                                                                  if (selectedTeacher && selectedTeacher.defaultRoomId) {
                                                                      updatedEvent.roomId = selectedTeacher.defaultRoomId;
                                                                  } else {
                                                                      updatedEvent.roomId = ''; // Clear room if new default teacher has none
                                                                  }
                                                              } else {
                                                                  // No default teacher for subject: clear both
                                                                  updatedEvent.teacherId = '';
                                                                  updatedEvent.roomId = '';
                                                              }
                                                          } 
                                                        }
                                                        
                                                        if (name === 'teacherId') {
                                                            const selectedTeacher = teachers.find(t => t._id === value);
                                                            if (selectedTeacher && selectedTeacher.defaultRoomId) {
                                                                updatedEvent.roomId = selectedTeacher.defaultRoomId;
                                                            } else {
                                                                // Clear room if teacher has no default
                                                                updatedEvent.roomId = '';
                                                            }
                                                        }

                                                        setNewEvent(updatedEvent); 
                                                      };

                                                      const handleSubmit = () => { if (editingEvent) { handleUpdate(false); } else { handleCreate(false); } };

                                                      const handleCreate = async (isForce = false) => {
                                                        setIsSaving(true);
                                                        setSubmitError('');
                                                        if (!isForce) setFormErrors({});
                                                        const gradesToProcess = newEvent.grades && newEvent.grades.length > 0 ? newEvent.grades : (newEvent.grade ? [newEvent.grade] : []);
                                                        const timeSlotsToProcess = newEvent.timeSlotIds && newEvent.timeSlotIds.length > 0 ? newEvent.timeSlotIds : (newEvent.timeSlotId ? [newEvent.timeSlotId] : []);
                                                        
                                                        if (gradesToProcess.length === 0) {
                                                            alert('Please select at least one grade.');
                                                            setIsSaving(false);
                                                            return;
                                                        }
                                                        if (timeSlotsToProcess.length === 0) {
                                                            alert('Please select at least one time slot.');
                                                            setIsSaving(false);
                                                            return;
                                                        }

                                                        const year = currentDay.getFullYear();
                                                        const month = String(currentDay.getMonth() + 1).padStart(2, '0');
                                                        const date = String(currentDay.getDate()).padStart(2, '0');
                                                        const dayString = `${year}-${month}-${date}`;
                                                        
                                                        let basePayload = { ...newEvent, day: dayString };
                                                        if (basePayload.customSubject) { basePayload.subjectId = null; }
                                                        if (basePayload.customTeacher) { basePayload.teacherId = null; }
                                                        if (basePayload.customRoom) { basePayload.roomId = null; }
                                                        if (basePayload.color === '#ffffff' && basePayload.subjectId) { 
                                                            const selectedSubject = subjects.find(s => s._id === basePayload.subjectId); 
                                                            if (selectedSubject) { basePayload.color = selectedSubject.color; } 
                                                        }
                                                        
                                                        if (isForce) {
                                                            basePayload.force = true;
                                                        }

                                                        try {
                                                            for (const grade of gradesToProcess) {
                                                                for (const timeSlotId of timeSlotsToProcess) {
                                                                    const payload = { ...basePayload, grade: grade, timeSlotId: timeSlotId };
                                                                    delete payload.grades; // Don't send the array
                                                                    delete payload.timeSlotIds; // Don't send the array
                                                                    
                                                                    // Pre-flight conflict check (optional, but good for UX)
                                                                    if (!isForce) {
                                                                        if (payload.roomId) {
                                                                            const conflictingEvent = schedules.find(event => event.day === payload.day && event.timeSlotId === payload.timeSlotId && event.roomId === payload.roomId);
                                                                            if (conflictingEvent) {
                                                                                const existingSubjectName = conflictingEvent.customSubject || subjects.find(s => s._id === conflictingEvent.subjectId)?.name;
                                                                                const newSubjectName = payload.customSubject || subjects.find(s => s._id === payload.subjectId)?.name;
                                                                    
                                                                                if (existingSubjectName !== newSubjectName) {
                                                                                    throw new Error(`Room conflict for Grade ${grade} at ${timeSlots.find(t => t.id === timeSlotId)?.time}: This room is already booked for this time slot with a different subject.`);
                                                                                }
                                                                            }
                                                                        }

                                                                        if (payload.teacherId) {
                                                                            const teacherConflictEvent = schedules.find(event => 
                                                                                event.day === payload.day && 
                                                                                event.timeSlotId === payload.timeSlotId && 
                                                                                event.teacherId === payload.teacherId
                                                                            );
                                                                            if (teacherConflictEvent) {
                                                                                const existingSubjectName = teacherConflictEvent.customSubject || subjects.find(s => s._id === teacherConflictEvent.subjectId)?.name;
                                                                                const newSubjectName = payload.customSubject || subjects.find(s => s._id === payload.subjectId)?.name;
                                                                                // Allow same teacher if subject is same (combined class)
                                                                                if (existingSubjectName !== newSubjectName) {
                                                                                    throw new Error(`Teacher conflict for Grade ${grade} at ${timeSlots.find(t => t.id === timeSlotId)?.time}: This teacher is already assigned to a different subject at this time.`);
                                                                                }
                                                                            }
                                                                        }
                                                                    }

                                                                    const res = await fetch(`${API_URL}/events`, { 
                                                                        method: 'POST', 
                                                                        headers: { 'Content-Type': 'application/json' }, 
                                                                        body: JSON.stringify(payload) 
                                                                    });

                                                                    if (!res.ok) {
                                                                        const err = await res.json();
                                                                        throw new Error(err.message || `An unexpected error occurred during creation for Grade ${grade} at ${timeSlots.find(t => t.id === timeSlotId)?.time}.`);
                                                                    }
                                                                }
                                                            }
                                                            
                                                            fetchData(); 
                                                            handleCloseModal();
                                                        } catch (err) {
                                                            console.error("Failed to save event", err);
                                                            const msg = err.message;
                                                            
                                                            const isConflict = msg.toLowerCase().includes("room") || msg.toLowerCase().includes("teacher") || msg.toLowerCase().includes("booked") || msg.toLowerCase().includes("assigned");
                                                            
                                                            if (isConflict && !isForce) {
                                                                setConfirmMessage(msg);
                                                                setPendingAction(() => () => handleCreate(true));
                                                                setIsConfirmOpen(true);
                                                                // Don't disable saving here, we are "done" with this attempt
                                                            } else {
                                                                setSubmitError(msg);
                                                                const errors = {};
                                                                if (msg.toLowerCase().includes("room")) errors.roomId = true;
                                                                if (msg.toLowerCase().includes("teacher")) errors.teacherId = true;
                                                                setFormErrors(errors);
                                                            }
                                                        } finally {
                                                            setIsSaving(false);
                                                        }
                                                      };

                                                      const handleUpdate = async (isForce = false) => {
                                                        setIsSaving(true);
                                                        setSubmitError('');
                                                        if (!isForce) setFormErrors({});
                                                        const gradesToProcess = newEvent.grades && newEvent.grades.length > 0 ? newEvent.grades : (newEvent.grade ? [newEvent.grade] : []);
                                                        const timeSlotsToProcess = newEvent.timeSlotIds && newEvent.timeSlotIds.length > 0 ? newEvent.timeSlotIds : (newEvent.timeSlotId ? [newEvent.timeSlotId] : []);
                                                        
                                                        if (gradesToProcess.length === 0) {
                                                            alert('Please select at least one grade.');
                                                            setIsSaving(false);
                                                            return;
                                                        }
                                                        if (timeSlotsToProcess.length === 0) {
                                                            alert('Please select at least one time slot.');
                                                            setIsSaving(false);
                                                            return;
                                                        }

                                                        const { _id, ...basePayload } = newEvent;
                                                        if (basePayload.customSubject) { basePayload.subjectId = null; }
                                                        if (basePayload.customTeacher) { basePayload.teacherId = null; }
                                                        if (basePayload.customRoom) { basePayload.roomId = null; }
                                                        
                                                        if (isForce) {
                                                            basePayload.force = true;
                                                        }

                                                        try {
                                                            // 1. Update the existing event with the FIRST combination in the list
                                                            const firstGrade = gradesToProcess[0];
                                                            const firstTimeSlotId = timeSlotsToProcess[0];
                                                            const updatePayload = { ...basePayload, grade: firstGrade, timeSlotId: firstTimeSlotId };
                                                            delete updatePayload.grades;
                                                            delete updatePayload.timeSlotIds;

                                                            // Conflict Checks (for Update)
                                                            if (!isForce) {
                                                                if (updatePayload.roomId) {
                                                                    const conflictingEvent = schedules.find(event => event.day === updatePayload.day && event.timeSlotId === updatePayload.timeSlotId && event.roomId === updatePayload.roomId && event._id !== editingEvent._id);
                                                                    if (conflictingEvent) {
                                                                        const existingSubjectName = conflictingEvent.customSubject || subjects.find(s => s._id === conflictingEvent.subjectId)?.name;
                                                                        const newSubjectName = updatePayload.customSubject || subjects.find(s => s._id === updatePayload.subjectId)?.name;
                                                                        if (existingSubjectName !== newSubjectName) {
                                                                            throw new Error('This room is already booked for this time slot with a different subject.');
                                                                        }
                                                                    }
                                                                }
                                                                if (updatePayload.teacherId) {
                                                                    const teacherConflictEvent = schedules.find(event => 
                                                                        event.day === updatePayload.day && 
                                                                        event.timeSlotId === updatePayload.timeSlotId && 
                                                                        event.teacherId === updatePayload.teacherId &&
                                                                        event._id !== editingEvent._id
                                                                    );
                                                                    if (teacherConflictEvent) {
                                                                        const existingSubjectName = teacherConflictEvent.customSubject || subjects.find(s => s._id === teacherConflictEvent.subjectId)?.name;
                                                                        const newSubjectName = updatePayload.customSubject || subjects.find(s => s._id === updatePayload.subjectId)?.name;
                                                                        if (existingSubjectName !== newSubjectName) {
                                                                            throw new Error('This teacher is already assigned to a different subject at this time.');
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            const updateRes = await fetch(`${API_URL}/events/${editingEvent._id}`, { 
                                                                method: 'PUT', 
                                                                headers: { 'Content-Type': 'application/json' }, 
                                                                body: JSON.stringify(updatePayload) 
                                                            });

                                                            if (!updateRes.ok) {
                                                                const err = await updateRes.json();
                                                                throw new Error(err.message || 'An unexpected error occurred during update.');
                                                            }

                                                            // 2. Create NEW events for any ADDITIONAL combinations
                                                            const allCombinations = [];
                                                            for (const grade of gradesToProcess) {
                                                                for (const timeSlotId of timeSlotsToProcess) {
                                                                    // Skip the first combination as it was already used for update
                                                                    if (grade === firstGrade && timeSlotId === firstTimeSlotId) continue;
                                                                    allCombinations.push({ grade, timeSlotId });
                                                                }
                                                            }

                                                            for (const combo of allCombinations) {
                                                                const createPayload = { ...basePayload, grade: combo.grade, timeSlotId: combo.timeSlotId };
                                                                delete createPayload.grades;
                                                                delete createPayload.timeSlotIds;
                                                                
                                                                const createRes = await fetch(`${API_URL}/events`, { 
                                                                    method: 'POST', 
                                                                    headers: { 'Content-Type': 'application/json' }, 
                                                                    body: JSON.stringify(createPayload) 
                                                                });
                                                                
                                                                if (!createRes.ok) {
                                                                    const err = await createRes.json();
                                                                    throw new Error(err.message || `Failed to create additional event for Grade ${combo.grade} at ${timeSlots.find(t => t.id === combo.timeSlotId)?.time}`);
                                                                }
                                                            }

                                                            fetchData(); 
                                                            handleCloseModal();

                                                        } catch (err) {
                                                            console.error("Failed to update event", err);
                                                            const msg = err.message;

                                                            const isConflict = msg.toLowerCase().includes("room") || msg.toLowerCase().includes("teacher") || msg.toLowerCase().includes("booked") || msg.toLowerCase().includes("assigned");
                                                            
                                                            if (isConflict && !isForce) {
                                                                setConfirmMessage(msg);
                                                                setPendingAction(() => () => handleUpdate(true));
                                                                setIsConfirmOpen(true);
                                                                // Don't need to disable saving, as finally block will handle it
                                                            } else {
                                                                setSubmitError(msg);
                                                                const errors = {};
                                                                if (msg.toLowerCase().includes("room")) errors.roomId = true;
                                                                if (msg.toLowerCase().includes("teacher")) errors.teacherId = true;
                                                                setFormErrors(errors);
                                                            }
                                                        } finally {
                                                            setIsSaving(false);
                                                        }
                                                      };

                                                      const handleDelete = () => {
                                                        if (editingEvent) {
                                                          fetch(`${API_URL}/events/${editingEvent._id}`, { method: 'DELETE' })
                                                          .then(() => { fetchData(); handleCloseModal(); }).catch(err => console.error("Failed to delete event", err));
                                                        }
                                                      };

                                                      const handlePrevDay = () => { const newDay = new Date(currentDay); newDay.setDate(newDay.getDate() - 1); setCurrentDay(newDay); };
                                                      const handleNextDay = () => { const newDay = new Date(currentDay); newDay.setDate(newDay.getDate() + 1); setCurrentDay(newDay); };
                                                      const handlePrevWeek = () => { const newDay = new Date(currentDay); newDay.setDate(newDay.getDate() - 7); setCurrentDay(newDay); };
                                                      const handleNextWeek = () => { const newDay = new Date(currentDay); newDay.setDate(newDay.getDate() + 7); setCurrentDay(newDay); };
                                                      const getAllWeeks = () => { return Array.from({ length: 40 }, (_, i) => i + 1); };
                                                      const handleWeekChange = (e) => { const weekNumber = e.target.value; const schoolYearStartDate = new Date('2025-08-25T00:00:00Z'); const newDate = new Date(schoolYearStartDate.setDate(schoolYearStartDate.getDate() + (weekNumber - 1) * 7)); setCurrentDay(newDate); setInitialDay(newDate); };
                                                      
                                                      const generatePDF = async (isForEmail = false, teacherName = null, grade = null, container = document) => {
                                                        const { jsPDF } = window.jspdf;
                                                        const pdf = new jsPDF('landscape', 'pt', 'a4');
                                                        
                                                        let tableId;
                                                        if (teacherName) {
                                                          tableId = '#teacher-schedule-table';
                                                        } else if (grade) {
                                                          tableId = '#grade-schedule-table';
                                                        } else {
                                                          tableId = '#schedule-table';
                                                        }

                                                        const table = container.querySelector(tableId);
                                                        if (!table) {
                                                          const errorMsg = `Could not find table: ${tableId}`;
                                                          console.error(errorMsg);
                                                          if (!isForEmail) alert(errorMsg);
                                                          return Promise.reject(errorMsg);
                                                        }

                                                        const style = document.createElement('style');
                                                        style.innerHTML = `.export-style th, .export-style td { border: 1px solid #000 !important; }`;
                                                        document.head.appendChild(style);
                                                        table.classList.add('export-style');

                                                        const canvas = await html2canvas(table, { scale: 1 });
                                                        const imgData = canvas.toDataURL('image/jpeg', 0.8);
                                                        
                                                        table.classList.remove('export-style');
                                                        document.head.removeChild(style);

                                                        const pdfWidth = pdf.internal.pageSize.getWidth();
                                                        const canvasWidth = canvas.width;
                                                        const canvasHeight = canvas.height;
                                                        const ratio = canvasWidth / canvasHeight;
                                                        const imgWidth = pdfWidth - 80;
                                                        const imgHeight = imgWidth / ratio;

                                                        const monday = new Date(currentDay);
                                                        while (monday.getDay() !== 1) {
                                                          monday.setDate(monday.getDate() - 1);
                                                        }
                                                        const friday = new Date(monday);
                                                        friday.setDate(monday.getDate() + 4);
                                                        const dateRange = `(${formatDate(monday)} - ${formatDate(friday)})`;

                                                        let dateText = `Schedule for Week ${getWeekNumber(currentDay)} ${dateRange}`;
                                                        if (teacherName) {
                                                          dateText = `Schedule for ${teacherName} - Week ${getWeekNumber(currentDay)} ${dateRange}`;
                                                        } else if (grade) {
                                                          dateText = `Schedule for Grade ${grade} - Week ${getWeekNumber(currentDay)} ${dateRange}`;
                                                        }
                                                        
                                                        pdf.setFontSize(12);
                                                        pdf.text(dateText, 40, 30);
                                                        pdf.addImage(imgData, 'PNG', 40, 40, imgWidth, imgHeight);

                                                        if (isForEmail) {
                                                          return pdf.output('datauristring');
                                                        } else {
                                                          let fileName = `schedule-W_${getWeekNumber(currentDay)}.pdf`;
                                                          if (teacherName) {
                                                            fileName = `schedule-T_${teacherName.replace(/\s/g, '_')}-W_${getWeekNumber(currentDay)}.pdf`;
                                                          } else if (grade) {
                                                            fileName = `schedule-G_${grade}-W_${getWeekNumber(currentDay)}.pdf`;
                                                          }
                                                          pdf.save(fileName);
                                                        }
                                                      };

                                                      const generateWeeklyPDF = async (isForEmail = false) => {
                                                        const { jsPDF } = window.jspdf;
                                                        const pdf = new jsPDF('landscape', 'pt', 'a4');
                                                        const pdfContainer = document.getElementById('pdf-container');

                                                        const monday = new Date(currentDay);
                                                        while (monday.getDay() !== 1) {
                                                          monday.setDate(monday.getDate() - 1);
                                                        }
                                                        monday.setHours(0, 0, 0, 0);

                                                        const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

                                                        for (let i = 0; i < weekDays.length; i++) {
                                                          const dayToRender = new Date(monday);
                                                          dayToRender.setDate(monday.getDate() + i);

                                                          const componentToRender = (
                                                            <SingleDayView
                                                              day={dayToRender}
                                                              schedules={schedules}
                                                              subjects={subjects}
                                                              teachers={teachers}
                                                              rooms={rooms}
                                                              grades={grades}
                                                              timeSlots={timeSlots}
                                                              handleOpenModal={handleOpenModal}
                                                              isEditor={isEditor}
                                                              darkGrayCellStyle={darkGrayCellStyle}
                                                            />
                                                          );

                                                          await new Promise(resolve => {
                                                            ReactDOM.render(componentToRender, pdfContainer, async () => {
                                                              const table = pdfContainer.querySelector('#single-day-table');
                                                              if (!table) {
                                                                console.error(`Could not find table for ${weekDays[i]}`);
                                                                resolve();
                                                                return;
                                                              }

                                                              const style = document.createElement('style');
                                                              style.innerHTML = `.export-style th, .export-style td { border: 1px solid #000 !important; }`;
                                                              document.head.appendChild(style);
                                                              table.classList.add('export-style');

                                                              const canvas = await html2canvas(table, { scale: 1 });
                                                              const imgData = canvas.toDataURL('image/jpeg', 0.8);
                                                              
                                                              table.classList.remove('export-style');
                                                              document.head.removeChild(style);

                                                              if (i > 0) {
                                                                pdf.addPage();
                                                              }

                                                              const pdfWidth = pdf.internal.pageSize.getWidth();
                                                              const canvasWidth = canvas.width;
                                                              const canvasHeight = canvas.height;
                                                              const ratio = canvasWidth / canvasHeight;
                                                              const imgWidth = pdfWidth - 80;
                                                              const imgHeight = imgWidth / ratio;

                                                              const dateText = `${weekDays[i]} - ${formatDate(dayToRender)}`;
                                                              pdf.setFontSize(12);
                                                              pdf.text(dateText, 40, 30);
                                                              pdf.addImage(imgData, 'PNG', 40, 40, imgWidth, imgHeight);
                                                              
                                                              resolve();
                                                            });
                                                          });
                                                        }

                                                        ReactDOM.unmountComponentAtNode(pdfContainer);

                                                        if (isForEmail) {
                                                          return pdf.output('datauristring');
                                                        } else {
                                                          const fileName = `schedule-Weekly-W_${getWeekNumber(currentDay)}.pdf`;
                                                          pdf.save(fileName);
                                                        }
                                                      };

                                                      // EXPORT HANDLERS
                                                      const handleOpenExportModal = () => { 
                                                        const currentWeek = getWeekNumber(currentDay); 
                                                        setExportWeek(currentWeek === 'Holidays' ? 1 : currentWeek); 
                                                        setExportSelection('general'); // Default to general
                                                        setExportDays({ Monday: false, Tuesday: false, Wednesday: false, Thursday: false, Friday: false });
                                                        setExportModalOpen(true); 
                                                      };
                                                      const handleCloseExportModal = () => { setExportModalOpen(false); setExportWeek(''); setExportDays({ Monday: false, Tuesday: false, Wednesday: false, Thursday: false, Friday: false }); };
                                                      const handleExportWeekChange = (e) => { setExportWeek(e.target.value); };
                                                      const handleExportDayChange = (e) => { setExportDays({ ...exportDays, [e.target.name]: e.target.checked }); };
                                                      const handleToggleAllExportDays = () => {
                                                        const areAllSelected = Object.values(exportDays).every(day => day === true);
                                                        if (areAllSelected) {
                                                          setExportDays({ Monday: false, Tuesday: false, Wednesday: false, Thursday: false, Friday: false });
                                                        } else {
                                                          setExportDays({ Monday: true, Tuesday: true, Wednesday: true, Thursday: true, Friday: true });
                                                        }
                                                      };
                                                      const handleExport = async () => {
                                                        setIsExporting(true);
                                                        
                                                        const allDaysSelected = Object.values(exportDays).every(day => day === true);

                                                        if (exportSelection === 'general' && allDaysSelected) {
                                                          // New weekly export logic
                                                          await generateWeeklyPDF(false);
                                                        } else {
                                                          // Existing logic for single day / teacher / grade
                                                          let teacherName = null;
                                                          let grade = null;

                                                          if (exportSelection.startsWith('grade-')) {
                                                            grade = parseInt(exportSelection.split('-')[1]);
                                                          } else if (exportSelection !== 'general') {
                                                            const teacher = teachers.find(t => t._id === exportSelection);
                                                            if (teacher) teacherName = teacher.name;
                                                          }
                                                          
                                                          // This requires the correct view to be rendered
                                                          // For teacher/grade, we need to render them off-screen
                                                          const pdfContainer = document.getElementById('pdf-container');
                                                          let componentToRender;
                                                          if (teacherName) {
                                                            const teacher = teachers.find(t => t.name === teacherName);
                                                            componentToRender = <TeacherScheduleView teacher={teacher} schedules={schedules} subjects={subjects} rooms={rooms} timeSlots={timeSlots} currentDay={currentDay} grades={grades} handleOpenModal={() => {}} isEditor={isEditor} />;
                                                          } else if (grade) {
                                                            componentToRender = <GradeScheduleView grade={grade} schedules={schedules} subjects={subjects} teachers={teachers} rooms={rooms} timeSlots={timeSlots} currentDay={currentDay} handleOpenModal={() => {}} isEditor={isEditor} />;
                                                          } else {
                                                            // General single day export
                                                            componentToRender = <SingleDayView day={currentDay} schedules={schedules} subjects={subjects} teachers={teachers} rooms={rooms} grades={grades} timeSlots={timeSlots} handleOpenModal={() => {}} isEditor={isEditor} darkGrayCellStyle={darkGrayCellStyle} />;
                                                          }

                                                          await new Promise(resolve => {
                                                            ReactDOM.render(componentToRender, pdfContainer, async () => {
                                                              await generatePDF(false, teacherName, grade, pdfContainer);
                                                              ReactDOM.unmountComponentAtNode(pdfContainer);
                                                              resolve();
                                                            });
                                                          });
                                                        }
                                                        
                                                        setIsExporting(false);
                                                        handleCloseExportModal();
                                                      };

                                                      // COPY/PASTE HANDLERS
                                                      const handleOpenCopyModal = () => { if (isEditor) setIsCopyModalOpen(true); };
                                                      const handleCloseCopyModal = () => { setIsCopyModalOpen(false); setCopyTargetDate(null); };
                                                      const handlePasteDay = async () => {
                                                        if (!copyTargetDate) { alert('Please select a target date.'); return; }
                                                        
                                                        const sourceYear = currentDay.getFullYear();
                                                        const sourceMonth = String(currentDay.getMonth() + 1).padStart(2, '0');
                                                        const sourceDate = String(currentDay.getDate()).padStart(2, '0');
                                                        const sourceDayString = `${sourceYear}-${sourceMonth}-${sourceDate}`;

                                                        const targetYear = copyTargetDate.getFullYear();
                                                        const targetMonth = String(copyTargetDate.getMonth() + 1).padStart(2, '0');
                                                        const targetDate = String(copyTargetDate.getDate()).padStart(2, '0');
                                                        const targetDayString = `${targetYear}-${targetMonth}-${targetDate}`;
                                                        
                                                        const eventsToCopy = schedules.filter(event => event.day === sourceDayString);
                                                        
                                                        if (eventsToCopy.length === 0) { 
                                                          alert('There is nothing to copy from the selected day.'); 
                                                          handleCloseCopyModal(); 
                                                          return; 
                                                        }

                                                        try {
                                                          // First, delete all events on the target day
                                                          const deleteResponse = await fetch(`${API_URL}/schedules/by-day`, {
                                                            method: 'DELETE',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ day: targetDayString })
                                                          });

                                                          if (!deleteResponse.ok) {
                                                            const errorData = await deleteResponse.json();
                                                            throw new Error(errorData.message || 'Failed to clear target day.');
                                                          }

                                                          // Then, create the new events
                                                          const newEvents = eventsToCopy.map(({ _id, ...event }) => ({ ...event, day: targetDayString }));
                                                          const createResponse = await fetch(`${API_URL}/events/batch`, { 
                                                            method: 'POST', 
                                                            headers: { 'Content-Type': 'application/json' }, 
                                                            body: JSON.stringify(newEvents) 
                                                          });

                                                          if (!createResponse.ok) { 
                                                            throw new Error('Failed to paste schedule.'); 
                                                          }
                                                          
                                                          fetchData(); 
                                                          alert(`Successfully replaced schedule on ${formatDate(copyTargetDate)} with schedule from ${formatDate(currentDay)}.`);
                                                          handleCloseCopyModal(); 
                                                          setCurrentDay(copyTargetDate);
                                                        } catch (err) { 
                                                          console.error("Failed to paste schedule", err); 
                                                          alert(`An error occurred while pasting the schedule: ${err.message}`); 
                                                        }
                                                      };
                                                      
                                                      const handleCleanDay = async () => {
                                                        if (!isEditor) return;
                                                        const year = currentDay.getFullYear();
                                                        const month = String(currentDay.getMonth() + 1).padStart(2, '0');
                                                        const date = String(currentDay.getDate()).padStart(2, '0');
                                                        const dayString = `${year}-${month}-${date}`;
                                                        if (confirm(`Are you sure you want to delete all events for ${formatDate(currentDay)}? This cannot be undone.`)) {
                                                          try {
                                                            const response = await fetch(`${API_URL}/schedules/by-day`, {
                                                              method: 'DELETE',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ day: dayString })
                                                            });
                                                            if (!response.ok) {
                                                              const errorData = await response.json();
                                                              throw new Error(errorData.message || 'Failed to clear the day.');
                                                            }
                                                            fetchData();
                                                            alert(`Successfully cleared all events for ${formatDate(currentDay)}.`);
                                                          } catch (err) {
                                                            console.error("Failed to clean day:", err);
                                                            alert(`An error occurred while cleaning the day: ${err.message}`);
                                                          }
                                                        }
                                                      };

                                                      const handleOpenCopyWeekModal = () => { if (isEditor) setIsCopyWeekModalOpen(true); };
                                                      const handleCloseCopyWeekModal = () => { setIsCopyWeekModalOpen(false); setCopyWeekTargetDate(null); };
                                                      const handlePasteWeek = async () => {
                                                                          if (!copyWeekTargetDate) {
                                                                              alert('Please select a target date.');
                                                                              return;
                                                                          }
                                                                  
                                                                          const sourceDay = new Date(currentDay);
                                                                          const sourceDayOfWeek = sourceDay.getDay();
                                                                          const mondayOfSourceWeek = new Date(sourceDay);
                                                                          mondayOfSourceWeek.setDate(sourceDay.getDate() - sourceDayOfWeek + (sourceDayOfWeek === 0 ? -6 : 1));
                                                                  
                                                                          const targetDayOfWeek = copyWeekTargetDate.getDay();
                                                                          const mondayOfTargetWeek = new Date(copyWeekTargetDate);
                                                                          mondayOfTargetWeek.setDate(copyWeekTargetDate.getDate() - targetDayOfWeek + (targetDayOfWeek === 0 ? -6 : 1));
                                                                  
                                                                          let eventsToCreate = [];
                                                                          for (let i = 0; i < 5; i++) { // Loop from Monday to Friday
                                                                              const sourceDate = new Date(mondayOfSourceWeek);
                                                                              sourceDate.setDate(mondayOfSourceWeek.getDate() + i);
                                                                              const sourceYear = sourceDate.getFullYear();
                                                                              const sourceMonth = String(sourceDate.getMonth() + 1).padStart(2, '0');
                                                                              const sourceDay = String(sourceDate.getDate()).padStart(2, '0');
                                                                              const sourceDateString = `${sourceYear}-${sourceMonth}-${sourceDay}`;
                                                                  
                                                                              const eventsForSourceDay = schedules.filter(event => event.day === sourceDateString);
                                                                              
                                                                              if (eventsForSourceDay.length > 0) {
                                                                                  const targetDate = new Date(mondayOfTargetWeek);
                                                                                  targetDate.setDate(mondayOfTargetWeek.getDate() + i);
                                                                                  const targetYear = targetDate.getFullYear();
                                                                                  const targetMonth = String(targetDate.getMonth() + 1).padStart(2, '0');
                                                                                  const targetDay = String(targetDate.getDate()).padStart(2, '0');
                                                                                  const targetDateString = `${targetYear}-${targetMonth}-${targetDay}`;

                                                                                  const newEventsForTargetDay = eventsForSourceDay.map(({ _id, ...event }) => ({
                                                                                      ...event,
                                                                                      day: targetDateString
                                                                                  }));
                                                                                  eventsToCreate = [...eventsToCreate, ...newEventsForTargetDay];
                                                                              }
                                                                          }
                                                                  
                                                                          if (eventsToCreate.length === 0) {
                                                                              alert('There is nothing to copy from the selected week.');
                                                                              handleCloseCopyWeekModal();
                                                                              return;
                                                                          }
                                                                  
                                                                          try {
                                                                              // First, delete all events for the entire target week
                                                                              const deletePromises = [];
                                                                              for (let i = 0; i < 5; i++) {
                                                                                  const targetDate = new Date(mondayOfTargetWeek);
                                                                                  targetDate.setDate(mondayOfTargetWeek.getDate() + i);
                                                                                  const targetYear = targetDate.getFullYear();
                                                                                  const targetMonth = String(targetDate.getMonth() + 1).padStart(2, '0');
                                                                                  const targetDay = String(targetDate.getDate()).padStart(2, '0');
                                                                                  const targetDateString = `${targetYear}-${targetMonth}-${targetDay}`;
                                                                                  deletePromises.push(
                                                                                      fetch(`${API_URL}/schedules/by-day`, {
                                                                                          method: 'DELETE',
                                                                                          headers: { 'Content-Type': 'application/json' },
                                                                                          body: JSON.stringify({ day: targetDateString })
                                                                                      })
                                                                                  );
                                                                              }
                                                                              
                                                                              const deleteResponses = await Promise.all(deletePromises);
                                                                              for (const res of deleteResponses) {
                                                                                  if (!res.ok) {
                                                                                      const errorData = await res.json();
                                                                                      throw new Error(errorData.message || 'Failed to clear target week.');
                                                                                  }
                                                                              }

                                                                              // Then, create the new events
                                                                              const createResponse = await fetch(`${API_URL}/events/batch`, {
                                                                                  method: 'POST',
                                                                                  headers: { 'Content-Type': 'application/json' },
                                                                                  body: JSON.stringify(eventsToCreate)
                                                                              });
                                                                              if (!createResponse.ok) { throw new Error('Failed to paste week schedule.'); }
                                                                              
                                                                              fetchData();
                                                                              alert(`Successfully replaced schedule in the week of ${formatDate(mondayOfTargetWeek)} with schedule from the week of ${formatDate(mondayOfSourceWeek)}.`);
                                                                              handleCloseCopyWeekModal();
                                                                              setCurrentDay(mondayOfTargetWeek);
                                                                          } catch (err) {
                                                                              console.error("Failed to paste week schedule", err);
                                                                              alert(`An error occurred while pasting the week schedule: ${err.message}`);
                                                                          }
                                                                        };

                                                      // SUBJECT HANDLERS
                                                      const handleOpenUsageModal = (subjectId) => {
                                                        const subject = subjects.find(s => s._id === subjectId);
                                                        if (!subject) return;
                                                    
                                                        const usageDates = schedules
                                                          .filter(s => s.subjectId === subjectId)
                                                          .map(s => s.day)
                                                          .filter((day, index, self) => self.indexOf(day) === index) // Unique days
                                                          .sort((a, b) => new Date(a) - new Date(b))
                                                          .map(dayString => {
                                                            const date = new Date(dayString + 'T12:00:00'); // Use T12 to avoid timezone issues
                                                            return {
                                                              raw: dayString,
                                                              formatted: formatDate(date)
                                                            };
                                                          });
                                                    
                                                        setUsageData({ subjectName: subject.name, dates: usageDates });
                                                        setIsUsageModalOpen(true);
                                                      };

                                                      const handleCloseUsageModal = () => {
                                                        setIsUsageModalOpen(false);
                                                        setUsageData({ subjectName: '', dates: [] });
                                                      };

                                                      const handleDeleteUsagesForDay = async (subjectId, day) => {
                                                        if (!subjectId || !day) return;
                                                        
                                                        try {
                                                          const response = await fetch(`${API_URL}/schedules/by-subject-and-day`, {
                                                            method: 'DELETE',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ subjectId, day })
                                                          });
                                                    
                                                          if (!response.ok) {
                                                            const errorData = await response.json();
                                                            throw new Error(errorData.message || 'Failed to delete schedule entries.');
                                                          }
                                                    
                                                          // Refresh data to reflect the deletion
                                                          fetchData(); 
                                                    
                                                          // After deletion, re-evaluate the usage for the modal
                                                          handleOpenUsageModal(subjectId);
                                                          
                                                          // Also refresh the editing subjects list in case a subject becomes deletable
                                                          const updatedEditingSubjects = JSON.parse(JSON.stringify(subjects.map(s => ({...s, isUsed: schedules.some(sc => sc.subjectId === s.id && !(sc.subjectId === subjectId && sc.day === day))}))) );
                                                          setEditingSubjects(updatedEditingSubjects);


                                                        } catch (error) {
                                                          console.error("Error deleting usages for day:", error);
                                                          alert(`An error occurred: ${error.message}`);
                                                        }
                                                      };

                                                      const handleOpenSubjectModal = () => {
                                                        setEditingSubjects(JSON.parse(JSON.stringify(subjects))); // Deep copy
                                                        setIsSubjectModalOpen(true);
                                                      };
                                                      const handleCloseSubjectModal = () => {
                                                        setIsSubjectModalOpen(false);
                                                        setEditingSubjects([]);
                                                        setNewSubjectName('');
                                                        setNewSubjectColor('#1976d2');
                                                      };
                                                      const handleSaveSubjects = async () => {
                                                        const originalSubjects = subjects;
                                                        const changes = [];

                                                        // Identify deletions
                                                        const editingIds = new Set(editingSubjects.map(s => s._id));
                                                        originalSubjects.forEach(original => {
                                                          if (original._id && !editingIds.has(original._id)) {
                                                            changes.push(fetch(`${API_URL}/subjects/${original._id}`, {
                                                              method: 'DELETE'
                                                            }));
                                                          }
                                                        });
                                                    
                                                        // Identify new and updated subjects
                                                        editingSubjects.forEach((subject, index) => {
                                                          if (!subject._id) {
                                                            // New subject
                                                            changes.push(fetch(`${API_URL}/subjects`, {
                                                              method: 'POST',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ name: subject.name, color: subject.color, order: index, defaultTeacherId: subject.defaultTeacherId })
                                                            }));
                                                          } else {
                                                            // Existing subject, check for changes
                                                            const original = originalSubjects.find(s => s._id === subject._id);
                                                            if (original && (original.name !== subject.name || original.color !== subject.color || original.order !== index || original.defaultTeacherId !== subject.defaultTeacherId)) {
                                                              changes.push(fetch(`${API_URL}/subjects/${subject._id}`, {
                                                                method: 'PUT',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ name: subject.name, color: subject.color, order: index, defaultTeacherId: subject.defaultTeacherId })
                                                              }));
                                                            }
                                                          }
                                                        });
                                                        if (changes.length === 0) {
                                                          alert('No changes were made.');
                                                          handleCloseSubjectModal();
                                                          return;
                                                        }
                                                    
                                                        try {
                                                          const responses = await Promise.all(changes);
                                                          for (const res of responses) {
                                                            if (!res.ok) {
                                                              const errorText = await res.text();
                                                              throw new Error(`Server responded with: ${errorText || res.status}`);
                                                            }
                                                          }
                                                          fetchData(); // Refresh data in main app
                                                          handleCloseSubjectModal();
                                                          alert('Subjects saved successfully!');
                                                        } catch (error) {
                                                          console.error("Failed to save subjects:", error);
                                                          alert(`An error occurred while saving subjects: ${error.message}`);
                                                        }
                                                      };

                                                      // TEACHER HANDLERS
                                                      const handleOpenTeacherModal = () => {
                                                        setEditingTeachers(JSON.parse(JSON.stringify(teachers))); // Deep copy
                                                        setIsTeacherModalOpen(true);
                                                      };

                                                      const handleCloseTeacherModal = () => {
                                                        setIsTeacherModalOpen(false);
                                                        setEditingTeachers([]);
                                                        setNewTeacherName('');
                                                      };

                                                      const handleSaveTeachers = async () => {
                                                        const originalTeachers = teachers;
                                                        const changes = [];

                                                        const editingIds = new Set(editingTeachers.map(t => t._id));
                                                        originalTeachers.forEach(original => {
                                                          if (original._id && !editingIds.has(original._id)) {
                                                            changes.push(fetch(`${API_URL}/teachers/${original._id}`, { method: 'DELETE' }));
                                                          }
                                                        });

                                                        editingTeachers.forEach((teacher, index) => {
                                                          if (!teacher._id) { // New teacher
                                                            changes.push(fetch(`${API_URL}/teachers`, {
                                                              method: 'POST',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ name: teacher.name, order: index, email: teacher.email, defaultRoomId: teacher.defaultRoomId })
                                                            }));
                                                          } else { // Existing teacher
                                                            const original = originalTeachers.find(t => t._id === teacher._id);
                                                            if (original && (original.name !== teacher.name || original.order !== index || original.email !== teacher.email || original.defaultRoomId !== teacher.defaultRoomId)) {
                                                              changes.push(fetch(`${API_URL}/teachers/${teacher._id}`, {
                                                                method: 'PUT',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ name: teacher.name, order: index, email: teacher.email, defaultRoomId: teacher.defaultRoomId })
                                                              }));
                                                            }
                                                          }
                                                        });

                                                        if (changes.length === 0) {
                                                          alert('No changes were made.');
                                                          handleCloseTeacherModal();
                                                          return;
                                                        }

                                                        try {
                                                          const responses = await Promise.all(changes);
                                                          for (const res of responses) {
                                                            if (!res.ok) {
                                                              const errorText = await res.text();
                                                              throw new Error(`Server responded with: ${errorText || res.status}`);
                                                            }
                                                          }
                                                          fetchData();
                                                          handleCloseTeacherModal();
                                                          alert('Teachers saved successfully!');
                                                        } catch (error) {
                                                          console.error("Failed to save teachers:", error);
                                                          alert(`An error occurred while saving teachers: ${error.message}`);
                                                        }
                                                      };

                                                      const handleOpenTeacherUsageModal = (teacherId) => {
                                                        const teacher = teachers.find(t => t._id === teacherId);
                                                        if (!teacher) return;

                                                        const usageDates = schedules
                                                          .filter(s => s.teacherId === teacherId)
                                                          .map(s => s.day)
                                                          .filter((day, index, self) => self.indexOf(day) === index)
                                                          .sort((a, b) => new Date(a) - new Date(b))
                                                          .map(dayString => ({
                                                            raw: dayString,
                                                            formatted: formatDate(new Date(dayString + 'T12:00:00'))
                                                          }));
                                                        
                                                        setTeacherUsageData({ teacherName: teacher.name, dates: usageDates });
                                                        setIsTeacherUsageModalOpen(true);
                                                      };

                                                      const handleCloseTeacherUsageModal = () => {
                                                        setIsTeacherUsageModalOpen(false);
                                                        setTeacherUsageData({ teacherName: '', dates: [] });
                                                      };

                                                      const handleDeleteTeacherUsagesForDay = async (teacherId, day) => {
                                                        if (!teacherId || !day) return;
                                                        try {
                                                          const response = await fetch(`${API_URL}/schedules/by-teacher-and-day`, {
                                                            method: 'DELETE',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ teacherId, day })
                                                          });
                                                          if (!response.ok) throw new Error(await response.text());
                                                          fetchData();
                                                          handleOpenTeacherUsageModal(teacherId);
                                                        } catch (error) {
                                                          console.error("Error deleting teacher usages for day:", error);
                                                          alert(`An error occurred: ${error.message}`);
                                                        }
                                                      };

                                                      // ROOM HANDLERS
                                                      const handleOpenRoomModal = () => {
                                                        setEditingRooms(JSON.parse(JSON.stringify(rooms)));
                                                        setIsRoomModalOpen(true);
                                                      };

                                                      const handleCloseRoomModal = () => {
                                                        setIsRoomModalOpen(false);
                                                        setEditingRooms([]);
                                                        setNewRoomName('');
                                                      };

                                                      const handleSaveRooms = async () => {
                                                        const originalRooms = rooms;
                                                        const changes = [];

                                                        const editingIds = new Set(editingRooms.map(r => r._id));
                                                        originalRooms.forEach(original => {
                                                          if (original._id && !editingIds.has(original._id)) {
                                                            changes.push(fetch(`${API_URL}/rooms/${original._id}`, { method: 'DELETE' }));
                                                          }
                                                        });

                                                        editingRooms.forEach((room, index) => {
                                                          if (!room._id) { // New room
                                                            changes.push(fetch(`${API_URL}/rooms`, {
                                                              method: 'POST',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ name: room.name, order: index })
                                                            }));
                                                          } else { // Existing room
                                                            const original = originalRooms.find(r => r._id === room._id);
                                                            if (original && (original.name !== room.name || original.order !== index)) {
                                                              changes.push(fetch(`${API_URL}/rooms/${room._id}`, {
                                                                method: 'PUT',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ name: room.name, order: index })
                                                              }));
                                                            }
                                                          }
                                                        });

                                                        if (changes.length === 0) {
                                                          alert('No changes were made.');
                                                          handleCloseRoomModal();
                                                          return;
                                                        }

                                                        try {
                                                          const responses = await Promise.all(changes);
                                                          for (const res of responses) {
                                                            if (!res.ok) {
                                                              const errorText = await res.text();
                                                              throw new Error(`Server responded with: ${errorText || res.status}`);
                                                            }
                                                          }
                                                          fetchData();
                                                          handleCloseRoomModal();
                                                          alert('Rooms saved successfully!');
                                                        } catch (error) {
                                                          console.error("Failed to save rooms:", error);
                                                          alert(`An error occurred while saving rooms: ${error.message}`);
                                                        }
                                                      };

                                                      const handleOpenRoomUsageModal = (roomId) => {
                                                        const room = rooms.find(r => r._id === roomId);
                                                        if (!room) return;

                                                        const usageDates = schedules
                                                          .filter(s => s.roomId === roomId)
                                                          .map(s => s.day)
                                                          .filter((day, index, self) => self.indexOf(day) === index)
                                                          .sort((a, b) => new Date(a) - new Date(b))
                                                          .map(dayString => ({
                                                            raw: dayString,
                                                            formatted: formatDate(new Date(dayString + 'T12:00:00'))
                                                          }));
                                                        
                                                        setRoomUsageData({ roomName: room.name, dates: usageDates });
                                                        setIsRoomUsageModalOpen(true);
                                                      };

                                                      const handleCloseRoomUsageModal = () => {
                                                        setIsRoomUsageModalOpen(false);
                                                        setRoomUsageData({ roomName: '', dates: [] });
                                                      };

                                                      const handleDeleteRoomUsagesForDay = async (roomId, day) => {
                                                        if (!roomId || !day) return;
                                                        try {
                                                          const response = await fetch(`${API_URL}/schedules/by-room-and-day`, {
                                                            method: 'DELETE',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ roomId, day })
                                                          });
                                                          if (!response.ok) throw new Error(await response.text());
                                                          fetchData();
                                                          handleOpenRoomUsageModal(roomId);
                                                        } catch (error) {
                                                          console.error("Error deleting room usages for day:", error);
                                                          alert(`An error occurred: ${error.message}`);
                                                        }
                                                      };
                                                      
                                                      const handleSendMail = async () => {
                                                        const recipients = Object.entries(selectedRecipients)
                                                          .filter(([, isSelected]) => isSelected)
                                                          .map(([id]) => emailRecipients.find(r => r.id === id));

                                                        if (!emailBody.trim()) {
                                                          alert('Email body cannot be empty.');
                                                          return;
                                                        }
                                                        if (recipients.length === 0) {
                                                          alert('Please select at least one recipient.');
                                                          return;
                                                        }

                                                        setSendingMail(true);

                                                        const monday = new Date(currentDay);
                                                        while (monday.getDay() !== 1) {
                                                          monday.setDate(monday.getDate() - 1);
                                                        }
                                                        monday.setHours(0, 0, 0, 0);

                                                        const friday = new Date(monday);
                                                        friday.setDate(monday.getDate() + 4);
                                                        friday.setHours(23, 59, 59, 999);

                                                        const dateRangeFormatted = `(${formatDate(monday)}-${formatDate(friday)})`;
                                                        const weekNumber = getWeekNumber(currentDay);

                                                        for (const recipient of recipients) {
                                                            try {
                                                                console.log(`Processing email for: ${recipient.name} (${recipient.email}) [Type: ${recipient.type}]`);
                                                                const pdfContainer = document.getElementById('pdf-container');
                                                                let pdfDataUri = null;
                                                                let fileName = '';
                                                                let subject = `SKIS Week ${weekNumber} Schedule ${dateRangeFormatted}`;

                                                                if (recipient.type === 'general') {
                                                                    // General Schedule
                                                                    pdfDataUri = await generateWeeklyPDF(true);
                                                                    fileName = `SKIS_Week_${weekNumber}_Schedule_${dateRangeFormatted}.pdf`;
                                                                } 
                                                                else if (recipient.type === 'teacher') {
                                                                    // Teacher Schedule
                                                                    const teacher = teachers.find(t => t._id === recipient.id);
                                                                    if (!teacher) {
                                                                        console.warn(`Teacher not found: ${recipient.id}`);
                                                                        continue;
                                                                    }
                                                                    const componentToRender = <TeacherScheduleView teacher={teacher} schedules={schedules} subjects={subjects} rooms={rooms} timeSlots={timeSlots} currentDay={currentDay} grades={grades} handleOpenModal={() => {}} isEditor={isEditor} />;
                                                                    
                                                                    pdfDataUri = await new Promise(res => ReactDOM.render(componentToRender, pdfContainer, () => res(generatePDF(true, teacher.name, null, pdfContainer))));
                                                                    ReactDOM.unmountComponentAtNode(pdfContainer);
                                                                    fileName = `SKIS_Week_${weekNumber}_${recipient.name.replace(/\s/g, '_')}_Schedule_${dateRangeFormatted}.pdf`;
                                                                } 
                                                                else if (recipient.type === 'student') {
                                                                    // Student Schedule (Grade)
                                                                    const grade = recipient.gradeNumber;
                                                                    const componentToRender = <GradeScheduleView grade={grade} schedules={schedules} subjects={subjects} teachers={teachers} rooms={rooms} timeSlots={timeSlots} currentDay={currentDay} handleOpenModal={() => {}} isEditor={isEditor} />;
                                                                    
                                                                    pdfDataUri = await new Promise(res => ReactDOM.render(componentToRender, pdfContainer, () => res(generatePDF(true, null, grade, pdfContainer))));
                                                                    ReactDOM.unmountComponentAtNode(pdfContainer);
                                                                    fileName = `SKIS_Week_${weekNumber}_Grade_${grade}_Schedule_${dateRangeFormatted}.pdf`;
                                                                }

                                                                if (!pdfDataUri) throw new Error('PDF generation failed.');

                                                                const response = await fetch(`${API_URL}/send-schedule`, {
                                                                    method: 'POST',
                                                                    headers: { 'Content-Type': 'application/json' },
                                                                    body: JSON.stringify({ emailBody, recipient, subject, fileName, pdfDataUri })
                                                                });
                                                                
                                                                if (!response.ok) throw new Error((await response.json()).message || 'Failed to send email');
                                                                console.log(`Email sent to ${recipient.name}`);

                                                            } catch (err) {
                                                                console.error(`Error sending to ${recipient.name}:`, err);
                                                                alert(`Error sending to ${recipient.name}: ${err.message}`);
                                                            }
                                                        }
                                                        
                                                        setSendingMail(false);
                                                        alert('Finished sending emails.');
                                                        handleCloseMailModal();
                                                      };

                                                      // RENDER

      // ===================================================================================
      // SINGLE DAY VIEW COMPONENT (for PDF generation)
      // ===================================================================================
      const SingleDayView = ({ day, schedules, subjects, teachers, rooms, grades, timeSlots, handleOpenModal, isEditor, darkGrayCellStyle }) => {
        const getEventsForDay = (grade, timeSlotId) => {
          const year = day.getFullYear();
          const month = String(day.getMonth() + 1).padStart(2, '0');
          const date = String(day.getDate()).padStart(2, '0');
          const dayString = `${year}-${month}-${date}`;
          return schedules.filter(event => event.day === dayString && event.grade === grade && event.timeSlotId === timeSlotId);
        };

        return (
          <Box id="single-day-table">
            <table style={{ borderCollapse: 'collapse', width: '100%', tableLayout: 'fixed', minWidth: '1800px' }}>
              <thead>
                <tr>
                  <th style={{...darkGrayCellStyle, width: '120px', whiteSpace: 'nowrap'}}>Time</th>
                  {grades.map(grade => <th key={grade} style={{...darkGrayCellStyle, textAlign: 'center', width: '280px'}}>{`Grade ${grade}`}</th>)}
                </tr>
              </thead>
              <tbody>
                {timeSlots.map(timeSlot => {
                  const isSpecialRow = ['snack', 'lunch', 10].includes(timeSlot.id);
                  const rowStyle = { backgroundColor: isSpecialRow ? '#e0e0e0' : 'inherit' };
                  return (
                    <tr key={timeSlot.id}>
                      <td style={{...darkGrayCellStyle, ...rowStyle, width: '120px', whiteSpace: 'nowrap'}}>{timeSlot.time}</td>
                      {grades.map(grade => {
                        const events = getEventsForDay(grade, timeSlot.id);
                        let cellContent;
                        if (events.length > 1) {
                          cellContent = (
                            <Box sx={{ display: 'flex', gap: '4px', width: '100%', height: '100%' }}>
                              {events.map(event => {
                                const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s._id === event.subjectId);
                                const teacher = event.customTeacher ? { name: event.customTeacher } : teachers.find(t => t._id === event.teacherId);
                                const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r._id === event.roomId);
                                const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                return (
                                  <Box key={event._id} sx={{ flex: 1, backgroundColor: eventColor, color: 'white', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', cursor: isEditor ? 'pointer' : 'default', whiteSpace: 'normal', wordBreak: 'break-word' }} onClick={() => handleOpenModal(event)}>
                                    <Typography variant="body1"><b>{subject ? subject.name : 'Event'}</b></Typography>
                                    <Typography variant="body2">{teacher ? teacher.name : 'N/A'} / {room ? room.name : 'N/A'}</Typography>
                                  </Box>
                                );
                              })}
                            </Box>
                          );
                        } else if (events.length === 1) {
                          const event = events[0];
                          const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s._id === event.subjectId);
                          const teacher = event.customTeacher ? { name: event.customTeacher } : teachers.find(t => t._id === event.teacherId);
                          const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r._id === event.roomId);
                          const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                          cellContent = (
                            <Box key={event._id} sx={{ backgroundColor: eventColor, color: 'white', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', cursor: isEditor ? 'pointer' : 'default', whiteSpace: 'normal', wordBreak: 'break-word' }} onClick={() => handleOpenModal(event)}>
                              <Typography variant="body1"><b>{subject ? subject.name : 'Event'}</b></Typography>
                              <Typography variant="body2">{teacher ? teacher.name : 'N/A'} / {room ? room.name : 'N/A'}</Typography>
                            </Box>
                          );
                        } else {
                          if (timeSlot.id === 'snack') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Snack</Typography>; }
                          else if (timeSlot.id === 'lunch') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Lunchbreak</Typography>; }
                          else if (timeSlot.id === 10) { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Homework Time</Typography>; }
                        }
                        return (<td key={`${grade}-${timeSlot.id}`} style={{...darkGrayCellStyle, ...rowStyle}}>{cellContent}</td>);
                      })}
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </Box>
        );
      };

      // ===================================================================================
      // TEACHER SCHEDULE VIEW COMPONENT
      // ===================================================================================
      const TeacherScheduleView = ({ teacher, schedules, subjects, timeSlots, currentDay, grades, handleOpenModal, isEditor }) => {
        if (!teacher || !currentDay || isNaN(currentDay.getTime())) {
          return null; // or a loading spinner
        }

        const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        
        // Get Monday of the current week
        const monday = new Date(currentDay);
        while (monday.getDay() !== 1) {
          monday.setDate(monday.getDate() - 1);
        }
        monday.setHours(0, 0, 0, 0);

        const weekDateStrings = weekDays.map((_, index) => {
          const day = new Date(monday);
          day.setDate(monday.getDate() + index);
          
          const year = day.getFullYear();
          const month = String(day.getMonth() + 1).padStart(2, '0');
          const date = String(day.getDate()).padStart(2, '0');
          
          return `${year}-${month}-${date}`;
        });

        const teacherSchedules = schedules.filter(event => 
          event.teacherId === teacher._id && weekDateStrings.includes(event.day)
        );

        return (
          <Box id="teacher-schedule-table">
            <table style={{ borderCollapse: 'collapse', width: '100%', tableLayout: 'fixed', minWidth: '1800px' }}>
              <thead>
                <tr>
                  <th style={{...darkGrayCellStyle, width: '120px'}}>Time</th>
                  {weekDays.map((day, index) => (
                    <th key={day} style={{...darkGrayCellStyle, textAlign: 'center'}}>
                      {day}<br/>{formatDate(new Date(weekDateStrings[index] + 'T12:00:00'))}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {timeSlots.map(timeSlot => {
                  const isSpecialRow = ['snack', 'lunch', 10].includes(timeSlot.id);
                  const rowStyle = { backgroundColor: isSpecialRow ? '#e0e0e0' : 'inherit' };
                  return (
                    <tr key={timeSlot.id}>
                      <td style={{...darkGrayCellStyle, ...rowStyle}}>{timeSlot.time}</td>
                      {weekDateStrings.map(dayString => {
                        const events = teacherSchedules.filter(e => e.day === dayString && e.timeSlotId === timeSlot.id);
                        
                        let cellContent = null;
                        if (events.length > 0) {
                          cellContent = (
                            <Box sx={{ display: 'flex', gap: '4px', width: '100%', height: '100%' }}>
                              {events.map(event => {
                                const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s._id === event.subjectId);
                                const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r._id === event.roomId);
                                const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                return (
                                  <Box key={event._id} sx={{ flex: 1, backgroundColor: eventColor, color: 'white', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', cursor: isEditor ? 'pointer' : 'default', whiteSpace: 'normal', wordBreak: 'break-word' }} onClick={() => handleOpenModal(event)}>
                                    <Typography variant="body1"><b>{subject ? `${subject.name} (Grade ${event.grade})` : `Event (Grade ${event.grade})`}</b></Typography>
                                    <Typography variant="body2">{room ? room.name : 'N/A'}</Typography>
                                  </Box>
                                );
                              })}
                            </Box>
                          );
                        } else {
                          if (timeSlot.id === 'snack') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Snack</Typography>; }
                          else if (timeSlot.id === 'lunch') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Lunchbreak</Typography>; }
                          else if (timeSlot.id === 10) { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Homework Time</Typography>; }
                        }

                        return (
                          <td key={`${dayString}-${timeSlot.id}`} style={{...darkGrayCellStyle, ...rowStyle}}>
                            {cellContent}
                          </td>
                        );
                      })}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </Box>
        );
      };

      // ===================================================================================
      // GRADE SCHEDULE VIEW COMPONENT
      // ===================================================================================
      const GradeScheduleView = ({ grade, schedules, subjects, teachers, rooms, timeSlots, currentDay, handleOpenModal, isEditor }) => {
        if (!grade || !currentDay || isNaN(currentDay.getTime())) {
          return null; // or a loading spinner
        }

        const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        
        // Get Monday of the current week
        const monday = new Date(currentDay);
        while (monday.getDay() !== 1) {
          monday.setDate(monday.getDate() - 1);
        }
        monday.setHours(0, 0, 0, 0);

        const weekDateStrings = weekDays.map((_, index) => {
          const day = new Date(monday);
          day.setDate(monday.getDate() + index);
          
          const year = day.getFullYear();
          const month = String(day.getMonth() + 1).padStart(2, '0');
          const date = String(day.getDate()).padStart(2, '0');
          
          return `${year}-${month}-${date}`;
        });

        const gradeSchedules = schedules.filter(event => 
          event.grade === grade && weekDateStrings.includes(event.day)
        );

        return (
          <Box id="grade-schedule-table">
            <table style={{ borderCollapse: 'collapse', width: '100%', tableLayout: 'fixed', minWidth: '1800px' }}>
              <thead>
                <tr>
                  <th style={{...darkGrayCellStyle, width: '120px'}}>Time</th>
                  {weekDays.map((day, index) => (
                    <th key={day} style={{...darkGrayCellStyle, textAlign: 'center'}}>
                      {day}<br/>{formatDate(new Date(weekDateStrings[index] + 'T12:00:00'))}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {timeSlots.map(timeSlot => {
                  const isSpecialRow = ['snack', 'lunch', 10].includes(timeSlot.id);
                  const rowStyle = { backgroundColor: isSpecialRow ? '#e0e0e0' : 'inherit' };
                  return (
                    <tr key={timeSlot.id}>
                      <td style={{...darkGrayCellStyle, ...rowStyle}}>{timeSlot.time}</td>
                      {weekDateStrings.map(dayString => {
                        const events = gradeSchedules.filter(e => e.day === dayString && e.timeSlotId === timeSlot.id);
                        
                        let cellContent = null;
                        if (events.length > 0) {
                          cellContent = (
                            <Box sx={{ display: 'flex', gap: '4px', width: '100%', height: '100%' }}>
                              {events.map(event => {
                                const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s._id === event.subjectId);
                                const teacher = event.customTeacher ? { name: event.customTeacher } : teachers.find(t => t._id === event.teacherId);
                                const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r._id === event.roomId);
                                const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                return (
                                  <Box key={event._id} sx={{ flex: 1, backgroundColor: eventColor, color: 'white', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', cursor: isEditor ? 'pointer' : 'default', whiteSpace: 'normal', wordBreak: 'break-word' }} onClick={() => handleOpenModal(event)}>
                                    <Typography variant="body1"><b>{subject ? `${subject.name} (${teacher ? teacher.name : 'N/A'})` : `Event (${teacher ? teacher.name : 'N/A'})`}</b></Typography>
                                    <Typography variant="body2">{room ? room.name : 'N/A'}</Typography>
                                  </Box>
                                );
                              })}
                            </Box>
                          );
                        } else {
                          if (timeSlot.id === 'snack') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Snack</Typography>; }
                          else if (timeSlot.id === 'lunch') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Lunchbreak</Typography>; }
                          else if (timeSlot.id === 10) { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Homework Time</Typography>; }
                        }

                        return (
                          <td key={`${dayString}-${timeSlot.id}`} style={{...darkGrayCellStyle, ...rowStyle}}>
                            {cellContent}
                          </td>
                        );
                      })}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </Box>
        );
      };


      return (
        <ThemeProvider theme={theme}>
          <CssBaseline />
           <AppBar position="static" sx={{ backgroundColor: '#EF333F' }}>
            <Toolbar>
              <Box component="div" sx={{ flexGrow: isEditor ? 1 : 0, mr: 2 }}>
                <img src="v3-2.png" alt="Schloss Krumbach Timetable" style={{ height: '40px', verticalAlign: 'middle', border: '2px solid white', borderRadius: '4px' }} />
              </Box>

              {!isEditor && (
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', flexGrow: 1, color: 'white' }}>
                    <IconButton onClick={handlePrevDay} color="inherit" disabled={currentDay <= monday}><Icon>arrow_back_ios</Icon></IconButton>
                    <Typography variant={isMobile ? "subtitle1" : "h6"} sx={{ p: 1, whiteSpace: 'nowrap' }}>
                      {`${dayFormatter.format(currentDay)} - ${formatDate(currentDay)}`}
                    </Typography>
                    <IconButton onClick={handleNextDay} color="inherit" disabled={currentDay >= friday}><Icon>arrow_forward_ios</Icon></IconButton>
                </Box>
              )}

              {isCounter && (
                <>
                  <Button
                    id="menu-button"
                    aria-controls={isMenuOpen ? 'basic-menu' : undefined}
                    aria-haspopup="true"
                    aria-expanded={isMenuOpen ? 'true' : undefined}
                    onClick={handleMenuOpen}
                    variant="contained"
                    color="primary"
                    sx={{ mr: 1 }}
                  >
                    MENU
                  </Button>
                  <Menu
                    id="basic-menu"
                    anchorEl={anchorEl}
                    open={isMenuOpen}
                    onClose={handleMenuClose}
                    MenuListProps={{
                      'aria-labelledby': 'menu-button',
                    }}
                  >
                    {isEditor && <MenuItem onClick={() => { handleOpenCopyModal(); handleMenuClose(); }}>Copy Day</MenuItem>}
                    {isEditor && <MenuItem onClick={() => { handleCleanDay(); handleMenuClose(); }}>Clean Day</MenuItem>}
                    {isEditor && <MenuItem onClick={() => { handleOpenCopyWeekModal(); handleMenuClose(); }}>Copy Week</MenuItem>}
                    {isEditor && <MenuItem onClick={() => { handleOpenSubjectModal(); handleMenuClose(); }}>Edit Subjects</MenuItem>}
                    {isEditor && <MenuItem onClick={() => { handleOpenTeacherModal(); handleMenuClose(); }}>Edit Teachers</MenuItem>}
                    {isEditor && <MenuItem onClick={() => { handleOpenRoomModal(); handleMenuClose(); }}>Edit Rooms</MenuItem>}
                    {isAdmin && <MenuItem onClick={() => { handleOpenRolesModal(); handleMenuClose(); }}>Edit Roles</MenuItem>}
                    {isAdmin && <MenuItem onClick={() => { setIsSettingsModalOpen(true); handleMenuClose(); }}>Settings</MenuItem>}
                    <MenuItem onClick={() => { setIsLessonCounterModalOpen(true); handleMenuClose(); }}>Lesson Counter</MenuItem>
                    <MenuItem onClick={() => { handleOpenExportModal(); handleMenuClose(); }}>Export to PDF</MenuItem>
                  </Menu>
                  {isEditor && <Button variant="contained" color="primary" sx={{ mr: 2 }} onClick={handleOpenSendMailModal}>Send Mail</Button>}
                  {isEditor && <Button variant="contained" color="primary" sx={{ mr: 2 }} onClick={() => handleOpenModal()} disabled={isLoadingData}>Add Event</Button>}
                </>
              )}

              <Button variant="outlined" color="inherit" onClick={onLogout}>Logout</Button>
            </Toolbar>
          </AppBar>
          <Container style={{ marginTop: '2rem', display: 'flex', flexDirection: 'column', alignItems: 'center' }} sx={{ pb: 8 }}>
            {isEditor ? (
              <>
                {/* Full controls for editor */}
                <Box sx={{ display: 'flex', flexDirection: isMobile ? 'column' : 'row', alignItems: 'center', justifyContent: 'center', mb: 2, gap: isMobile ? 2 : 0 }}>
                    <FormControl sx={{ minWidth: 120, width: isMobile ? '100%' : 'auto' }}>
                      <InputLabel id="week-select-label" sx={{ fontSize: '1.2rem' }}>Week</InputLabel>
                      <Select labelId="week-select-label" value={getWeekNumber(currentDay)} label="Week" onChange={handleWeekChange} sx={{ fontWeight: 'bold' }}>
                        {getAllWeeks().map(week => (<MenuItem key={week} value={week} sx={{ textAlign: 'center' }}>{week}</MenuItem>))}
                      </Select>
                    </FormControl>
                    <FormControl sx={{ minWidth: 150, ml: isMobile ? 0 : 2, width: isMobile ? '100%' : 'auto', backgroundColor: 'white', borderRadius: '4px' }}>
                      <InputLabel id="teacher-filter-label">Filter by Teacher</InputLabel>
                      <Select
                        labelId="teacher-filter-label"
                        id="teacher-filter"
                        value={selectedTeacher}
                        label="Filter by Teacher"
                        onChange={(e) => {
                          setSelectedTeacher(e.target.value);
                          setSelectedGrade(''); // Reset grade filter
                        }}
                      >
                        <MenuItem value="">
                          <em>All Teachers</em>
                        </MenuItem>
                        {teachers.map(teacher => (
                          teacher && <MenuItem key={teacher._id} value={teacher._id}>{teacher.name}</MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                    <FormControl sx={{ minWidth: 150, ml: isMobile ? 0 : 2, width: isMobile ? '100%' : 'auto', backgroundColor: 'white', borderRadius: '4px' }}>
                      <InputLabel id="grade-filter-label">Filter by Grade</InputLabel>
                      <Select
                        labelId="grade-filter-label"
                        id="grade-filter"
                        value={selectedGrade}
                        label="Filter by Grade"
                        onChange={(e) => {
                          setSelectedGrade(e.target.value);
                          setSelectedTeacher(''); // Reset teacher filter
                        }}
                      >
                        <MenuItem value="">
                          <em>All Grades</em>
                        </MenuItem>
                        {grades.map(grade => (
                          <MenuItem key={grade} value={grade}>{`Grade ${grade}`}</MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                </Box>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', mb: 2 }}>
                    <IconButton onClick={handlePrevDay}><Icon>arrow_back_ios</Icon></IconButton>
                    {isPickingDate ? (
                        <input type="date" ref={dateInputRef} style={{ fontSize: isMobile ? '1.2rem' : '1.5rem', border: '1px solid #ccc', borderRadius: '4px', maxWidth: '160px' }}
                          value={currentDay.toISOString().split('T')[0]}
                          onChange={(e) => {
                            if (e.target.value) { const selectedDate = new Date(e.target.value + 'T12:00:00'); setCurrentDay(selectedDate); setInitialDay(selectedDate); }
                            setIsPickingDate(false);
                          }}
                          onBlur={() => setIsPickingDate(false)}
                        />
                    ) : (
                        <Typography variant={isMobile ? "h6" : "h5"} onClick={() => setIsPickingDate(true)} sx={{ cursor: 'pointer', p: 1, '&:hover': { textDecoration: 'underline' }, textAlign: 'center' }}>
                          {selectedTeacher || selectedGrade ? `Week of ${formatDate(currentDay)}` : `${dayFormatter.format(currentDay)} - ${formatDate(currentDay)}`}
                        </Typography>
                    )}
                    <IconButton onClick={handleNextDay}><Icon>arrow_forward_ios</Icon></IconButton>
                </Box>
              </>
            ) : null}
            {selectedTeacher ? (
              <TeacherScheduleView 
                teacher={teachers.find(t => t && t._id === selectedTeacher)}
                schedules={schedules}
                subjects={subjects}
                timeSlots={timeSlots}
                currentDay={currentDay}
                grades={grades}
                handleOpenModal={handleOpenModal}
                isEditor={isEditor}
              />
            ) : selectedGrade ? (
              <GradeScheduleView
                grade={selectedGrade}
                schedules={schedules}
                subjects={subjects}
                teachers={teachers}
                rooms={rooms}
                timeSlots={timeSlots}
                currentDay={currentDay}
                handleOpenModal={handleOpenModal}
                isEditor={isEditor}
              />
            ) : (
              <Box id="schedule-table">
                <table style={{ borderCollapse: 'collapse', width: '100%', tableLayout: 'fixed', minWidth: '1800px' }}>
                  <thead>
                    <tr>
                      <th style={{...darkGrayCellStyle, width: '120px', whiteSpace: 'nowrap'}}>Time</th>
                      {grades.map(grade => <th key={grade} style={{...darkGrayCellStyle, textAlign: 'center', width: '280px'}}>{`Grade ${grade}`}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {timeSlots.map(timeSlot => {
                      const isSpecialRow = ['snack', 'lunch', 10].includes(timeSlot.id);
                      const rowStyle = { backgroundColor: isSpecialRow ? '#e0e0e0' : 'inherit' };
                      return (
                          <tr key={timeSlot.id}>
                          <td style={{...darkGrayCellStyle, ...rowStyle, width: '120px', whiteSpace: 'nowrap'}}>{timeSlot.time}</td>
                          {grades.map(grade => {
                              const events = getEventsForCell(grade, timeSlot.id);
                              let cellContent;

                              if (events.length > 1) {
                                  // If multiple events, wrap them in a flexbox container
                                  cellContent = (
                                      <Box sx={{ display: 'flex', gap: '4px', width: '100%', height: '100%' }}>
                                          {events.map(event => {
                                              const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s._id === event.subjectId);
                                              const teacher = event.customTeacher ? { name: event.customTeacher } : teachers.find(t => t._id === event.teacherId);
                                              const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r._id === event.roomId);
                                              const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                              return (
                                                  <Box 
                                                    key={event._id} 
                                                    sx={{ 
                                                        flex: 1, 
                                                        backgroundColor: eventColor, 
                                                        color: 'white', 
                                                        padding: '4px 8px', 
                                                        borderRadius: '4px', 
                                                        fontSize: '0.8rem', 
                                                        cursor: isEditor ? 'pointer' : 'default', 
                                                        whiteSpace: 'normal', 
                                                        wordBreak: 'break-word', 
                                                        position: 'relative', 
                                                        border: selectedEventIds.includes(event._id) ? '3px solid #1976d2' : 'none',
                                                        boxShadow: selectedEventIds.includes(event._id) ? '0 0 5px rgba(25, 118, 210, 0.8)' : 'none',
                                                        '&:hover .event-actions': { opacity: 1 }
                                                    }} 
                                                    onClick={() => handleOpenModal(event)}
                                                  >
                                                      {isEditor && (
                                                          <Box className="event-actions" sx={{ position: 'absolute', top: 0, right: 0, opacity: selectedEventIds.includes(event._id) ? 1 : 0, transition: 'opacity 0.2s', display: 'flex', bgcolor: 'rgba(255,255,255,0.9)', borderRadius: '0 4px 0 4px' }}>
                                                              <IconButton
                                                                  size="small"
                                                                  onClick={(e) => handleCopySingle(e, event)}
                                                                  sx={{ color: '#1976d2', padding: '2px' }}
                                                                  title="Copy"
                                                              >
                                                                  <Icon fontSize="small" sx={{ fontSize: '1rem' }}>content_copy</Icon>
                                                              </IconButton>
                                                              <Checkbox 
                                                                  checked={selectedEventIds.includes(event._id)}
                                                                  onClick={(e) => {
                                                                      e.stopPropagation();
                                                                      const id = event._id;
                                                                      setSelectedEventIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
                                                                  }}
                                                                  sx={{ color: '#1976d2', '&.Mui-checked': { color: '#1976d2' }, padding: '2px' }}
                                                                  size="small"
                                                              />
                                                          </Box>
                                                      )}
                                                      <Typography variant="body1"><b>{subject ? subject.name : 'Event'}</b></Typography>
                                                      <Typography variant="body2">{teacher ? teacher.name : 'N/A'} / {room ? room.name : 'N/A'}</Typography>
                                                  </Box>
                                              );
                                          })}
                                      </Box>
                                  );
                              } else if (events.length === 1) {
                                  // Original logic for a single event
                                  const event = events[0];
                                  const subject = event.customSubject ? { name: event.customSubject } : subjects.find(s => s._id === event.subjectId);
                                  const teacher = event.customTeacher ? { name: event.customTeacher } : teachers.find(t => t._id === event.teacherId);
                                  const room = event.customRoom ? { name: event.customRoom } : rooms.find(r => r._id === event.roomId);
                                  const eventColor = event.color || (subject && subject.color ? subject.color : '#808080');
                                  cellContent = (
                                      <Box 
                                        key={event._id} 
                                        sx={{ 
                                            backgroundColor: eventColor, 
                                            color: 'white', 
                                            padding: '4px 8px', 
                                            borderRadius: '4px', 
                                            fontSize: '0.8rem', 
                                            cursor: isEditor ? 'pointer' : 'default', 
                                            whiteSpace: 'normal', 
                                            wordBreak: 'break-word', 
                                            position: 'relative', 
                                            border: selectedEventIds.includes(event._id) ? '3px solid #1976d2' : 'none',
                                            boxShadow: selectedEventIds.includes(event._id) ? '0 0 5px rgba(25, 118, 210, 0.8)' : 'none',
                                            '&:hover .event-actions': { opacity: 1 }
                                        }} 
                                        onClick={() => handleOpenModal(event)}
                                      >
                                          {isEditor && (
                                              <Box className="event-actions" sx={{ position: 'absolute', top: 0, right: 0, opacity: selectedEventIds.includes(event._id) ? 1 : 0, transition: 'opacity 0.2s', display: 'flex', bgcolor: 'rgba(255,255,255,0.9)', borderRadius: '0 4px 0 4px' }}>
                                                  <IconButton
                                                      size="small"
                                                      onClick={(e) => handleCopySingle(e, event)}
                                                      sx={{ color: '#1976d2', padding: '2px' }}
                                                      title="Copy"
                                                  >
                                                      <Icon fontSize="small" sx={{ fontSize: '1rem' }}>content_copy</Icon>
                                                  </IconButton>
                                                  <Checkbox 
                                                      checked={selectedEventIds.includes(event._id)}
                                                      onClick={(e) => {
                                                          e.stopPropagation();
                                                          const id = event._id;
                                                          setSelectedEventIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
                                                      }}
                                                      sx={{ color: '#1976d2', '&.Mui-checked': { color: '#1976d2' }, padding: '2px' }}
                                                      size="small"
                                                  />
                                              </Box>
                                          )}
                                          <Typography variant="body1"><b>{subject ? subject.name : 'Event'}</b></Typography>
                                          <Typography variant="body2">{teacher ? teacher.name : 'N/A'} / {room ? room.name : 'N/A'}</Typography>
                                      </Box>
                                  );
                              } else {
                                  // Original logic for empty/special cells
                                  if (timeSlot.id === 'snack') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Snack</Typography>; }
                                  else if (timeSlot.id === 'lunch') { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Lunchbreak</Typography>; }
                                  else if (timeSlot.id === 10) { cellContent = <Typography variant="body1" sx={{fontWeight: 'bold', color: 'black', textAlign: 'center'}}>Homework Time</Typography>; }
                              }

                              // The TD is now always standard
                              return (
                                <td 
                                    key={`${grade}-${timeSlot.id}`} 
                                    style={{
                                        ...darkGrayCellStyle, 
                                        ...rowStyle, 
                                        position: 'relative', 
                                        cursor: isEditor ? 'pointer' : 'default',
                                        transition: 'background-color 0.2s'
                                    }}
                                    className={isEditor ? "editable-cell" : ""}
                                    onClick={(e) => handleCellClick(e, grade, timeSlot.id)}
                                    onMouseEnter={(e) => { if(isEditor) e.currentTarget.style.backgroundColor = '#f0f0f0'; }}
                                    onMouseLeave={(e) => { if(isEditor) e.currentTarget.style.backgroundColor = rowStyle.backgroundColor || '#e0e0e0'; }}
                                >
                                    {cellContent}
                                    {/* Overlay buttons for the cell (if needed) could go here, but we use context menu now */}
                                </td>
                              );
                          })}
                          </tr>
                      )
                    })}
                  </tbody>
                </table>
              </Box>
            )}
            {/* Cell Context Menu for Paste/Add */}
            <Menu
                anchorEl={cellMenuAnchor}
                open={Boolean(cellMenuAnchor)}
                onClose={() => setCellMenuAnchor(null)}
            >
                <MenuItem 
                    onClick={handlePasteFromMenu} 
                    disabled={clipboardEvents.length === 0}
                >
                    <Icon sx={{ mr: 1 }}>content_paste</Icon> Paste {clipboardEvents.length > 0 ? `${clipboardEvents.length} event(s)` : ''}
                </MenuItem>
                <MenuItem onClick={() => { 
                    setCellMenuAnchor(null); 
                    if (activeCellContext) handleOpenModal(null, activeCellContext); 
                }}>
                    <Icon sx={{ mr: 1 }}>add</Icon> Add New Event
                </MenuItem>
            </Menu>

            {isEditor && <>
              <Modal open={isModalOpen} onClose={handleCloseModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: isMobile ? '90%' : 600, maxHeight: isMobile ? '90vh' : 'auto', overflowY: isMobile ? 'auto' : 'visible', bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>{editingEvent ? 'Edit Schedule Event' : 'Add New Schedule Event'}</Typography>
                    {submitError && <Alert severity="error" sx={{ mb: 2 }}>{submitError}</Alert>}
                    <Grid container spacing={2}>
                        <Grid item xs={12} sm={6}>
                            <FormControl fullWidth>
                                <InputLabel>Grade</InputLabel>
                                <Select 
                                    name="grades" 
                                    multiple
                                    value={newEvent.grades || []} 
                                    label="Grade" 
                                    onChange={handleFormChange}
                                    renderValue={(selected) => selected.join(', ')}
                                >
                                    {grades.map(g => (
                                        <MenuItem 
                                            key={g} 
                                            value={g}
                                            sx={{
                                                backgroundColor: (newEvent.grades || []).includes(g) ? '#d3eafd' : 'transparent',
                                                fontWeight: (newEvent.grades || []).includes(g) ? 'bold' : 'normal'
                                            }}
                                        >
                                            {g}
                                        </MenuItem>
                                    ))}
                                </Select>
                            </FormControl>
                        </Grid>
                        <Grid item xs={12} sm={6}>
                            <FormControl fullWidth>
                                <InputLabel>Time Slot</InputLabel>
                                <Select 
                                    name="timeSlotIds" 
                                    multiple
                                    value={newEvent.timeSlotIds || []} 
                                    label="Time Slot" 
                                    onChange={handleFormChange}
                                    renderValue={(selected) => {
                                        return selected.map(id => timeSlots.find(t => t.id === id)?.time).join(', ');
                                    }}
                                >
                                    {timeSlots.filter(t => typeof t.id === 'number').map(t => (
                                        <MenuItem 
                                            key={t.id} 
                                            value={t.id}
                                            sx={{
                                                backgroundColor: (newEvent.timeSlotIds || []).includes(t.id) ? '#d3eafd' : 'transparent',
                                                fontWeight: (newEvent.timeSlotIds || []).includes(t.id) ? 'bold' : 'normal'
                                            }}
                                        >
                                            {t.time}
                                        </MenuItem>
                                    ))}
                                </Select>
                            </FormControl>
                        </Grid>
                        <Grid item xs={12}><FormControl fullWidth><InputLabel>Subject</InputLabel><Select name="subjectId" value={newEvent.subjectId} label="Subject" onChange={handleFormChange}>{subjects.map(s => <MenuItem key={s._id} value={s._id}>{s.name}</MenuItem>)}</Select></FormControl></Grid>
                        <Grid item xs={12}><TextField label="Or Custom Event Name" name="customSubject" value={newEvent.customSubject} onChange={handleFormChange} fullWidth variant="outlined"/></Grid>
                        <Grid item xs={12} sm={6}><FormControl fullWidth error={!!formErrors.teacherId}><InputLabel>Teacher</InputLabel><Select name="teacherId" value={newEvent.teacherId} label="Teacher" onChange={handleFormChange}>{teachers.map(t => <MenuItem key={t._id} value={t._id}>{t.name}</MenuItem>)}</Select></FormControl></Grid>
                        <Grid item xs={12} sm={6}><TextField label="Or Custom Teacher" name="customTeacher" value={newEvent.customTeacher} onChange={handleFormChange} fullWidth variant="outlined"/></Grid>
                        <Grid item xs={12} sm={6}><FormControl fullWidth error={!!formErrors.roomId}><InputLabel>Room</InputLabel><Select name="roomId" value={newEvent.roomId} label="Room" onChange={handleFormChange}>{rooms.map(r => <MenuItem key={r._id} value={r._id}>{r.name}</MenuItem>)}</Select></FormControl></Grid>
                        <Grid item xs={12} sm={6}><TextField label="Or Custom Room" name="customRoom" value={newEvent.customRoom} onChange={handleFormChange} fullWidth variant="outlined"/></Grid>
                        <Grid item xs={12}><TextField label="Custom Color" type="color" name="color" value={newEvent.color} onChange={handleFormChange} fullWidth/></Grid>
                    </Grid>
                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'space-between'}}>
                      {editingEvent && <Button variant="contained" color="error" onClick={handleDelete}>Delete</Button>}
                      <Box>
                        <Button onClick={handleCloseModal} sx={{mr: 1}}>Cancel</Button>
                        <Button variant="contained" onClick={handleSubmit}>{editingEvent ? 'Update' : 'Save'}</Button>
                      </Box>
                    </Box>
                </Box>
              </Modal>
              <Modal open={isExportModalOpen} onClose={handleCloseExportModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Export Schedule to PDF</Typography>
                    <FormControl fullWidth sx={{mb: 2}}>
                        <InputLabel>Export Type</InputLabel>
                        <Select
                            value={exportSelection}
                            label="Export Type"
                            onChange={(e) => setExportSelection(e.target.value)}
                        >
                            <MenuItem value="general">General Schedule</MenuItem>
                            {teachers.map(teacher => (
                                <MenuItem key={teacher._id} value={teacher._id}>{teacher.name}</MenuItem>
                            ))}
                            {grades.map(grade => (
                                <MenuItem key={`grade-${grade}`} value={`grade-${grade}`}>{`Grade ${grade}`}</MenuItem>
                            ))}
                        </Select>
                    </FormControl>
                    {isExporting ? (
                        <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', flexDirection: 'column' }}>
                            <CircularProgress />
                            <Typography sx={{mt: 2}}>Exporting... Please wait.</Typography>
                        </Box>
                    ) : (
                        <>
                            <FormControl component="fieldset" variant="standard" sx={{mb: 2, width: '100%'}} disabled={exportSelection !== 'general'}>
                                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <Typography component="legend" sx={{color: exportSelection !== 'general' ? 'text.disabled' : 'text.primary'}}>Select Days to Export:</Typography>
                                    <Button 
                                        size="small" 
                                        onClick={handleToggleAllExportDays}
                                        disabled={exportSelection !== 'general'}
                                    >
                                        All
                                    </Button>
                                </Box>
                                <Box sx={{ display: 'flex', flexDirection: 'row', justifyContent: 'space-around', mt: 1 }}>
                                    {Object.keys(exportDays).map((day) => (
                                        <FormControlLabel
                                            key={day}
                                            control={
                                                <Checkbox checked={exportDays[day]} onChange={handleExportDayChange} name={day} />
                                            }
                                            label={day.substring(0, 3)}
                                        />
                                    ))}
                                </Box>
                            </FormControl>
                            <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                <Button onClick={handleCloseExportModal} sx={{mr: 1}}>Cancel</Button>
                                <Button variant="contained" onClick={handleExport}>Export</Button>
                            </Box>
                        </>
                    )}
                </Box>
              </Modal>
              <Modal open={isCopyModalOpen} onClose={handleCloseCopyModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Copy Schedule</Typography>
                    <Typography sx={{mb: 2}}>Copying schedule from: <b>{formatDate(currentDay)}</b></Typography>
                    <TextField
                        label="Paste to date"
                        type="date"
                        fullWidth
                        InputLabelProps={{ shrink: true }}
                        onChange={(e) => {
                            if (e.target.value) {
                                setCopyTargetDate(new Date(e.target.value + 'T12:00:00'));
                            } else {
                                setCopyTargetDate(null);
                            }
                        }}
                    />
                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                        <Button onClick={handleCloseCopyModal} sx={{mr: 1}}>Cancel</Button>
                        <Button variant="contained" onClick={handlePasteDay} disabled={!copyTargetDate}>Paste</Button>
                    </Box>
                </Box>
              </Modal>
              <Modal open={isCopyWeekModalOpen} onClose={handleCloseCopyWeekModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Copy Week's Schedule</Typography>
                    <Typography sx={{mb: 2}}>Copying schedule from week of: <b>{formatDate(currentDay)}</b></Typography>
                    <TextField
                        label="Paste to any date in target week"
                        type="date"
                        fullWidth
                        InputLabelProps={{ shrink: true }}
                        onChange={(e) => {
                            if (e.target.value) {
                                setCopyWeekTargetDate(new Date(e.target.value + 'T12:00:00'));
                            } else {
                                setCopyWeekTargetDate(null);
                            }
                        }}
                    />
                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                        <Button onClick={handleCloseCopyWeekModal} sx={{mr: 1}}>Cancel</Button>
                        <Button variant="contained" onClick={handlePasteWeek} disabled={!copyWeekTargetDate}>Paste</Button>
                    </Box>
                </Box>
              </Modal>
                                          <Modal open={isSubjectModalOpen} onClose={handleCloseSubjectModal}>
                                            <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: isMobile ? '95%' : 900, maxHeight: '90vh', overflowY: 'auto', bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                <Typography variant="h6" component="h2" sx={{mb: 3}}>Edit Subjects</Typography>
                                                <Box sx={{ mb: 3 }}>
                                                    {editingSubjects.map((subject, index) => (
                                                        <Box 
                                                            key={subject._id || `new-${index}`} 
                                                            sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 1, p: 1, border: '1px solid #eee', borderRadius: '4px', bgcolor: '#fafafa' }}
                                                            draggable={true}
                                                            onDragStart={(e) => handleDragStart(e, index)}
                                                            onDragOver={handleDragOver}
                                                            onDrop={(e) => handleDrop(e, index, 'subjects')}
                                                        >
                                                            <Icon sx={{ cursor: 'move', color: 'text.secondary' }}>drag_indicator</Icon>
                                                            <Grid container spacing={2} alignItems="center">
                                                                <Grid item xs={12} sm={4}>
                                                                    <TextField
                                                                        label="Subject Name"
                                                                        value={subject.name}
                                                                        onChange={(e) => {
                                                                            const updatedSubjects = [...editingSubjects];
                                                                            updatedSubjects[index].name = e.target.value;
                                                                            setEditingSubjects(updatedSubjects);
                                                                        }}
                                                                        fullWidth
                                                                        size="small"
                                                                        variant="outlined"
                                                                    />
                                                                </Grid>
                                                                <Grid item xs={12} sm={3}>
                                                                    <FormControl fullWidth size="small">
                                                                        <InputLabel>Default Teacher</InputLabel>
                                                                        <Select
                                                                            value={subject.defaultTeacherId || ''}
                                                                            label="Default Teacher"
                                                                            onChange={(e) => {
                                                                                const updatedSubjects = [...editingSubjects];
                                                                                updatedSubjects[index].defaultTeacherId = e.target.value;
                                                                                setEditingSubjects(updatedSubjects);
                                                                            }}
                                                                        >
                                                                            <MenuItem value=""><em>None</em></MenuItem>
                                                                            {teachers.map(t => <MenuItem key={t._id} value={t._id}>{t.name}</MenuItem>)}
                                                                        </Select>
                                                                    </FormControl>
                                                                </Grid>
                                                                <Grid item xs={6} sm={3} sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                                                    <Typography variant="body2" color="textSecondary">Color:</Typography>
                                                                    <input
                                                                        type="color"
                                                                        value={subject.color}
                                                                        onChange={(e) => {
                                                                            const updatedSubjects = [...editingSubjects];
                                                                            updatedSubjects[index].color = e.target.value;
                                                                            setEditingSubjects(updatedSubjects);
                                                                        }}
                                                                        style={{ width: '40px', height: '40px', border: 'none', padding: 0, cursor: 'pointer', borderRadius: '4px' }}
                                                                    />
                                                                </Grid>
                                                                <Grid item xs={6} sm={2} sx={{ display: 'flex', justifyContent: 'flex-end', gap: 0.5 }}>
                                                                    <IconButton 
                                                                        size="small"
                                                                        onClick={() => {
                                                                            const updatedSubjects = [...editingSubjects];
                                                                            updatedSubjects.splice(index, 1);
                                                                            setEditingSubjects(updatedSubjects);
                                                                        }}
                                                                        disabled={schedules.some(s => s.subjectId === subject._id)}
                                                                        title={schedules.some(s => s.subjectId === subject._id) ? "Cannot delete: Subject is in use" : "Delete Subject"}
                                                                    >
                                                                        <Icon>delete</Icon>
                                                                    </IconButton>
                                                                    {schedules.some(s => s.subjectId === subject._id) && (
                                                                        <IconButton size="small" onClick={() => handleOpenUsageModal(subject._id)} title="Find Usages">
                                                                            <Icon>search</Icon>
                                                                        </IconButton>
                                                                    )}
                                                                </Grid>
                                                            </Grid>
                                                        </Box>
                                                    ))}
                                                </Box>
                                                
                                                <Typography variant="h6" component="h2" sx={{mb: 2}}>Add New Subject</Typography>
                                                <Box sx={{ p: 2, border: '2px dashed #1976d2', borderRadius: '4px', bgcolor: '#e3f2fd' }}>
                                                    <Grid container spacing={2} alignItems="center">
                                                        <Grid item xs={12} sm={4}>
                                                            <TextField
                                                                label="New Subject Name"
                                                                value={newSubjectName}
                                                                onChange={(e) => setNewSubjectName(e.target.value)}
                                                                fullWidth
                                                                variant="outlined"
                                                            />
                                                        </Grid>
                                                        <Grid item xs={12} sm={3}>
                                                            <FormControl fullWidth>
                                                                <InputLabel>Default Teacher</InputLabel>
                                                                <Select
                                                                    value={newSubjectTeacher}
                                                                    label="Default Teacher"
                                                                    onChange={(e) => setNewSubjectTeacher(e.target.value)}
                                                                >
                                                                    <MenuItem value=""><em>None</em></MenuItem>
                                                                    {teachers.map(t => <MenuItem key={t._id} value={t._id}>{t.name}</MenuItem>)}
                                                                </Select>
                                                            </FormControl>
                                                        </Grid>
                                                        <Grid item xs={6} sm={3} sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                                            <Typography variant="body2" color="textSecondary">Color:</Typography>
                                                            <input
                                                                type="color"
                                                                value={newSubjectColor}
                                                                onChange={(e) => setNewSubjectColor(e.target.value)}
                                                                style={{ width: '56px', height: '56px', border: 'none', padding: 0, cursor: 'pointer', borderRadius: '4px' }}
                                                            />
                                                        </Grid>
                                                        <Grid item xs={6} sm={2}>
                                                            <Button
                                                                variant="contained"
                                                                fullWidth
                                                                sx={{ height: '56px' }}
                                                                onClick={() => {
                                                                    if (newSubjectName.trim()) {
                                                                        setEditingSubjects([...editingSubjects, { 
                                                                            name: newSubjectName.trim(), 
                                                                            color: newSubjectColor,
                                                                            defaultTeacherId: newSubjectTeacher
                                                                        }]);
                                                                        setNewSubjectName('');
                                                                        setNewSubjectColor('#1976d2');
                                                                        setNewSubjectTeacher('');
                                                                    }
                                                                }}
                                                            >
                                                                Add
                                                            </Button>
                                                        </Grid>
                                                    </Grid>
                                                </Box>
                                                <Box sx={{mt: 4, display: 'flex', justifyContent: 'flex-end', gap: 2}}>
                                                    <Button onClick={handleCloseSubjectModal} size="large">Cancel</Button>
                                                    <Button variant="contained" onClick={handleSaveSubjects} size="large">Save All Changes</Button>
                                                </Box>
                                            </Box>
                                          </Modal>

              <Modal open={isUsageModalOpen} onClose={handleCloseUsageModal}>
                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                    <Typography variant="h6" component="h2" sx={{mb: 2}}>
                        Usage of "{usageData.subjectName}"
                    </Typography>
                    <Typography variant="body1" sx={{mb: 2}}>
                        This subject is used on the following dates. Click delete to remove all entries for a specific day.
                    </Typography>
                    <Box sx={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid #ccc', p: 1, mb: 2 }}>
                        {usageData.dates.length > 0 ? (
                            usageData.dates.map((dateInfo, index) => (
                                <Box key={index} sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', p: 0.5 }}>
                                    <Typography>{dateInfo.formatted}</Typography>
                                    <IconButton 
                                        size="small" 
                                        onClick={() => handleDeleteUsagesForDay(subjects.find(s => s.name === usageData.subjectName)?.id, dateInfo.raw)}
                                        title={`Delete all '${usageData.subjectName}' entries for ${dateInfo.formatted}`}
                                    >
                                        <Icon>delete_outline</Icon>
                                    </IconButton>
                                </Box>
                            ))
                        ) : (
                            <Typography>No usages found. You can now delete this subject.</Typography>
                        )}
                    </Box>
                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                        <Button onClick={handleCloseUsageModal}>Close</Button>
                                                                    </Box>
                                                                </Box>
                                                              </Modal>
                    
                                                              <Modal open={isTeacherModalOpen} onClose={handleCloseTeacherModal}>
                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: isMobile ? '95%' : 1000, maxHeight: '90vh', overflowY: 'auto', bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                    <Typography variant="h6" component="h2" sx={{mb: 3}}>Edit Teachers</Typography>
                                                                    <Box sx={{ mb: 3 }}>
                                                                        {editingTeachers.map((teacher, index) => (
                                                                            <Box 
                                                                                key={teacher._id || `new-${index}`} 
                                                                                sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 1, p: 1, border: '1px solid #eee', borderRadius: '4px', bgcolor: '#fafafa' }}
                                                                                draggable={true}
                                                                                onDragStart={(e) => handleDragStart(e, index)}
                                                                                onDragOver={handleDragOver}
                                                                                onDrop={(e) => handleDrop(e, index, 'teachers')}
                                                                            >
                                                                                <Icon sx={{ cursor: 'move', color: 'text.secondary' }}>drag_indicator</Icon>
                                                                                <Grid container spacing={1} alignItems="center">
                                                                                    <Grid item xs={12} sm={3}>
                                                                                        <TextField
                                                                                            label="Teacher Name"
                                                                                            value={teacher.name}
                                                                                            onChange={(e) => {
                                                                                                const updatedTeachers = [...editingTeachers];
                                                                                                updatedTeachers[index].name = e.target.value;
                                                                                                setEditingTeachers(updatedTeachers);
                                                                                            }}
                                                                                            fullWidth
                                                                                            size="small"
                                                                                            variant="outlined"
                                                                                        />
                                                                                    </Grid>
                                                                                    <Grid item xs={12} sm={4}>
                                                                                        <TextField
                                                                                            label="Email"
                                                                                            value={teacher.email || ''}
                                                                                            onChange={(e) => {
                                                                                                const updatedTeachers = [...editingTeachers];
                                                                                                updatedTeachers[index].email = e.target.value;
                                                                                                setEditingTeachers(updatedTeachers);
                                                                                            }}
                                                                                            fullWidth
                                                                                            size="small"
                                                                                            variant="outlined"
                                                                                        />
                                                                                    </Grid>
                                                                                    <Grid item xs={12} sm={3}>
                                                                                        <FormControl fullWidth size="small">
                                                                                            <InputLabel>Default Room</InputLabel>
                                                                                            <Select
                                                                                                value={teacher.defaultRoomId || ''}
                                                                                                label="Default Room"
                                                                                                onChange={(e) => {
                                                                                                    const updatedTeachers = [...editingTeachers];
                                                                                                    updatedTeachers[index].defaultRoomId = e.target.value;
                                                                                                    setEditingTeachers(updatedTeachers);
                                                                                                }}
                                                                                            >
                                                                                                <MenuItem value=""><em>None</em></MenuItem>
                                                                                                {rooms.map(r => <MenuItem key={r._id} value={r._id}>{r.name}</MenuItem>)}
                                                                                            </Select>
                                                                                        </FormControl>
                                                                                    </Grid>
                                                                                    <Grid item xs={12} sm={2} sx={{ display: 'flex', justifyContent: 'flex-end', gap: 0.5 }}>
                                                                                        <IconButton 
                                                                                            size="small"
                                                                                            onClick={() => {
                                                                                                const updatedTeachers = [...editingTeachers];
                                                                                                updatedTeachers.splice(index, 1);
                                                                                                setEditingTeachers(updatedTeachers);
                                                                                            }}
                                                                                            disabled={schedules.some(s => s.teacherId === teacher._id)}
                                                                                            title={schedules.some(s => s.teacherId === teacher._id) ? "Cannot delete: Teacher is in use" : "Delete Teacher"}
                                                                                        >
                                                                                            <Icon>delete</Icon>
                                                                                        </IconButton>
                                                                                        {schedules.some(s => s.teacherId === teacher._id) && (
                                                                                            <IconButton size="small" onClick={() => handleOpenTeacherUsageModal(teacher._id)} title="Find Usages">
                                                                                                <Icon>search</Icon>
                                                                                            </IconButton>
                                                                                        )}
                                                                                    </Grid>
                                                                                </Grid>
                                                                            </Box>
                                                                        ))}
                                                                    </Box>
                                                                    
                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Add New Teacher</Typography>
                                                                    <Box sx={{ p: 2, border: '2px dashed #1976d2', borderRadius: '4px', bgcolor: '#e3f2fd' }}>
                                                                        <Grid container spacing={2} alignItems="center">
                                                                            <Grid item xs={12} sm={3}>
                                                                                <TextField
                                                                                    label="New Teacher Name"
                                                                                    value={newTeacherName}
                                                                                    onChange={(e) => setNewTeacherName(e.target.value)}
                                                                                    fullWidth
                                                                                    variant="outlined"
                                                                                />
                                                                            </Grid>
                                                                            <Grid item xs={12} sm={4}>
                                                                                <TextField
                                                                                    label="New Teacher Email"
                                                                                    value={newTeacherEmail}
                                                                                    onChange={(e) => setNewTeacherEmail(e.target.value)}
                                                                                    fullWidth
                                                                                    variant="outlined"
                                                                                />
                                                                            </Grid>
                                                                            <Grid item xs={12} sm={3}>
                                                                                <FormControl fullWidth>
                                                                                    <InputLabel>Default Room</InputLabel>
                                                                                    <Select
                                                                                        value={newTeacherRoom}
                                                                                        label="Default Room"
                                                                                        onChange={(e) => setNewTeacherRoom(e.target.value)}
                                                                                    >
                                                                                        <MenuItem value=""><em>None</em></MenuItem>
                                                                                        {rooms.map(r => <MenuItem key={r._id} value={r._id}>{r.name}</MenuItem>)}
                                                                                    </Select>
                                                                                </FormControl>
                                                                            </Grid>
                                                                            <Grid item xs={12} sm={2}>
                                                                                <Button
                                                                                    variant="contained"
                                                                                    fullWidth
                                                                                    sx={{ height: '56px' }}
                                                                                    onClick={() => {
                                                                                        if (newTeacherName.trim()) {
                                                                                            setEditingTeachers([...editingTeachers, { 
                                                                                                name: newTeacherName.trim(), 
                                                                                                email: newTeacherEmail.trim(),
                                                                                                defaultRoomId: newTeacherRoom 
                                                                                            }]);
                                                                                            setNewTeacherName('');
                                                                                            setNewTeacherEmail('');
                                                                                            setNewTeacherRoom('');
                                                                                        }
                                                                                    }}
                                                                                >
                                                                                    Add
                                                                                </Button>
                                                                            </Grid>
                                                                        </Grid>
                                                                    </Box>
                                                                    <Box sx={{mt: 4, display: 'flex', justifyContent: 'flex-end', gap: 2}}>
                                                                        <Button onClick={handleCloseTeacherModal} size="large">Cancel</Button>
                                                                        <Button variant="contained" onClick={handleSaveTeachers} size="large">Save All Changes</Button>
                                                                    </Box>
                                                                </Box>
                                                              </Modal>
                    
                                                              <Modal open={isTeacherUsageModalOpen} onClose={handleCloseTeacherUsageModal}>
                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>
                                                                        Usage of "{teacherUsageData.teacherName}"
                                                                    </Typography>
                                                                    <Typography variant="body1" sx={{mb: 2}}>
                                                                        This teacher is used on the following dates. Click delete to remove all entries for a specific day.
                                                                    </Typography>
                                                                    <Box sx={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid #ccc', p: 1, mb: 2 }}>
                                                                        {teacherUsageData.dates.length > 0 ? (
                                                                            teacherUsageData.dates.map((dateInfo, index) => (
                                                                                <Box key={index} sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', p: 0.5 }}>
                                                                                    <Typography>{dateInfo.formatted}</Typography>
                                                                                    <IconButton 
                                                                                        size="small" 
                                                                                        onClick={() => handleDeleteTeacherUsagesForDay(teachers.find(t => t.name === teacherUsageData.teacherName)?._id, dateInfo.raw)}
                                                                                        title={`Delete all '${teacherUsageData.teacherName}' entries for ${dateInfo.formatted}`}
                                                                                    >
                                                                                        <Icon>delete_outline</Icon>
                                                                                    </IconButton>
                                                                                </Box>
                                                                            ))
                                                                        ) : (
                                                                            <Typography>No usages found. You can now delete this teacher.</Typography>
                                                                        )}
                                                                    </Box>
                                                                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                        <Button onClick={handleCloseTeacherUsageModal}>Close</Button>
                                                                                                                    </Box>
                                                                                                                </Box>
                                                                                                              </Modal>
                                                                    
                                                                                                              <Modal open={isRoomModalOpen} onClose={handleCloseRoomModal}>
                                                                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 600, maxHeight: '80vh', overflowY: 'auto', bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Edit Rooms</Typography>
                                                                                                                    <Box sx={{ mb: 3 }}>
                                                                                                                        {editingRooms.map((room, index) => (
                                                                                                                            <Box 
                                                                                                                                key={room._id || `new-${index}`} 
                                                                                                                                sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 2, cursor: 'move', p: 1, border: '1px dashed grey' }}
                                                                                                                                draggable={true}
                                                                                                                                onDragStart={(e) => handleDragStart(e, index)}
                                                                                                                                onDragOver={handleDragOver}
                                                                                                                                onDrop={(e) => handleDrop(e, index, 'rooms')}
                                                                                                                            >
                                                                                                                                <Icon>drag_indicator</Icon>
                                                                                                                                <TextField
                                                                                                                                    label="Room Name"
                                                                                                                                    value={room.name}
                                                                                                                                    onChange={(e) => {
                                                                                                                                        const updatedRooms = [...editingRooms];
                                                                                                                                        updatedRooms[index].name = e.target.value;
                                                                                                                                        setEditingRooms(updatedRooms);
                                                                                                                                    }}
                                                                                                                                    fullWidth
                                                                                                                                    variant="outlined"
                                                                                                                                />
                                                                                                                                <IconButton 
                                                                                                                                    onClick={() => {
                                                                                                                                        const updatedRooms = [...editingRooms];
                                                                                                                                        updatedRooms.splice(index, 1);
                                                                                                                                        setEditingRooms(updatedRooms);
                                                                                                                                    }}
                                                                                                                                    disabled={schedules.some(s => s.roomId === room._id)}
                                                                                                                                    title={schedules.some(s => s.roomId === room._id) ? "Cannot delete: Room is in use" : "Delete Room"}
                                                                                                                                >
                                                                                                                                    <Icon>delete</Icon>
                                                                                                                                </IconButton>
                                                                                                                                {schedules.some(s => s.roomId === room._id) && (
                                                                                                                                    <IconButton onClick={() => handleOpenRoomUsageModal(room._id)} title="Find Usages">
                                                                                                                                        <Icon>search</Icon>
                                                                                                                                    </IconButton>
                                                                                                                                )}
                                                                                                                            </Box>
                                                                                                                        ))}
                                                                                                                    </Box>
                                                                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Add New Room</Typography>
                                                                                                                    <Box sx={{ display: 'flex', alignItems: 'center', mb: 2, gap: 2 }}>
                                                                                                                        <TextField
                                                                                                                            label="New Room Name"
                                                                                                                            value={newRoomName}
                                                                                                                            onChange={(e) => setNewRoomName(e.target.value)}
                                                                                                                            fullWidth
                                                                                                                            variant="outlined"
                                                                                                                        />
                                                                                                                        <Button
                                                                                                                            variant="contained"
                                                                                                                            onClick={() => {
                                                                                                                                if (newRoomName.trim()) {
                                                                                                                                    setEditingRooms([...editingRooms, { name: newRoomName.trim() }]);
                                                                                                                                    setNewRoomName('');
                                                                                                                                }
                                                                                                                            }}
                                                                                                                        >
                                                                                                                            Add
                                                                                                                        </Button>
                                                                                                                    </Box>
                                                                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end', gap: 1}}>
                                                                                                                        <Button onClick={handleCloseRoomModal}>Cancel</Button>
                                                                                                                        <Button variant="contained" onClick={handleSaveRooms}>Save All Changes</Button>
                                                                                                                    </Box>
                                                                                                                </Box>
                                                                                                              </Modal>
                                                                                                              
                                                                                                              <Modal open={isRoomUsageModalOpen} onClose={handleCloseRoomUsageModal}>
                                                                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>
                                                                                                                        Usage of "{roomUsageData.roomName}"
                                                                                                                    </Typography>
                                                                                                                    <Typography variant="body1" sx={{mb: 2}}>
                                                                                                                        This room is used on the following dates. Click delete to remove all entries for a specific day.
                                                                                                                    </Typography>
                                                                                                                    <Box sx={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid #ccc', p: 1, mb: 2 }}>
                                                                                                                        {roomUsageData.dates.length > 0 ? (
                                                                                                                            roomUsageData.dates.map((dateInfo, index) => (
                                                                                                                                <Box key={index} sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', p: 0.5 }}>
                                                                                                                                    <Typography>{dateInfo.formatted}</Typography>
                                                                                                                                    <IconButton 
                                                                                                                                        size="small" 
                                                                                                                                        onClick={() => handleDeleteRoomUsagesForDay(rooms.find(r => r.name === roomUsageData.roomName)?.id, dateInfo.raw)}
                                                                                                                                        title={`Delete all '${roomUsageData.roomName}' entries for ${dateInfo.formatted}`}
                                                                                                                                    >
                                                                                                                                        <Icon>delete_outline</Icon>
                                                                                                                                    </IconButton>
                                                                                                                                </Box>
                                                                                                                            ))
                                                                                                                        ) : (
                                                                                                                            <Typography>No usages found. You can now delete this room.</Typography>
                                                                                                                        )}
                                                                                                                    </Box>
                                                                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                        <Button onClick={handleCloseRoomUsageModal}>Close</Button>
                                                                                                                    </Box>
                                                                                                                </Box>
                                                                                                              </Modal>

                                                                                                              <Modal open={isLessonCounterModalOpen} onClose={() => setIsLessonCounterModalOpen(false)}>
                                                                                                                <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 500, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                                                                    <Typography variant="h6" component="h2" sx={{mb: 2}}>Lesson Counter</Typography>
                                                                                                                    <Grid container spacing={2}>
                                                                                                                        <Grid item xs={6}>
                                                                                                                            <TextField
                                                                                                                                label="Start Date"
                                                                                                                                type="date"
                                                                                                                                value={counterStartDate}
                                                                                                                                onChange={(e) => setCounterStartDate(e.target.value)}
                                                                                                                                fullWidth
                                                                                                                                InputLabelProps={{ shrink: true }}
                                                                                                                            />
                                                                                                                        </Grid>
                                                                                                                        <Grid item xs={6}>
                                                                                                                            <TextField
                                                                                                                                label="End Date"
                                                                                                                                type="date"
                                                                                                                                value={counterEndDate}
                                                                                                                                onChange={(e) => setCounterEndDate(e.target.value)}
                                                                                                                                fullWidth
                                                                                                                                InputLabelProps={{ shrink: true }}
                                                                                                                            />
                                                                                                                        </Grid>
                                                                                                                        <Grid item xs={12}>
                                                                                                                            <FormControl fullWidth>
                                                                                                                                <InputLabel>Teacher</InputLabel>
                                                                                                                                <Select
                                                                                                                                    value={counterSelectedTeacher}
                                                                                                                                    onChange={(e) => setCounterSelectedTeacher(e.target.value)}
                                                                                                                                >
                                                                                                                                    {teachers.map(t => <MenuItem key={t._id} value={t._id}>{t.name}</MenuItem>)}
                                                                                                                                </Select>
                                                                                                                            </FormControl>
                                                                                                                        </Grid>
                                                                                                                        <Grid item xs={12}>
                                                                                                                            <FormControl fullWidth>
                                                                                                                                <InputLabel>Subject (Optional)</InputLabel>
                                                                                                                                <Select
                                                                                                                                    value={counterSelectedSubject}
                                                                                                                                    onChange={(e) => setCounterSelectedSubject(e.target.value)}
                                                                                                                                >
                                                                                                                                    <MenuItem value=""><em>Any Subject</em></MenuItem>
                                                                                                                                    {subjects.map(s => <MenuItem key={s._id} value={s._id}>{s.name}</MenuItem>)}
                                                                                                                                </Select>
                                                                                                                            </FormControl>
                                                                                                                        </Grid>
                                                                                                                    </Grid>
                                                                                                                    <Typography variant="h5" sx={{ mt: 3, textAlign: 'center' }}>
                                                                                                                        Total Lessons: {lessonCount}
                                                                                                                    </Typography>
                                                                                                                    <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                        <Button onClick={() => setIsLessonCounterModalOpen(false)}>Close</Button>
                                                                                                                    </Box>
                                                                                                                </Box>
                                                                                                              </Modal>
                                                                                                              
                                                                                                                            <Modal open={isSendMailModalOpen} onClose={handleCloseMailModal}>
                                                                                                                              <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 600, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                                                                                  <Typography variant="h6" component="h2" sx={{mb: 2}}>Send Schedule via Email</Typography>
                                                                                                                                  
                                                                                                                                  <TextField
                                                                                                                                      label="Email Body"
                                                                                                                                      multiline
                                                                                                                                      rows={4}
                                                                                                                                      value={emailBody}
                                                                                                                                      onChange={(e) => setEmailBody(e.target.value)}
                                                                                                                                      fullWidth
                                                                                                                                      variant="outlined"
                                                                                                                                      sx={{ mb: 2 }}
                                                                                                                                  />
                                                                                                              
                                                                                                                                  <Tabs value={mailTab} onChange={(e, v) => setMailTab(v)} sx={{ borderBottom: 1, borderColor: 'divider', mb: 2 }}>
                                                                                                                                      <Tab label="General" />
                                                                                                                                      <Tab label="Teachers" />
                                                                                                                                      <Tab label="Students" />
                                                                                                                                  </Tabs>
                                                                                                              
                                                                                                                                  <Box sx={{ display: 'flex', justifyContent: 'flex-end', mb: 1 }}>
                                                                                                                                      <Button 
                                                                                                                                          size="small" 
                                                                                                                                          onClick={() => {
                                                                                                                                              const allIds = emailRecipients.map(r => r.id);
                                                                                                                                              const allSelected = allIds.every(id => selectedRecipients[id]);
                                                                                                                                              const newSelection = {};
                                                                                                                                              if (!allSelected) {
                                                                                                                                                  allIds.forEach(id => newSelection[id] = true);
                                                                                                                                              }
                                                                                                                                              setSelectedRecipients(newSelection);
                                                                                                                                          }}
                                                                                                                                      >
                                                                                                                                          {emailRecipients.every(r => selectedRecipients[r.id]) ? "Deselect All" : "Select All"}
                                                                                                                                      </Button>
                                                                                                                                  </Box>
                                                                                                              
                                                                                                                                  <Box sx={{ maxHeight: '300px', overflowY: 'auto', border: '1px solid #ccc', p: 1, mb: 2 }}>
                                                                                                                                      {emailRecipients
                                                                                                                                          .filter(r => {
                                                                                                                                              if (mailTab === 0) return r.type === 'general';
                                                                                                                                              if (mailTab === 1) return r.type === 'teacher';
                                                                                                                                              if (mailTab === 2) return r.type === 'student';
                                                                                                                                              return true;
                                                                                                                                          })
                                                                                                                                          .map(r => (
                                                                                                                                              <FormControlLabel
                                                                                                                                                  key={r.id}
                                                                                                                                                  control={
                                                                                                                                                      <Checkbox
                                                                                                                                                          checked={!!selectedRecipients[r.id]}
                                                                                                                                                          onChange={(e) => {
                                                                                                                                                              setSelectedRecipients(prev => ({ ...prev, [r.id]: e.target.checked }));
                                                                                                                                                          }}
                                                                                                                                                      />
                                                                                                                                                  }
                                                                                                                                                  label={r.email ? `${r.name} (${r.email})` : r.name}
                                                                                                                                                  sx={{ display: 'block', ml: 1 }}
                                                                                                                                              />
                                                                                                                                      ))}
                                                                                                                                      {emailRecipients.filter(r => {
                                                                                                                                              if (mailTab === 0) return r.type === 'general';
                                                                                                                                              if (mailTab === 1) return r.type === 'teacher';
                                                                                                                                              if (mailTab === 2) return r.type === 'student';
                                                                                                                                              return false;
                                                                                                                                      }).length === 0 && <Typography sx={{ p: 2, color: 'text.secondary' }}>No recipients in this category.</Typography>}
                                                                                                                                  </Box>
                                                                                                              
                                                                                                                                  <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                                      <Button onClick={handleCloseMailModal} sx={{mr: 1}}>Cancel</Button>
                                                                                                                                      <Button variant="contained" onClick={handleSendMail} disabled={sendingMail}>
                                                                                                                                          {sendingMail ? <CircularProgress size={24} /> : 'Send'}
                                                                                                                                      </Button>
                                                                                                                                  </Box>
                                                                                                                              </Box>
                                                                                                                            </Modal>                                                                                                              
                                                                                                                            <Dialog
                                                                                                                              open={isConfirmOpen}
                                                                                                                              onClose={handleConfirmClose}
                                                                                                                              aria-labelledby="alert-dialog-title"
                                                                                                                              aria-describedby="alert-dialog-description"
                                                                                                                            >
                                                                                                                              <DialogTitle id="alert-dialog-title">
                                                                                                                                {"Conflict Detected"}
                                                                                                                              </DialogTitle>
                                                                                                                              <DialogContent>
                                                                                                                                <DialogContentText id="alert-dialog-description">
                                                                                                                                  {confirmMessage}
                                                                                                                                  <br/><br/>
                                                                                                                                  Do you want to save this event anyway?
                                                                                                                                </DialogContentText>
                                                                                                                              </DialogContent>
                                                                                                                              <DialogActions>
                                                                                                                                <Button onClick={handleConfirmClose}>Cancel</Button>
                                                                                                                                <Button onClick={handleConfirmAction} autoFocus>
                                                                                                                                  Save Anyway
                                                                                                                                </Button>
                                                                                                                                              </DialogActions>
                                                                                                                                            </Dialog>
                                                                                                                              
                                                                                                                                            <Backdrop
                                                                                                                                              sx={{ color: '#fff', zIndex: (theme) => theme.zIndex.drawer + 1 }}
                                                                                                                                              open={isSaving}
                                                                                                                                            >
                                                                                                                                              <CircularProgress color="inherit" />
                                                                                                                                            </Backdrop>
                                                                                                                              
                                                                                                                                                                      <Modal open={isRolesModalOpen} onClose={() => setIsRolesModalOpen(false)}>
                                                                                                                              
                                                                                                                                                                        <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 600, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4, maxHeight: '90vh', overflowY: 'auto' }}>
                                                                                                                              
                                                                                                                                                                            <Typography variant="h6" component="h2" sx={{mb: 2}}>Manage User Roles</Typography>
                                                                                                                              
                                                                                                                                                                            
                                                                                                                              
                                                                                                                                                                            <Box sx={{ mb: 3, p: 2, border: '1px dashed #1976d2', bgcolor: '#e3f2fd', borderRadius: '4px' }}>
                                                                                                                              
                                                                                                                                                                                <Typography variant="subtitle2" sx={{mb: 1}}>Add New User</Typography>
                                                                                                                              
                                                                                                                                                                                <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>
                                                                                                                              
                                                                                                                                                                                    <TextField size="small" label="Email" value={newUserEmail} onChange={(e) => setNewUserEmail(e.target.value)} fullWidth />
                                                                                                                              
                                                                                                                                                                                    <TextField size="small" label="Name (Optional)" value={newUserName} onChange={(e) => setNewUserName(e.target.value)} fullWidth />
                                                                                                                              
                                                                                                                                                                                    <FormControl size="small" sx={{ minWidth: 100 }}>
                                                                                                                              
                                                                                                                                                                                        <Select value={newUserRole} onChange={(e) => setNewUserRole(e.target.value)}>
                                                                                                                              
                                                                                                                                                                                            <MenuItem value="admin">Admin</MenuItem>
                                                                                                                              
                                                                                                                                                                                            <MenuItem value="editor">Editor</MenuItem>
                                                                                                                              
                                                                                                                                                                                            <MenuItem value="counter">Counter</MenuItem>
                                                                                                                              
                                                                                                                                                                                            <MenuItem value="viewer">Viewer</MenuItem>
                                                                                                                              
                                                                                                                                                                                        </Select>
                                                                                                                              
                                                                                                                                                                                    </FormControl>
                                                                                                                              
                                                                                                                                                                                    <Button variant="contained" onClick={handleAddUser}>Add</Button>
                                                                                                                              
                                                                                                                                                                                </Box>
                                                                                                                              
                                                                                                                                                                            </Box>
                                                                                                                              
                                                                                                                                                        
                                                                                                                              
                                                                                                                                                                            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                                                                                                                              
                                                                                                                                                                                {usersList.map(u => (
                                                                                                                              
                                                                                                                                                                                    <Box key={u._id} sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', p: 1, border: '1px solid #eee' }}>
                                                                                                                              
                                                                                                                                                                                        <Box>
                                                                                                                              
                                                                                                                                                                                            <Typography variant="subtitle1">{u.name || 'Unknown Name'}</Typography>
                                                                                                                              
                                                                                                                                                                                            <Typography variant="body2" color="textSecondary">{u.email}</Typography>
                                                                                                                              
                                                                                                                                                                                        </Box>
                                                                                                                              
                                                                                                                                                                                        <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>
                                                                                                                              
                                                                                                                                                                                            <FormControl size="small" sx={{ minWidth: 120 }}>
                                                                                                                              
                                                                                                                                                                                                <Select
                                                                                                                              
                                                                                                                                                                                                    value={u.role || 'viewer'}
                                                                                                                              
                                                                                                                                                                                                    onChange={(e) => handleUpdateRole(u._id, e.target.value)}
                                                                                                                              
                                                                                                                                                                                                    disabled={u.email === 'a.bukhariev@krumbach.school'} // Protect Super Admin
                                                                                                                              
                                                                                                                                                                                                >
                                                                                                                              
                                                                                                                                                                                                    <MenuItem value="admin">Admin</MenuItem>
                                                                                                                              
                                                                                                                                                                                                    <MenuItem value="editor">Editor</MenuItem>
                                                                                                                              
                                                                                                                                                                                                    <MenuItem value="counter">Counter</MenuItem>
                                                                                                                              
                                                                                                                                                                                                    <MenuItem value="viewer">Viewer</MenuItem>
                                                                                                                              
                                                                                                                                                                                                </Select>
                                                                                                                              
                                                                                                                                                                                            </FormControl>
                                                                                                                              
                                                                                                                                                                                            <IconButton 
                                                                                                                              
                                                                                                                                                                                                color="error" 
                                                                                                                              
                                                                                                                                                                                                onClick={() => handleDeleteUser(u._id)}
                                                                                                                              
                                                                                                                                                                                                disabled={u.email === 'a.bukhariev@krumbach.school'}
                                                                                                                              
                                                                                                                                                                                            >
                                                                                                                              
                                                                                                                                                                                                <Icon>delete</Icon>
                                                                                                                              
                                                                                                                                                                                            </IconButton>
                                                                                                                              
                                                                                                                                                                                        </Box>
                                                                                                                              
                                                                                                                                                                                    </Box>
                                                                                                                              
                                                                                                                                                                                ))}
                                                                                                                              
                                                                                                                                                                            </Box>
                                                                                                                              
                                                                                                                                                                            <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                              
                                                                                                                                                                                <Button onClick={() => setIsRolesModalOpen(false)}>Close</Button>
                                                                                                                              
                                                                                                                                                                            </Box>
                                                                                                                              
                                                                                                                                                                        </Box>
                                                                                                                              
                                                                                                                                                                      </Modal>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                    <Modal open={isSettingsModalOpen} onClose={() => setIsSettingsModalOpen(false)}>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                      <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 400, bgcolor: 'background.paper', border: '2px solid #000', boxShadow: 24, p: 4 }}>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                          <Typography variant="h6" component="h2" sx={{mb: 2}}>System Settings</Typography>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                          <TextField
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              label="All Teachers Email Address"
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              value={allTeachersEmail}
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              onChange={(e) => setAllTeachersEmail(e.target.value)}
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              fullWidth
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              variant="outlined"
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              helperText="This email will be used for the 'All Teachers' recipient option."
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                          />
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                          <Box sx={{mt: 3, display: 'flex', justifyContent: 'flex-end'}}>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              <Button onClick={() => setIsSettingsModalOpen(false)} sx={{mr: 1}}>Cancel</Button>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              <Button 
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                  variant="contained" 
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                  onClick={() => {
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                      fetch(`${API_URL}/config`, {
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                          method: 'PUT',
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                          headers: { 'Content-Type': 'application/json' },
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                          body: JSON.stringify({ allTeachersEmail })
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                      })
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                      .then(res => {
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                          if(res.ok) setIsSettingsModalOpen(false);
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                          else alert('Failed to save settings');
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                      });
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                  }}
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              >
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                                  Save
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                              </Button>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                          </Box>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                      </Box>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                    </Modal>
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                      
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                  </>}
                                                                                                                              
                                                                                                                                          
                                                                                                                              
                                                                                                                                                                </Container>        </ThemeProvider>
      );
    }

    // ===================================================================================
    // ROOT COMPONENT
    // ===================================================================================
    function Root() {
      const [user, setUser] = React.useState(null);
      const [authError, setAuthError] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const userParam = urlParams.get('user');
        const errorParam = urlParams.get('error');

        if (userParam) {
          try {
            const userData = JSON.parse(decodeURIComponent(userParam));
            sessionStorage.setItem('user', JSON.stringify(userData));
            setUser(userData);
            // Clean up URL
            window.history.replaceState({}, document.title, "/");
          } catch (e) {
            console.error("Failed to parse user data from URL", e);
            setAuthError("Authentication failed. Please try again.");
          }
        } else if (errorParam) {
          setAuthError(errorParam);
        } else {
          const storedUser = sessionStorage.getItem('user');
          if (storedUser) {
            setUser(JSON.parse(storedUser));
          }
        }
        setLoading(false);
      }, []);

      const handleLogout = () => {
        sessionStorage.removeItem('user');
        setUser(null);
      };

      if (loading) {
        return <ThemeProvider theme={theme}><Container sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}><CircularProgress /></Container></ThemeProvider>;
      }

      return user ? <App user={user} onLogout={handleLogout} /> : <Login error={authError} />;
    }

    ReactDOM.render(<Root />, document.getElementById('root'));
  </script>
</body>
</html>
